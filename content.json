{"posts":[{"title":"æ ‡å‡†å¼åšå¼ˆ","text":"æ ‡å‡†å¼åšå¼ˆå¯¹äº$3$å…ƒç»„$\\Gamma=(I,S,\\pi)$ï¼Œ$\\Gamma$è¢«ç§°ä¸ºæ ‡å‡†å¼åšå¼ˆï¼ˆnormal form gameï¼‰ï¼Œå¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š è§„å®š$I$è¡¨ç¤ºï¼ˆåœ¨$\\Gamma$ä¸­ï¼‰ç©å®¶é›†åˆï¼Œ$I$æ˜¯å¯åˆ—çš„ è®°$S=\\bigg{S[i]\\bigg|i \\in I\\bigg}$ï¼Œè§„å®š$S[i]$è¡¨ç¤ºç©å®¶$i$ï¼ˆåœ¨$\\Gamma$ä¸­ï¼‰çš„ç­–ç•¥é›†åˆï¼Œ$S$è¡¨ç¤ºï¼ˆåœ¨$\\Gamma$ä¸­ï¼‰ç­–ç•¥ç©ºé—´ è®°$\\pi=\\bigg{\\pi[i]\\bigg|i \\in I\\bigg}$ï¼Œè§„å®š$\\pi[i]$è¡¨ç¤ºç©å®¶$i$ï¼ˆåœ¨$\\Gamma$ä¸­ï¼‰çš„æ”¶ç›Šå‡½æ•°ï¼Œ$\\pi$è¡¨ç¤ºï¼ˆåœ¨$\\Gamma$ä¸­ï¼‰æ”¶ç›Šå‡½æ•°ç»„åˆï¼Œå³æœ‰$$\\pi[i]:S \\to \\mathbb R$$ è¡¥å……è¯´æ˜ å¯¹äºæ ‡å‡†å¼åšå¼ˆ$\\Gamma=(I,S,\\pi)$ï¼Œä»¤$J$æ˜¯$I$çš„æŸä¸€å…¨æ’åºï¼Œè®°$S[J] = \\underset{j \\in J}\\times S[j]$ï¼Œ$\\pi[J] = \\underset{j \\in J}\\times \\pi[j]$ï¼Œå³æœ‰$$\\forall s \\in S, \\space \\piJ = \\underset{j \\in J}\\times \\pij \\in \\mathbb{R}^{|J|}$$ã€‚ç‰¹åˆ«çš„ï¼Œå¦‚æœ$I$æœ¬èº«æ˜¯æœ‰åºçš„ï¼Œé‚£ä¹ˆå¯é»˜è®¤$S=S[I]$å’Œ$\\pi=\\pi[I]$ã€‚ æœ‰é™æ ‡å‡†å¼åšå¼ˆå¯¹äºæ ‡å‡†å¼åšå¼ˆ$\\Gamma=(I,S,\\pi)$ï¼Œ$\\Gamma$è¢«ç§°ä¸ºæœ‰é™æ ‡å‡†å¼åšå¼ˆï¼ˆfinite normal form gameï¼‰æˆ–è€…æ˜¯æœ‰é™çš„ï¼Œå¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š $0&lt;|I|&lt;\\infty$ $\\forall i \\in I,\\space 0&lt;|S[i]|&lt;\\infty$ æ‰©å±•åšå¼ˆå¯¹äºæ ‡å‡†å¼åšå¼ˆ$\\Gamma=(I,S,\\pi)$ï¼Œæ ‡å‡†å¼åšå¼ˆ$\\mathrm{H}=(I,\\Delta,u)$è¢«ç§°ä¸º$\\Gamma$çš„ï¼ˆæ··åˆç­–ç•¥ï¼‰æ‰©å±•åšå¼ˆï¼ˆextensive gameï¼‰ï¼Œå¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š $\\Gamma$å’Œ$\\mathrm{H}$çš„ç©å®¶é›†åˆéƒ½æ˜¯$I$ è®°$\\Delta=\\bigg{\\Delta[i]\\bigg|i \\in I\\bigg}$ï¼Œè§„å®š$\\Delta[i]$è¡¨ç¤ºç©å®¶$i$ï¼ˆåœ¨$\\mathrm{H}$ä¸­ï¼‰çš„ç­–ç•¥é›†åˆï¼Œ$\\Delta$è¡¨ç¤ºï¼ˆåœ¨$\\mathrm{H}$ä¸­ï¼‰ç­–ç•¥ç©ºé—´ï¼Œå³æœ‰$$\\Delta[i] = \\bigg{x[i]\\in\\mathbb{R}+^{|S[i]|}\\bigg|\\sum{k \\in S[i]} x[i,k]=1\\bigg}$$ è®°$u=\\bigg{u[i]\\bigg|i \\in I\\bigg}$ï¼Œè§„å®š$u[i]$è¡¨ç¤ºç©å®¶$i$ï¼ˆåœ¨$\\mathrm{H}$ä¸­ï¼‰çš„æ”¶ç›Šå‡½æ•°ï¼Œ$u$è¡¨ç¤ºï¼ˆåœ¨$\\mathrm{H}$ä¸­ï¼‰æ”¶ç›Šå‡½æ•°ç»„åˆï¼Œå³æœ‰$$u[i]:\\Delta \\to \\mathbb R$$ï¼›å¯¹äº$s \\in S$å’Œ$x \\in \\Delta$ï¼Œè®°$x(s)=\\displaystyle\\prod_{i \\in I}x[i,s[i]]$ï¼Œåˆ™æœ‰ $$ui=\\sum_{s \\in S} x(s)\\cdot\\pii$$ è¡¥å……è¯´æ˜ å¯¹äºæ ‡å‡†å¼åšå¼ˆ$\\Gamma=(I,S,\\pi)$åŠå…¶æ‰©å±•åšå¼ˆ$\\mathrm{H}=(I,\\Delta,u)$ï¼Œä¸ºç®€ä¾¿èµ·è§ï¼Œå‡å®š$I$æ˜¯æœ‰åºçš„ã€‚å¯¹äº$\\forall i \\in I, \\forall x \\in \\Delta$ï¼Œ$x[i]$å¯è¢«è®¤ä¸ºæ˜¯$i$åœ¨$S[i]$ä¸Šçš„é¢‘ç‡åˆ†å¸ƒç­–ç•¥ï¼Œå³å¯å®šä¹‰æ··åˆç­–ç•¥ä¸ºçº¿æ€§ç»„åˆ$x[i] \\cdot S[i]$ï¼Œè€Œ$\\Delta[i] \\subset [0{:}1]^{|S[i]|}$æ˜¯$i$çš„æ‰€æœ‰å¯é€‰çš„çº¿æ€§ç»„åˆï¼Œå¦‚æ­¤å¯è®°$\\Theta[i]$ä½œä¸º$S[i]$çš„å‡¸åŒ…ï¼Œå³æœ‰$$\\Theta[i] = \\bigg{\\delta\\cdot S[i]\\bigg|\\delta \\in \\Delta[i]\\bigg}=\\mathrm{co}(S[i])$$ï¼Œç»§è€Œæœ‰$S$çš„å‡¸åŒ…$$\\Theta = \\underset{i \\in I}\\times \\Theta[i]=\\mathrm{co}(S)$$ã€‚ç”±æ­¤å¯è§ï¼Œ$\\Delta[i]$å’Œ$\\Theta[i]$æ˜¯åŒæ„çš„ï¼Œ$\\Delta[i]$å¯ä»¥è¢«è§†ä¸ºåœ¨$\\mathbb{R}^{|S[i]|}$ä¸Šçš„ä¸€ä¸ªæ ‡å‡†çš„å•ä½æ­£äº¤åŸºçš„å‡¸åŒ…ï¼Œä¸”å½“$|S[i]|&lt;\\infty$æ—¶ï¼Œ$\\Delta[i]$æ˜¯åœ¨$\\mathbb{R}^{|S[i]|}$ä¸­çš„ä¸€ä¸ª$|S[i]|-1$ç»´å•çº¯å½¢ã€‚å› è€Œï¼Œ$\\Delta$å’Œ$\\Theta$æ˜¯åŒæ„çš„ï¼Œå¦‚æœ$\\Gamma$æ˜¯æœ‰é™çš„ï¼Œé‚£ä¹ˆ$\\Delta = \\underset{i \\in I}\\times \\Delta[i] \\subset \\underset{i \\in I}\\times [0{:}1]^{|S[i]|}$æ˜¯$\\mathbb{R}^{\\prod_{i \\in I} |S[i]|}$ä¸­çš„ä¸€ä¸ªå‡¸å¤šé¢ä½“ã€‚ å ä¼˜ç­–ç•¥å¯¹äºæ ‡å‡†å¼åšå¼ˆ$\\Gamma=(I,S,\\pi)$ï¼Œå¯¹äº$i \\in I$å’Œ$x \\in S$ï¼Œè®°$\\mathscr{x}[-i]$æ˜¯$x$å»é™¤$x[i]$åå‰©ä½™çš„ç»„åˆï¼Œå¯ä»¥å®šä¹‰ä¸‹é¢è¿™äº›æ¦‚å¿µï¼š ç§°$x[i] \\in S[i]$å¼±å ä¼˜äº$y[i] \\in S[i]$ï¼Œè®°ä½œ$x[i] \\succcurlyeq y[i]$ï¼Œå¦‚æœæ»¡è¶³ï¼š $\\forall z \\in S,\\space \\pii\\ge\\pii$ $\\exists z \\in S,\\space\\pii&gt;\\pii$ ç§°$x[i] \\in S[i]$ä¸¥æ ¼å ä¼˜äº$y[i] \\in S[i]$ï¼Œè®°ä½œ$x[i] \\succ y[i]$ï¼Œå¦‚æœæ»¡è¶³ï¼š $\\forall z \\in S,\\space x[i] \\ne y[i] \\implies \\pii&gt;\\pii$ ç§°$x[i] \\in S[i]$æ˜¯$i$çš„å¼±å ä¼˜ç­–ç•¥ï¼Œå¦‚æœæ»¡è¶³ï¼š $\\forall z \\in S,\\space \\forall y[i] \\in S[i],\\space x[i] \\ne y[i] \\implies x[i] \\succcurlyeq y[i]$ ç§°$x[i] \\in S[i]$æ˜¯$i$çš„ä¸¥æ ¼å ä¼˜ç­–ç•¥ï¼Œå¦‚æœæ»¡è¶³ï¼š $\\forall z \\in S,\\space \\forall y[i] \\in S[i],\\space x[i] \\ne y[i] \\implies x[i] \\succ y[i]$ æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚","link":"/2019/04/28/1.%E6%A0%87%E5%87%86%E5%BC%8F%E5%8D%9A%E5%BC%88/"},{"title":"Pythonè„šæœ¬ä½œä¸ºé…ç½®æ–‡ä»¶åŠ è½½","text":"èƒŒæ™¯åœ¨ä½¿ç”¨ Python å¼€å‘æ—¶ï¼Œå¦‚æœè¦æŠŠå¯¹è±¡ obj å½“ä½œå­—å…¸ä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥æ“ä½œ obj.__dict__ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œå…·ä½“è€Œè¨€ï¼š å¯¹è±¡æ“ä½œ å­—å…¸æ“ä½œ æŸ¥ obj.foo obj.__dict__[&quot;foo&quot;] æ”¹ obj.foo = &quot;bar&quot; obj.__dict__[&quot;foo&quot;] = &quot;bar&quot; åˆ  del obj.foo del obj.__dict__[&quot;foo&quot;] å¯¹è±¡æ“ä½œå’Œå­—å…¸ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯å¯¹è±¡çš„å‘½åç©ºé—´ï¼‰æ“ä½œå¹¶ä¸ç­‰ä»·ï¼Œå­—å…¸æ“ä½œå¹¶ä¸æ‰§è¡Œå¤æ‚çš„æ–¹æ³•æŸ¥æ‰¾å’Œæè¿°ç¬¦ï¼Œæ­¥éª¤æ›´å°‘ï¼Œä¸€èˆ¬è€Œè¨€æ›´å¿«ã€‚ è€Œè¦æŠŠå­—å…¸ d è§†ä¸ºå¯¹è±¡æ“ä½œï¼Œåˆ™è¦ä¸“é—¨åŒ…è£…ä¸€ä¸‹ 123456789 class DictAsObject: def __init__(self, d): self.__dict__ = d def __repr__(self): return f&quot;{type(self).__qualname__}({self.__dict__!r})&quot;dict_as_obj = DictAsObject ä¹Ÿå¯ä»¥ç›´æ¥ç”¨æ ‡å‡†åº“ä¸­çš„åŒ…è£…ï¼Œä¾‹å¦‚ 123456from argparse import Namespacedef dict_as_obj(d): ns = Namespace() ns.__dict__ = d return ns ä»¤ ns = dict_as_obj(d)ï¼Œå…·ä½“è€Œè¨€ï¼š å¯¹è±¡æ“ä½œ å­—å…¸æ“ä½œ æŸ¥ ns.foo d[&quot;foo&quot;] æ”¹ ns.foo = &quot;bar&quot; d[&quot;foo&quot;] = &quot;bar&quot; åˆ  del ns.foo del d[&quot;foo&quot;] æ›´ä¸€èˆ¬åœ°è¯´ï¼Œå°±æ˜¯è¦æŠŠä¸‹åˆ—æ“ä½œå»ºç«‹å¯¹åº” å¯¹è±¡æ“ä½œ å­—å…¸æ“ä½œ æŸ¥ __getattr__ __getitem__ æ”¹ __setattr__ __setitem__ åˆ  __delattr__ __delitem__ æœ‰äº›ä¸åŒçš„æ˜¯ï¼Œåœ¨æŠ›å¼‚å¸¸æ—¶ï¼Œå¯¹è±¡æ“ä½œæŠ›å‡º AttributeErrorï¼Œå­—å…¸æ“ä½œæŠ›å‡º KeyErrorã€‚ æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹æ¨¡å—å®ç°äº†ä¸Šè¿°å¯¹åº”å…³ç³»çš„å¯ç›¸äº’æ›¿ä»£ï¼Œä¾‹å¦‚ https://pypi.org/project/attrdict/ https://pypi.org/search/?q=attrdict https://github.com/mewwts/addict https://github.com/sanand0/orderedattrdict æˆ‘æœ‰ä¸€ä¸ªç°å®çš„éœ€æ±‚ï¼Œå¸Œæœ›èƒ½ç›´æ¥ä»¥ Python è„šæœ¬ä½œä¸ºé…ç½®æ–‡ä»¶ï¼šè¯»å–ä¸€ä¸ªè„šæœ¬ï¼Œå¹¶ä»¥ exec å‡½æ•°è¿è¡Œä¹‹ï¼Œç„¶åæŠŠè„šæœ¬è¿è¡Œæ—¶çš„å…¨å±€å‘½åç©ºé—´ä½œä¸ºé…ç½®ï¼Œå¦‚æœé‡Œé¢ç”¨åˆ°äº†ä¸å­˜åœ¨çš„åå­—ï¼Œåº”è¯¥è‡ªåŠ¨æŠŠå®ƒè®¾ä¸ºç©ºå­—å…¸ {}ã€‚æ“ä½œç­–ç•¥å€Ÿé‰´äº† addictï¼Œæ“ä½œå¦‚ä¸‹ 12345&gt;&gt;&gt; from addict import Dict&gt;&gt;&gt; mapping = Dict()&gt;&gt;&gt; mapping.a.b.c.d.e = 2&gt;&gt;&gt; mapping{'a': {'b': {'c': {'d': {'e': 2}}}}} ä¸ºæ­¤ï¼Œæˆ‘ä¸“é—¨å†™äº†ä¸€ä¸ªæ¨¡å—ï¼Œæ¥é€‚é…æˆ‘çš„éœ€æ±‚ï¼Œé€ è½®å­å¹¶éæ²¡æœ‰æ„ä¹‰ï¼Œå®ƒèƒ½åŠ æ·±æˆ‘çš„æ€è€ƒï¼Œå¹¶ä¸”äº«å— DIY çš„å¿«ä¹ã€‚ ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/aca220b5927d9e7d3044d6f1d31baaf6 æ–‡ä»¶åç§°æ˜¯ dictattr.pyï¼ŒPython å®ç°ä»£ç å¦‚ä¸‹ï¼š dictattr123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178#!/usr/bin/env python3# coding: utf-8__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1, 1)__all__ = [&quot;AttrDict&quot;, &quot;DictAttr&quot;, &quot;Properties&quot;]import builtinsfrom pathlib import Pathfrom types import CodeTypefrom typing import MutableMapping, Optional, Unionclass AttrDict(dict): &quot;æ‰©å±•çš„ dict ç±»å‹ï¼Œå®ƒçš„å®ä¾‹çš„ __dict__ å±æ€§ï¼ˆå‘½åç©ºé—´ï¼‰å°±æ˜¯è¯¥å­—å…¸æœ¬èº«ï¼Œå› æ­¤æ‰§è¡Œ __getattr__ã€__setattr__ã€__delattr__ æ“ä½œçš„æ˜¯è¯¥å­—å…¸æœ¬èº«&quot; def __init__(self, *args, **kwds): super().__init__(*args, **kwds) self.__dict__ = self@MutableMapping.registerclass DictAttr: &quot;&quot;&quot;è¿™ä¸ªç±»å‹å®ç°äº† collections.abc.MutableMapping çš„æ¥å£ï¼Œä½œä¸ºå…¶ç»“æ„å­ç±»å‹(structural subtyping)ï¼Œå³é¸­å­ç±»å‹(duck typing)ï¼Œè€Œéåä¹‰å­ç±»å‹(nominal subtyping)ã€‚ :param init_dict: å¦‚æœä¸ä¸º Noneï¼Œä¼šç”¨äºæ›¿æ¢å®ä¾‹çš„ __dict__ å±æ€§ :: doctest &gt;&gt;&gt; d = dict(foo={}) &gt;&gt;&gt; da = DictAttr(d) &gt;&gt;&gt; da DictAttr({'foo': {}}) &gt;&gt;&gt; da.foo DictAttr({}) &gt;&gt;&gt; da.foo.bar = 1 &gt;&gt;&gt; da DictAttr({'foo': {'bar': 1}}) &gt;&gt;&gt; d {'foo': {'bar': 1}} &gt;&gt;&gt; da.__dict__ is d True &quot;&quot;&quot; def __init__(self, init_dict: Optional[dict] = None): if init_dict is not None: self.__dict__ = init_dict def __contains__(self, key): return key in self.__dict__ def __iter__(self): return iter(self.__dict__) def __len__(self): return len(self.__dict__) def __repr__(self): return f&quot;{type(self).__qualname__}({self.__dict__!r})&quot; def __getattribute__(self, attr): &quot;å¦‚æœ attr æ˜¯å­—ç¬¦ä¸²ä¸”å‰åéƒ½é™„ç¼€ä¸¤ä¸ªä¸‹åˆ’çº¿ __ï¼Œåˆ™æ‰§è¡ŒåŸå§‹è¡Œä¸ºã€‚å¦åˆ™è¡Œä¸ºç›¸å½“äº __getitem__ï¼Œä½†åœ¨å–ä¸åˆ°å€¼æ—¶ï¼Œä¼šå†æ‰§è¡ŒåŸå§‹è¡Œä¸ºã€‚å¯èƒ½æŠ›å‡º Attribute Error å¼‚å¸¸ã€‚&quot; if type(attr) is str and attr[:2] == attr[-2:] == &quot;__&quot;: return super().__getattribute__(attr) try: return self[attr] except KeyError: return super().__getattribute__(attr) def __getitem__(self, key): &quot;ä» __dict__ ä¸­å–å€¼ï¼Œå½“å€¼æ˜¯ dict ç±»å‹æ—¶ï¼Œä¼šè¢« type(self) å¯¹åº”çš„ç±»åŒ…è£…&quot; val = self.__dict__[key] if type(val) is dict: return type(self)(val) return val def __setitem__(self, key, val): &quot;å‘ __dict__ ä¸­è®¾é”®å€¼&quot; self.__dict__[key] = val def __delitem__(self, key): &quot;ä» __dict__ ä¸­åˆ é”®&quot; del self.__dict__[key]class Properties(DictAttr): &quot;&quot;&quot;è¿™ä¸ªç±»å‹å®ç°äº† collections.abc.MutableMapping çš„æ¥å£ï¼Œä½œä¸ºå…¶ç»“æ„å­ç±»å‹(structural subtyping)ï¼Œå³é¸­å­ç±»å‹(duck typing)ï¼Œè€Œéåä¹‰å­ç±»å‹(nominal subtyping)ã€‚ :param init_dict: å¦‚æœä¸ä¸º Noneï¼Œä¼šç”¨äºæ›¿æ¢å®ä¾‹çš„ __dict__ å±æ€§ :: doctest &gt;&gt;&gt; d = dict(foo={}) &gt;&gt;&gt; props = Properties(d) &gt;&gt;&gt; props Properties({'foo': {}}) &gt;&gt;&gt; props.foo Properties({}) &gt;&gt;&gt; props.foo.bar = 1 &gt;&gt;&gt; props Properties({'foo': {'bar': 1}}) &gt;&gt;&gt; props.bar Properties({}) &gt;&gt;&gt; props Properties({'foo': {'bar': 1}, 'bar': {}}) &gt;&gt;&gt; props.baz.bay.baz = 1 &gt;&gt;&gt; props Properties({'foo': {'bar': 1}, 'bar': {}, 'baz': {'bay': {'baz': 1}}}) &gt;&gt;&gt; d {'foo': {'bar': 1}, 'bar': {}, 'baz': {'bay': {'baz': 1}}} &gt;&gt;&gt; props.__dict__ is d True &quot;&quot;&quot; def __getitem__(self, key): &quot;ä» __dict__ ä¸­å–å€¼ã€‚é¦–å…ˆæ‰§è¡ŒåŸºç±» DictAttr çš„åŸå§‹è¡Œä¸ºï¼›å¦‚æœå–ä¸åˆ°å€¼ï¼Œå†ä» builtins.__dict__ ä¸­å–å€¼ï¼›å¦‚æœå–ä¸åˆ°ï¼Œåˆ™å¯¹äºéä¸‹åˆ’çº¿å‰ç¼€çš„å­—ç¬¦ä¸²å±æ€§ï¼ŒæŠŠå€¼è®¾ä¸º {}ï¼Œå†æ‰§è¡Œä¸€æ¬¡åŸºç±»çš„åŸå§‹è¡Œä¸ºï¼Œå¦åˆ™æŠ›å‡º KeyErrorã€‚&quot; try: return super().__getitem__(key) except KeyError: try: return builtins.__dict__[key] except KeyError: pass if type(key) is not str or key.startswith(&quot;_&quot;): raise self[key] = {} return super().__getitem__(key) def __abs__(self) -&gt; dict: &quot;åˆ›å»ºä¸€ä¸ª dict å‰¯æœ¬ï¼Œå¦‚æœæœ‰ __all__ å­—æ®µï¼Œåˆ™ç­›é€‰å‡ºæ‰€æœ‰åœ¨ __all__ ä¸­çš„é”®ï¼Œå¦åˆ™åªç­›é€‰å‡ºé”®æ˜¯å­—ç¬¦ä¸²ç±»å‹ä¸”éä¸‹åˆ’çº¿å‰ç¼€çš„é”®å€¼å¯¹&quot; d = self.__dict__ if &quot;__all__&quot; in d: return { k: abs(v) if isinstance(v, Properties) else v for k, v in ((k, d[k]) for k in d[&quot;__all__&quot;] if k in d) } return { k: abs(v) if isinstance(v, Properties) else v for k, v in d.items() if type(k) is str and not k.startswith(&quot;_&quot;) } def __call__(self, source: Union[str, bytes, CodeType, Path]): &quot;&quot;&quot;æ‰§è¡Œä¸€æ®µ Python ä»£ç ï¼Œå¹¶æ›´æ–° __dict__ å±æ€§ï¼ˆå‘½åç©ºé—´ï¼‰ :param source: Python ä»£ç æˆ–è€…ä»£ç æ–‡ä»¶çš„è·¯å¾„ :return: è¿”å›å®ä¾‹æœ¬èº« :: tips - è¯·å°†å˜é‡åæå‰æ³¨å…¥ __dict__ï¼Œå¦åˆ™ç¼ºå¤±æ—¶è‡ªåŠ¨è®¾ä¸º {} - å¦‚æœä»£ç ä¸­æœ‰ import å‘½ä»¤ï¼Œè¯·ç¡®ä¿æŠŠéœ€è¦çš„è·¯å¾„åŠ åˆ° sys.path ä¸­ï¼Œé¿å…æ‰¾ä¸åˆ°æ¨¡å— - å±æ€§åæœ‰å‰ç¼€ä¸‹åˆ’çº¿ _ï¼Œç”¨äºè¯´æ˜æƒ³è¦è¿‡æ»¤æ‰ :: doctest &gt;&gt;&gt; # æ„é€ ä¸€æ®µ Python ä»£ç  &gt;&gt;&gt; code = 'from math import nan as _nan, inf as _inf\\\\nz = _inf\\\\ny.z = _nan\\\\nx.y.z = y.z\\\\nfoo = sum([1,2, 3])\\\\nbar = abs(1+1j)' &gt;&gt;&gt; print(code) from math import nan as _nan, inf as _inf z = _inf y.z = _nan x.y.z = y.z foo = sum([1,2, 3]) bar = abs(1+1j) &gt;&gt;&gt; props = Properties() &gt;&gt;&gt; props Properties({}) &gt;&gt;&gt; props(code) Properties({'_nan': nan, '_inf': inf, 'z': inf, 'y': {'z': nan}, 'x': {'y': {'z': nan}}, 'foo': 6, 'bar': 1.4142135623730951}) &gt;&gt;&gt; print(abs(props)) {'z': inf, 'y': {'z': nan}, 'x': {'y': {'z': nan}}, 'foo': 6, 'bar': 1.4142135623730951} &quot;&quot;&quot; code: Union[str, bytes, CodeType] if isinstance(source, Path): code = source.open(encoding=&quot;utf_8&quot;).read() else: code = source exec(code, None, self) # type: ignore return selfif __name__ == &quot;__main__&quot;: import doctest doctest.testmod(verbose=True) ä½¿ç”¨è¯´æ˜ä»£ç ä¸­æœ‰æ–‡æ¡£æµ‹è¯• doctestï¼Œä¸å¦¨è¿è¡Œä¸€ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148$ python dictattr.pyTrying: d = dict(foo={})Expecting nothingokTrying: da = DictAttr(d)Expecting nothingokTrying: daExpecting: DictAttr({'foo': {}})okTrying: da.fooExpecting: DictAttr({})okTrying: da.foo.bar = 1Expecting nothingokTrying: daExpecting: DictAttr({'foo': {'bar': 1}})okTrying: dExpecting: {'foo': {'bar': 1}}okTrying: da.__dict__ is dExpecting: TrueokTrying: d = dict(foo={})Expecting nothingokTrying: props = Properties(d)Expecting nothingokTrying: propsExpecting: Properties({'foo': {}})okTrying: props.fooExpecting: Properties({})okTrying: props.foo.bar = 1Expecting nothingokTrying: propsExpecting: Properties({'foo': {'bar': 1}})okTrying: props.barExpecting: Properties({})okTrying: propsExpecting: Properties({'foo': {'bar': 1}, 'bar': {}})okTrying: props.baz.bay.baz = 1Expecting nothingokTrying: propsExpecting: Properties({'foo': {'bar': 1}, 'bar': {}, 'baz': {'bay': {'baz': 1}}})okTrying: dExpecting: {'foo': {'bar': 1}, 'bar': {}, 'baz': {'bay': {'baz': 1}}}okTrying: props.__dict__ is dExpecting: TrueokTrying: code = 'from math import nan as _nan, inf as _inf\\nz = _inf\\ny.z = _nan\\nx.y.z = y.z\\nfoo = sum([1,2, 3])\\nbar = abs(1+1j)'Expecting nothingokTrying: print(code)Expecting: from math import nan as _nan, inf as _inf z = _inf y.z = _nan x.y.z = y.z foo = sum([1,2, 3]) bar = abs(1+1j)okTrying: props = Properties()Expecting nothingokTrying: propsExpecting: Properties({})okTrying: props(code)Expecting: Properties({'_nan': nan, '_inf': inf, 'z': inf, 'y': {'z': nan}, 'x': {'y': {'z': nan}}, 'foo': 6, 'bar': 1.4142135623730951})okTrying: print(abs(props))Expecting: {'z': inf, 'y': {'z': nan}, 'x': {'y': {'z': nan}}, 'foo': 6, 'bar': 1.4142135623730951}ok14 items had no tests: __main__ __main__.AttrDict __main__.AttrDict.__init__ __main__.DictAttr.__contains__ __main__.DictAttr.__delitem__ __main__.DictAttr.__getattribute__ __main__.DictAttr.__getitem__ __main__.DictAttr.__init__ __main__.DictAttr.__iter__ __main__.DictAttr.__len__ __main__.DictAttr.__repr__ __main__.DictAttr.__setitem__ __main__.Properties.__abs__ __main__.Properties.__getitem__3 items passed all tests: 8 tests in __main__.DictAttr 12 tests in __main__.Properties 6 tests in __main__.Properties.__call__26 tests in 17 items.26 passed and 0 failed. å‡è®¾ç°åœ¨æœ‰ä¸ª Python è„šæœ¬ config.py ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ config.py123456789101112131415161718192021222324252627282930313233343536373839404142## ä»¥ä¸‹æ˜¯æ•°æ®åº“è¿æ¥ä¿¡æ¯# æ•°æ®åº“è¿æ¥å‡½æ•°db.connect = __import__(&quot;sqlite3&quot;).connect# ä¸»æœºdb.host = None# ç«¯å£db.port = None# ç”¨æˆ·ådb.username = None# å¯†ç db.password = None# æ•°æ®åº“db.database = &quot;:memory:&quot;## ä¸‹é¢æ˜¯æ—¥å¿—çš„ç›¸å…³é…ç½® # æ—¥å¿—è¾“å‡ºçš„æœ€ä½çº§åˆ«log.level=__import__(&quot;logging&quot;).INFO# æ—¥å¿—çš„è¾“å‡ºæ ¼å¼log.format=&quot;[\\x1b[1m%(asctime)-15s\\x1b[0m] \\x1b[36;1m%(name)s\\x1b[0m(\\x1b[31;1m%(levelname)s\\x1b[0m) âœ %(message)s&quot;## json çš„ç›¸å…³é…ç½®# json åºåˆ—åŒ–å‡½æ•°json.serialize = __import__(&quot;json&quot;).dumps# json ååºåˆ—åŒ–å‡½æ•°json.deserialize = __import__(&quot;json&quot;).loads## ä¸€äº›éœ€è¦çš„ 64 ä½æµ®ç‚¹æ•°å¸¸é‡from math import nan as _nan, inf as _infNumber.SQRT_2 = abs(1+1j)Number.EPSILON = 2.0 ** -52Number.MIN_VALUE = 2.0 ** -1074Number.MAX_VALUE = sum(2.0 ** (1023 - i) for i in range(53))Number.MAX_SAFE_INTEGER = 2.0 ** 53 - 1Number.MIN_SAFE_INTEGER = -Number.MAX_SAFE_INTEGERNumber.NaN = _nanNumber.POSITIVE_INFINITY = _infNumber.NEGATIVE_INFINITY = -_inf å¯ä»¥è¿è¡Œä¸‹é¢ä»£ç è¿›è¡ŒåŠ è½½ 1234567&gt;&gt;&gt; from dictattr import Properties&gt;&gt;&gt; props = Properties()&gt;&gt;&gt; from pathlib import Path&gt;&gt;&gt; props(Path(&quot;config.py&quot;))Properties({'db': {'connect': &lt;built-in function connect&gt;, 'host': None, 'port': None, 'username': None, 'password': None, 'database': ':memory:'}, 'log': {'level': 20, 'format': '[\\x1b[1m%(asctime)-15s\\x1b[0m] \\x1b[36;1m%(name)s\\x1b[0m(\\x1b[31;1m%(levelname)s\\x1b[0m) âœ %(message)s'}, 'json': {'serialize': &lt;function dumps at 0x7f29156d9c10&gt;, 'deserialize': &lt;function loads at 0x7f29156d9dc0&gt;}, '_nan': nan, '_inf': inf, 'Number': {'SQRT_2': 1.4142135623730951, 'EPSILON': 2.220446049250313e-16, 'MIN_VALUE': 5e-324, 'MAX_VALUE': 1.7976931348623157e+308, 'MAX_SAFE_INTEGER': 9007199254740991.0, 'MIN_SAFE_INTEGER': -9007199254740991.0, 'NaN': nan, 'POSITIVE_INFINITY': inf, 'NEGATIVE_INFINITY': -inf}})&gt;&gt;&gt; print(abs(props)){'db': {'connect': &lt;built-in function connect&gt;, 'host': None, 'port': None, 'username': None, 'password': None, 'database': ':memory:'}, 'log': {'level': 20, 'format': '[\\x1b[1m%(asctime)-15s\\x1b[0m] \\x1b[36;1m%(name)s\\x1b[0m(\\x1b[31;1m%(levelname)s\\x1b[0m) âœ %(message)s'}, 'json': {'serialize': &lt;function dumps at 0x7f29156d9c10&gt;, 'deserialize': &lt;function loads at 0x7f29156d9dc0&gt;}, 'Number': {'SQRT_2': 1.4142135623730951, 'EPSILON': 2.220446049250313e-16, 'MIN_VALUE': 5e-324, 'MAX_VALUE': 1.7976931348623157e+308, 'MAX_SAFE_INTEGER': 9007199254740991.0, 'MIN_SAFE_INTEGER': -9007199254740991.0, 'NaN': nan, 'POSITIVE_INFINITY': inf, 'NEGATIVE_INFINITY': -inf}} ç„¶åå°±å¯ä»¥æ ¹æ®éœ€è¦å–ç”¨å±æ€§äº† 12345678&gt;&gt;&gt; props.NumberProperties({'SQRT_2': 1.4142135623730951, 'EPSILON': 2.220446049250313e-16, 'MIN_VALUE': 5e-324, 'MAX_VALUE': 1.7976931348623157e+308, 'MAX_SAFE_INTEGER': 9007199254740991.0, 'MIN_SAFE_INTEGER': -9007199254740991.0, 'NaN': nan, 'POSITIVE_INFINITY': inf, 'NEGATIVE_INFINITY': -inf})&gt;&gt;&gt; props[&quot;Number&quot;].SQRT_21.4142135623730951&gt;&gt;&gt; props.dbProperties({'connect': &lt;built-in function connect&gt;, 'host': None, 'port': None, 'username': None, 'password': None, 'database': ':memory:'})&gt;&gt;&gt; props[&quot;json&quot;]Properties({'serialize': &lt;function dumps at 0x76829bcf70&gt;, 'deserialize': &lt;function loads at 0x76829bd480&gt;})","link":"/2022/08/27/10.Python%E8%84%9A%E6%9C%AC%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD/"},{"title":"Pythonè„šæœ¬è®¾ç½®pipç´¢å¼•æº","text":"èƒŒæ™¯Python åŒ…ç´¢å¼•ï¼ˆPython Package Indexï¼ŒPyPIï¼‰æ˜¯ç”±å…¨çƒ Python å¼€å‘äººå‘˜ç¤¾åŒºæä¾›çš„å¤§é‡å¼€æº Python åŒ…çš„å­˜å‚¨åº“ã€‚å®˜æ–¹ç´¢å¼•åœ¨ https://pypi.orgï¼Œç½‘ç«™æœ¬èº«ç”± Python è½¯ä»¶åŸºé‡‘ä¼šï¼ˆPython Software Foundationï¼ŒPSFï¼‰ç»´æŠ¤ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ä¸Šé¢å‘å¸ƒè‡ªå·±çš„é¡¹ç›®ï¼Œå¯å‚è€ƒ A Beginnerâ€™s Guide to Publishing Packages on the Python Package Index (PyPi)ï¼ŒHow to Publish an Open-Source Python Package to PyPIã€‚ Python ä½¿ç”¨ pip å®‰è£…ç¬¬ä¸‰æ–¹åŒ…æ—¶ï¼Œé»˜è®¤ä½¿ç”¨çš„å®˜æ–¹ç´¢å¼•æº pypi çš„åœ°å€ https://pypi.python.org/pypi åœ¨ä¸­å›½å¤§é™†å› ä¸ºå¢™çš„åŸå› ï¼Œä¸‹è½½ç¼“æ…¢ã€‚è·Ÿ ubuntu çš„ apt å’Œ archlinux çš„ Pacman æœ‰å„è‡ªå›½å†…é•œåƒæºä¸€æ ·ï¼Œpip ä¹Ÿæœ‰å›½å†…ç´¢å¼•æºå¯ç”¨ï¼Œä¸‹é¢ç½—åˆ—äº†ä¸€éƒ¨åˆ†ï¼Œè¿›ä¸€æ­¥çš„ï¼Œä¸ºäº†ä¾¿äºè®¾ç½®å›½å†…æºï¼Œå¹¶å—åˆ° nodejs çš„ nrm çš„å¯å‘ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªè„šæœ¬ã€‚ key index-url trusted-url æä¾›è€… douban http://pypi.douban.com/simple/ pypi.douban.com è±†ç“£ aliyun http://mirrors.aliyun.com/pypi/simple/ mirrors.aliyun.com é˜¿é‡Œäº‘ tsinghua https://pypi.tuna.tsinghua.edu.cn/simple/ pypi.tuna.tsinghua.edu.cn æ¸…åå¤§å­¦ ustc https://pypi.mirrors.ustc.edu.cn/simple/ pypi.mirrors.ustc.edu.cn ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦ hustunique http://pypi.hustunique.com/simple/ pypi.hustunique.com åä¸­ç†å·¥å¤§å­¦ sdutlinux http://pypi.sdutlinux.org/simple/ pypi.sdutlinux.org å±±ä¸œç†å·¥å¤§å­¦ tencent http://mirrors.cloud.tencent.com/pypi/simple/ mirrors.cloud.tencent.com è…¾è®¯äº‘ ä»¥è±†ç“£æºä¸ºä¾‹ï¼Œå‡è®¾è¦å®‰è£… pandas å¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ 1pip install -i http://pypi.douban.com/simple/ --trusted-host=pypi.douban.com/simple pandas å¦‚æœå†™åˆ°é…ç½®æ–‡ä»¶ï¼Œä¾¿å¯ä¸ç”¨æ¯æ¬¡æŒ‡å®š -i å‚æ•° 12pip config set global.index-url http://pypi.douban.com/simple/pip config set global.trusted-host pypi.douban.com æ‰€æœ‰çš„ pip é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤è·å– 1python -c &quot;from pip._internal.configuration import get_configuration_files;print(get_configuration_files())&quot; ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/61d5e6eeb149a38291128fcd35befffc æ–‡ä»¶åç§°æ˜¯ pip_index.pyï¼ŒPython å®ç°ä»£ç å¦‚ä¸‹ï¼š pip_index.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156#!/usr/bin/env python3# coding: utf-8&quot;&quot;&quot;\\Tool for setting the index-url of pipReference: - https://pip.pypa.io/en/latest/- https://docs.python.org/3/installing/index.html- https://docs.python.org/3/library/ensurepip.html&quot;&quot;&quot;assert __name__ == &quot;__main__&quot;, &quot;Can only be used as __main__ module&quot;__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1)from argparse import ArgumentParser, RawTextHelpFormatterparser = ArgumentParser( description=&quot;Python pip æºé…ç½®å·¥å…·&quot;, formatter_class=RawTextHelpFormatter, )subparsers = parser.add_subparsers(dest=&quot;command&quot;, help=&quot;Available commands&quot;)parser_list = subparsers.add_parser( &quot;list&quot;, formatter_class=RawTextHelpFormatter, help=&quot;ç½—åˆ—æ‰€æœ‰å¯ç”¨çš„æº&quot;, description=&quot;&quot;&quot;ç½—åˆ—æ‰€æœ‰å¯ç”¨çš„æºï¼Œæ ¼å¼å½¢å¦‚{key}: index-url: {index_url!r} trusted-host: {trusted_host!r} comment: {comment!r}&quot;&quot;&quot;)parser_use = subparsers.add_parser( &quot;use&quot;, formatter_class=RawTextHelpFormatter, help=&quot;ä½¿ç”¨ key æŒ‡å®šè¦è®¾ç½®çš„æº&quot;, description=&quot;ä½¿ç”¨ key æŒ‡å®šè¦è®¾ç½®çš„æº&quot;)parser_use.add_argument( &quot;key&quot;, default=&quot;pypi&quot;, nargs=&quot;?&quot;, help=&quot;keyï¼Œå¯¹åº”æŸä¸ªæºï¼Œé»˜è®¤å€¼ pypi&quot;)parser_use.add_argument( &quot;-k&quot;, &quot;--kind&quot;, default=&quot;user&quot;, choices=(&quot;global&quot;, &quot;user&quot;, &quot;site&quot;), help=&quot;&quot;&quot;ç±»å‹ï¼Œé»˜è®¤å€¼ user - global Use the system-wide configuration file only - user Use the user configuration file only - site Use the current environment configuration file only&quot;&quot;&quot;,)parser_use.add_argument( &quot;-i&quot;, &quot;--isolated&quot;, action=&quot;store_true&quot;, help=&quot;Run pip in an isolated mode, ignoring environment &quot; &quot;variables and user configuration.&quot;)parser_use.add_argument( &quot;-c&quot;, &quot;--cmd-only&quot;, dest=&quot;cmd_only&quot;, action=&quot;store_true&quot;, help=&quot;å¹¶ä¸è®¾ç½®é…ç½®æ–‡ä»¶ï¼Œåªæ˜¯æ‰“å°ä¸€ä¸ª pip install å‘½ä»¤&quot;)args = parser.parse_args()from pip._internal.configuration import Configurationfrom urllib.parse import urlsplit# TIPS: 20 == logging.INFO__import__(&quot;logging&quot;).basicConfig(level=20, format=&quot;%(message)s&quot;)INDEXES = { &quot;pypi&quot;: { &quot;index-url&quot;: &quot;https://pypi.python.org/pypi&quot;, &quot;trusted-host&quot;: &quot;pypi.python.org&quot;, &quot;comment&quot;: &quot;å®˜æ–¹æº&quot; }, &quot;douban&quot;: { &quot;index-url&quot;: &quot;http://pypi.douban.com/simple/&quot;, &quot;trusted-host&quot;: &quot;pypi.douban.com&quot;, &quot;comment&quot;: &quot;è±†ç“£&quot; }, &quot;aliyun&quot;: { &quot;index-url&quot;: &quot;http://mirrors.aliyun.com/pypi/simple/&quot;, &quot;trusted-host&quot;: &quot;mirrors.aliyun.com&quot;, &quot;comment&quot;: &quot;é˜¿é‡Œäº‘&quot; }, &quot;tsinghua&quot;: { &quot;index-url&quot;: &quot;https://pypi.tuna.tsinghua.edu.cn/simple/&quot;, &quot;trusted-host&quot;: &quot;pypi.tuna.tsinghua.edu.cn&quot;, &quot;comment&quot;: &quot;æ¸…åå¤§å­¦&quot; }, &quot;ustc&quot;: { &quot;index-url&quot;: &quot;https://pypi.mirrors.ustc.edu.cn/simple/&quot;, &quot;trusted-host&quot;: &quot;pypi.mirrors.ustc.edu.cn&quot;, &quot;comment&quot;: &quot;ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦&quot; }, &quot;hustunique&quot;: { &quot;index-url&quot;: &quot;http://pypi.hustunique.com/simple/&quot;, &quot;trusted-host&quot;: &quot;pypi.hustunique.com&quot;, &quot;comment&quot;: &quot;åä¸­ç†å·¥å¤§å­¦&quot; }, &quot;sdutlinux&quot;: { &quot;index-url&quot;: &quot;http://pypi.sdutlinux.org/simple/&quot;, &quot;trusted-host&quot;: &quot;pypi.sdutlinux.org&quot;, &quot;comment&quot;: &quot;å±±ä¸œç†å·¥å¤§å­¦&quot; }, &quot;tencent&quot;: { &quot;index-url&quot;: &quot;http://mirrors.cloud.tencent.com/pypi/simple/&quot;, &quot;trusted-host&quot;: &quot;mirrors.cloud.tencent.com&quot;, &quot;comment&quot;: &quot;è…¾è®¯äº‘&quot; }, }def pipi_list(): &quot;ç½—åˆ—æ‰€æœ‰å¯ç”¨çš„æº&quot; for key, index in INDEXES.items(): print(&quot;%s: %s&quot; % (key, &quot;&quot;.join(&quot;\\n %s: %r&quot; % e for e in index.items())))def pipi_use(key=&quot;pypi&quot;, kind=&quot;user&quot;, isolated=False): &quot;&quot;&quot;ä½¿ç”¨ key æŒ‡å®šè¦è®¾ç½®çš„æº :param key: keyï¼Œå¯¹åº”æŸä¸ªæºï¼Œé»˜è®¤å€¼ pypi :param kind: ç±»å‹ï¼Œé»˜è®¤å€¼ user - global Use the system-wide configuration file only - user Use the user configuration file only - site Use the current environment configuration file only :param isolated: Run pip in an isolated mode, ignoring environment variables and user configuration. &quot;&quot;&quot; # assert kind in (&quot;global&quot;, &quot;user&quot;, &quot;site&quot;) index = INDEXES[key] index_url = index[&quot;index-url&quot;] trusted_host = index.get(&quot;trusted-host&quot;) or urlsplit(index_url).netloc conf = Configuration(isolated, kind) conf.load() conf.set_value(&quot;global.index-url&quot;, index_url) conf.set_value(&quot;global.trusted-host&quot;, trusted_host) conf.save()command = args.commandif command == &quot;list&quot;: pipi_list()elif command == &quot;use&quot;: if args.cmd_only: from sys import executable index = INDEXES[args.key] index_url = index[&quot;index-url&quot;] trusted_host = index.get(&quot;trusted-host&quot;) or urlsplit(index_url).netloc print(f&quot;'{executable}' -m pip install --index-url &quot; f&quot;{index_url} --trusted-host {trusted_host} &quot;) else: pipi_use(args.key, args.kind, args.isolated)else: raise NotImplementedError(f&quot;Command {command!r} is not implemented!&quot;) ä½¿ç”¨è¯´æ˜å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 123456789101112$ python pip_index.py -husage: pip_index.py [-h] {list,use} ...Python pip æºé…ç½®å·¥å…·positional arguments: {list,use} Available commands list ç½—åˆ—æ‰€æœ‰å¯ç”¨çš„æº use ä½¿ç”¨ key æŒ‡å®šè¦è®¾ç½®çš„æºoptional arguments: -h, --help show this help message and exit ä¸åŒçš„ç³»ç»Ÿå’Œç”¨æˆ·ï¼Œå‘½ä»¤è¾“å‡ºçš„ç»“æœä¼šæœ‰ä¸åŒï¼Œæˆ‘çš„ç¯å¢ƒå¦‚ä¸‹ï¼š 123456$ # æˆ‘å½“å‰ç”¨çš„ Linux å‘è¡Œç‰ˆ$ uname -aLinux kali 5.16.0-kali3-amd64 #1 SMP PREEMPT Debian 5.16.11-1kali1 (2022-03-03) x86_64 GNU/Linux$ # å½“å‰çš„ç”¨æˆ·$ whoamikali 1. list å‘½ä»¤å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 1234567891011$ python pip_index.py list -husage: pip_index.py list [-h]ç½—åˆ—æ‰€æœ‰å¯ç”¨çš„æºï¼Œæ ¼å¼å½¢å¦‚{key}: index-url: {index_url!r} trusted-host: {trusted_host!r} comment: {comment!r}optional arguments: -h, --help show this help message and exit æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233python pip_index.py list pypi: index-url: 'https://pypi.python.org/pypi' trusted-host: 'pypi.python.org' comment: 'å®˜æ–¹æº'douban: index-url: 'http://pypi.douban.com/simple/' trusted-host: 'pypi.douban.com' comment: 'è±†ç“£'aliyun: index-url: 'http://mirrors.aliyun.com/pypi/simple/' trusted-host: 'mirrors.aliyun.com' comment: 'é˜¿é‡Œäº‘'tsinghua: index-url: 'https://pypi.tuna.tsinghua.edu.cn/simple/' trusted-host: 'pypi.tuna.tsinghua.edu.cn' comment: 'æ¸…åå¤§å­¦'ustc: index-url: 'https://pypi.mirrors.ustc.edu.cn/simple/' trusted-host: 'pypi.mirrors.ustc.edu.cn' comment: 'ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦'hustunique: index-url: 'http://pypi.hustunique.com/simple/' trusted-host: 'pypi.hustunique.com' comment: 'åä¸­ç†å·¥å¤§å­¦'sdutlinux: index-url: 'http://pypi.sdutlinux.org/simple/' trusted-host: 'pypi.sdutlinux.org' comment: 'å±±ä¸œç†å·¥å¤§å­¦'tencent: index-url: 'http://mirrors.cloud.tencent.com/pypi/simple/' trusted-host: 'mirrors.cloud.tencent.com' comment: 'è…¾è®¯äº‘' 2. use å‘½ä»¤å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 1234567891011121314151617$ python pip_index.py use -h usage: pip_index.py use [-h] [-k {global,user,site}] [-i] [-c] [key]ä½¿ç”¨ key æŒ‡å®šè¦è®¾ç½®çš„æºpositional arguments: key keyï¼Œå¯¹åº”æŸä¸ªæºï¼Œé»˜è®¤å€¼ pypioptional arguments: -h, --help show this help message and exit -k {global,user,site}, --kind {global,user,site} ç±»å‹ï¼Œé»˜è®¤å€¼ user - global Use the system-wide configuration file only - user Use the user configuration file only - site Use the current environment configuration file only -i, --isolated Run pip in an isolated mode, ignoring environment variables and user configuration. -c, --cmd-only å¹¶ä¸è®¾ç½®é…ç½®æ–‡ä»¶ï¼Œåªæ˜¯æ‰“å°ä¸€ä¸ª pip install å‘½ä»¤ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç¤ºä¾‹ï¼š 123456789101112131415$ python pip_index.py use doubanWriting to /home/kali/.config/pip/pip.conf$ cat /home/kali/.config/pip/pip.conf[global]index-url = http://pypi.douban.com/simple/trusted-host = pypi.douban.com$ pip config list global.index-url='http://pypi.douban.com/simple/'global.trusted-host='pypi.douban.com'$ # å¦‚æœä»…ä»…åªæ˜¯æƒ³è¦ä½¿ç”¨æºï¼Œè€Œä¸æƒ³ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œ$ # å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æ‰“å°ä¸€ä¸ª pip install å‘½ä»¤ï¼Œ$ # å¤åˆ¶ååœ¨å‘½ä»¤è¡Œç²˜è´´ï¼Œç„¶ååœ¨åé¢æ·»åŠ è¦å®‰è£…çš„æ¨¡å—$ python pip_index.py use douban -c'/home/kali/anaconda3/bin/python' -m pip install --index-url http://pypi.douban.com/simple/ --trusted-host pypi.douban.com","link":"/2022/08/30/11.Python%E8%84%9A%E6%9C%AC%E8%AE%BE%E7%BD%AEpip%E7%B4%A2%E5%BC%95%E6%BA%90/"},{"title":"Pythonæ¨¡å—-pandas.DataFrameè½¬Excelæ ¼å¼çš„bytesæ•°æ®","text":"èƒŒæ™¯ pandas is an open source, BSD-licensed library providing high-performance, easy-to-use data structures and data analysis tools for the Python programming language. æ•°æ®åˆ†æå·¥å…·åŒ… pandasï¼Œæ˜¯åˆ©ç”¨ Python è¿›è¡Œæ•°æ®åˆ†ææ—¶ï¼Œä¸€ä¸ªéš¾ä»¥å‰²èˆçš„é€‰é¡¹ã€‚å®ƒçš„å®˜æ–¹æ–‡æ¡£ pandas/docs ç¤ºä¾‹éå¸¸ä¸°å¯Œï¼Œè€Œä¸”å®ƒçš„ä½œè€… Wes McKinney å¦å¤–è¿˜å†™äº†ä¸€æœ¬ä¹¦ Python for Data Analysisï¼Œæˆªè‡³ç›®å‰å·²ç»æ›´æ–°åˆ°ç¬¬ 3 ç‰ˆï¼ŒğŸ‘†ç‚¹å‡»ä¸‹è½½ã€‚ä¸­å›½å›½å†…ä¹Ÿæœ‰çƒ­å¿ƒç½‘å‹åšäº†å…è´¹çš„ç¿»è¯‘åˆ†äº«ï¼Œè¿™æ˜¯ç¬¬ 2 ç‰ˆï¼Œç®€ä¹¦-ã€ŠPythonæ•°æ®åˆ†æã€‹2ndã€‚ æˆ‘æ›¾ç»å®ç°è¿‡ä¸€ä¸ªå•æœºéƒ¨ç½²çš„ ETL (extract, transform, load) ç¨‹åºï¼Œä¸‰ä¸ªæ­¥éª¤éƒ½åŸºäº pandas å®ç°ã€‚ä¸è¿‡è¿™ä¸ªç¨‹åºæœ€å¸¸ç”¨çš„åŠŸèƒ½ï¼Œå´ä»…ä»…æ˜¯å®šæ—¶è¯»å–ä¸€æ‰¹ SQLï¼Œç„¶åå†™å…¥ Excelï¼Œæœ€åæŠŠè¿™äº› Excel æ–‡ä»¶ä½œä¸ºé‚®ä»¶é™„ä»¶è¿›è¡Œå‘é€ï¼ŒçœŸæ˜¯æ€é¸¡ç”¨ç‰›åˆ€ğŸ˜‚ã€‚ å…¶å®ï¼Œæˆ‘ä¸ªäººå¹¶ä¸å¤ªå–œæ¬¢ä½¿ç”¨ Excel æ–‡ä»¶ï¼Œå…ˆä¸è®º Excel é‚£ç¼“æ…¢çš„æ‰“å¼€é€Ÿåº¦ï¼Œå®ƒçš„ä¸€ä¸ªå·¥ä½œè¡¨æœ€å¤šä¹Ÿåªèƒ½æœ‰ 1048576ï¼ˆ2^20ï¼‰ è¡Œå’Œ 16384ï¼ˆ2^14ï¼‰ åˆ—ï¼Œå·¥ä½œè¡¨åå­—æœ€å¤š 31 ä¸ªå­—ç¬¦ã€‚æ‰€ä»¥åœ¨æˆ‘çœ‹æ¥ï¼ŒCSV æ‰æ˜¯æ›´å¥½çš„é€‰é¡¹ã€‚ åœ¨é‚£ä¸ª ETL ä¸­ï¼Œåªå…è®¸ä»æ¯ä¸ªæºè¯»å–ä¸€ä¸ª pandas çš„ DataFrameï¼Œä½†åœ¨è¾“å‡ºæ—¶ï¼Œå¯ä»¥æŠŠå¤šä¸ª DataFrame è¾“å‡ºåˆ°ä¸€ä¸ªç›®æ ‡é‡Œé¢ã€‚å¯¹äºä¸€ç§è¿™ç±»æƒ…å†µï¼Œå³æŠŠå¤šä¸ª DataFrame è¾“å‡ºåˆ°åŒä¸€ä¸ª Excel å·¥ä½œç°¿ï¼Œå¦‚æœè¿™ä¸ªç›®æ ‡ä¹‹åå†ä½œä¸ºä¸€ä¸ªæºæ—¶ï¼Œå°±ä¸å¥½å¤„ç†äº†ã€‚å¦‚æœè¿™æ˜¯æœ€ç»ˆçš„è¾“å‡ºï¼Œè€Œä¸æ˜¯ç®¡é“çš„ä¸€ä¸ªä¸­é—´ç¯èŠ‚ï¼Œå´æ˜¯å¯ä»¥æ¥å—çš„ã€‚ Excel æœ€å¤§çš„é—®é¢˜æ˜¯å·¥ä½œè¡¨çš„è§„æ¨¡æœ‰é™ï¼Œå¦‚æœä½ çš„è¡¨æ ¼çš„è§„æ ¼è¶…å‡º 1048576Ã—16384ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªçŸ©å½¢ä¸èƒ½æŠŠä½ æ•°æ®è¡¨æ ¼å®Œå…¨ç›–ä½ï¼Œä½ å°±å¾—å¯¹ DataFrame è¿›è¡Œæ‹†åˆ†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä¸ªäººæ˜¯ä¸æ¨èåšæ‹†åˆ†çš„ã€‚æˆ‘çš„å»ºè®®æ˜¯ï¼Œä¸€ä¸ªå·¥ä½œç°¿ï¼Œåªå¼€ä¸€ä¸ªå·¥ä½œè¡¨ï¼Œå¦‚æœä¸€ä¸ªå·¥ä½œè¡¨å­˜å‚¨ä¸ä¸‹ï¼Œé‚£å°±ç”¨ CSV æˆ–è€… hdf5 æ ¼å¼ã€‚ ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/6a3f6177ce8da748413ce304156588f9 æ–‡ä»¶åç§°æ˜¯ pandas_to_excel_bytes.pyï¼ŒPython å®ç°ä»£ç å¦‚ä¸‹ï¼š pandas_to_excel_bytes.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295#!/usr/bin/env python3# coding: utf-8&quot;&quot;&quot;è¿™ä¸ªæ¨¡å—æä¾›äº†å·¥å…·å‡½æ•°ï¼Œå¯ä»¥æŠŠ `pandas` çš„ `DataFrame` è½¬æ¢æˆxlsx æ ¼å¼çš„ Excel æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®&quot;&quot;&quot;__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1)__all__ = [&quot;df_to_excel_bytes&quot;, &quot;sql_to_excel_bytes&quot;]from concurrent.futures import ThreadPoolExecutorfrom contextlib import contextmanagerfrom io import BytesIO from os import PathLikefrom typing import cast, Final, Iterable, IO, TypeVar, Unionfrom types import MappingProxyType, MethodTypefrom warnings import warn# å®‰è£… [pandas-stubs](https://pypi.org/project/pandas-stubs/) ä»¥é™æ€æ£€æŸ¥from pandas import read_sql, DataFrame, ExcelWriter, RangeIndexIO_T = TypeVar(&quot;IO_T&quot;, bytes, str)# Excel çš„å·¥ä½œè¡¨åæœ‰ä¸€äº›éæ³•å­—ç¬¦ []:*?/\\\\ï¼Œéœ€è¦æŠŠå‡ºç°çš„éæ³•å­—ç¬¦å˜æˆåˆæ³•å­—ç¬¦ _EXCEL_SHEETNAME_INVALID_CHARS_TRANSTABLE: Final[MappingProxyType] = \\ MappingProxyType(dict.fromkeys(map(ord, &quot;[]:*?/\\\\&quot;), &quot;_&quot;))# xlsx æ ¼å¼çš„ Excel æ–‡ä»¶ï¼Œæœ€å¤§çš„è¡Œæ•°SHEET_MAX_NROWS: Final[int] = 2 ** 20# xlsx æ ¼å¼çš„ Excel æ–‡ä»¶ï¼Œæœ€å¤§çš„åˆ—æ•°SHEET_MAX_NCOLS: Final[int] = 2 ** 14# xlsx æ ¼å¼çš„ Excel æ–‡ä»¶ï¼Œå·¥ä½œè¡¨åæœ€å¤§çš„å­—ç¬¦æ•°SHEETNAME_MAX_LENGTH: Final[int] = 31def read_io(fio: IO[IO_T], /) -&gt; IO_T: &quot;ä»å¤´è¯»å–ä¸€ä¸ª IO å¯¹è±¡çš„æ•°æ®&quot; pos: int = fio.tell() try: fio.seek(0) return fio.read() finally: fio.seek(pos)@contextmanagerdef ctx_df_to_excel_bytes(**kwargs): &quot;&quot;&quot;ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚ æŠŠ `pandas` çš„ `DataFrame` å¯¹è±¡è½¬æ¢æˆ xlsx æ ¼å¼çš„ Excel æ–‡ä»¶çš„å­—èŠ‚æ•°æ® :param kwargs: å…³é”®å­—å‚æ•°ä¼ ç»™ `pandas` çš„ `ExcelWriter` æ„é€ å™¨ &gt; è¯·å‚è€ƒ: pandas.io.Excel._base.ExcelWriter &gt; https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.ExcelWriter.html :return: ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œè¿”å›ä¸€ä¸ª `pandas` çš„ `ExcelWriter` å¯¹è±¡ï¼Œ ä½†æ˜¯å¢åŠ äº† 3 ä¸ªå±æ€§ï¼š - bio: Excel æ•°æ®å°†è¢«å†™å…¥è¿™ä¸ª `io.Bytes` å¯¹è±¡ - read: ä» `bio` ä¸­è¯»å– Excel æ•°æ® - write: æŠŠ `bio` ä¸­çš„ Excel æ•°æ®å†™å…¥ä¸€ä¸ªè·¯å¾„ Example:: &gt;&gt;&gt; import pandas as pd &gt;&gt;&gt; df = pd.DataFrame([[1,2],[3,4]]) &gt;&gt;&gt; with ctx_df_to_excel_bytes() as writer: ... for i in range(10): ... df.to_excel(writer, sheet_name=str(i), index=False) &gt;&gt;&gt; data = writer.read() &gt;&gt;&gt; df2 = pd.read_excel(data, sheet_name=&quot;5&quot;) &gt;&gt;&gt; (df == df2).all(None) True &quot;&quot;&quot; bio = kwargs[&quot;path&quot;] = BytesIO() def read(self) -&gt; bytes: return read_io(self.bio) def write(self, path: Union[bytes, int, PathLike]) -&gt; int: return open(path, &quot;wb&quot;).write(read(self)) with ExcelWriter(**kwargs) as writer: setattr(writer, &quot;bio&quot;, bio) setattr(writer, &quot;read&quot;, MethodType(read, writer)) setattr(writer, &quot;write&quot;, MethodType(write, writer)) yield writerdef df_to_excel_bytes( dfs: Union[DataFrame, dict[str, DataFrame], Iterable[DataFrame]]) -&gt; bytes: &quot;&quot;&quot;æŠŠ `pandas` çš„ `DataFrame` å¯¹è±¡è½¬æ¢æˆ xlsx æ ¼å¼çš„ Excel æ–‡ä»¶çš„å­—èŠ‚æ•°æ® :param dfs: ä¸€ä¸ªæˆ–ä¸€æ‰¹ `pandas` çš„ `DataFrame` å¯¹è±¡ :return: Excel æ–‡ä»¶çš„å­—èŠ‚æ•°æ® Example:: &gt;&gt;&gt; import pandas as pd &gt;&gt;&gt; df = pd.DataFrame([[1,2],[3,4]]) &gt;&gt;&gt; data = df_to_excel_bytes([df]*10) &gt;&gt;&gt; df2 = pd.read_excel(data, sheet_name=&quot;5&quot;) &gt;&gt;&gt; (df == df2).all(None) True &quot;&quot;&quot; dfd: dict[str, DataFrame] if isinstance(dfs, DataFrame): dfd = {&quot;Sheet1&quot;: dfs} elif isinstance(dfs, dict): dfd = dfs else: dfd = {str(i): df for i, df in enumerate(dfs)} with ctx_df_to_excel_bytes() as writer: for old_k, df in dfd.items(): # æŠŠåç§° old_k ä¸­çš„æ‰€æœ‰éæ³•å­—ç¬¦å„è‡ªè½¬æ¢æˆä¸‹åˆ’çº¿ _ k = old_k.translate(EXCEL_SHEETNAME_INVALID_CHARS_TRANSTABLE) if old_k != k: warn(f&quot;Illegal characters found in sheetname, convert {old_k!r} to {k!r}&quot;) index, columns = df.index, df.columns nrows, ncols = len(index), len(columns) index_nlevel, columns_nlevel = index.nlevels, columns.nlevels # whether_output_index åˆ¤åˆ«äº†æ˜¯å¦è¦åœ¨ Excel ä¸­è¾“å‡º index # åªæœ‰å½“ index å’Œ columns çš„ level å±‚æ•°éƒ½æ˜¯ 1ï¼Œå¹¶ä¸” index çš„å¼€å§‹å€¼ start ä¸º 0 ä¸” # æ­¥è¿› step çš„å€¼æ˜¯ 1ï¼Œæ‰ä¸éœ€è¦è¾“å‡ºç´¢å¼•ã€‚ # TIPS: å¦‚æœ columns çš„ level å±‚æ•°å¤§äº 1ï¼Œ`pandas` è§„å®šå¿…é¡»è¾“å‡º index whether_output_index = not ( columns_nlevel == 1 and index_nlevel == 1 and isinstance(index, RangeIndex) and index.start == 0 and index.step == 1 ) # rng_row_step: é™¤å» columns çš„è¾“å‡ºåï¼Œè¿˜å‰©å¤šå°‘è¡Œå¯ä¾›æ•°æ®è¾“å‡º rng_row_step: int # rng_col_step: é™¤å» index çš„è¾“å‡ºåï¼ˆä¹Ÿå¯èƒ½ä¸è¾“å‡ºï¼‰ï¼Œè¿˜å‰©å¤šå°‘åˆ—å¯ä¾›æ•°æ®è¾“å‡º rng_col_step: int if whether_output_index: # å¦‚æœ columns çš„ level å±‚æ•°å¤§äº 1ï¼Œåˆ™ä¼šå¤šè¾“å‡ºä¸€ç©ºç™½è¡Œ if columns_nlevel &gt; 1: rng_row_step = SHEET_MAX_NROWS - columns_nlevel - 1 else: rng_row_step = SHEET_MAX_NROWS - 1 rng_col_step = SHEET_MAX_NCOLS - index_nlevel else: rng_row_step = SHEET_MAX_NROWS - 1 rng_col_step = SHEET_MAX_NCOLS rng_row = range(0, nrows, rng_row_step) rng_col = range(0, ncols, rng_col_step) # suffix_templateï¼š å¦‚æœçš„è¡Œæˆ–åˆ—è¿‡å¤§ï¼Œå¯¼è‡´ä¸€å¼ å·¥ä½œè¡¨ä¸èƒ½è¾“å‡ºï¼Œåˆ™è¦ # æ‹†åˆ†æˆå‡ å¼ å·¥ä½œè¡¨ï¼Œä¸ºæ­¤éœ€è¦ä¸ºåŒä¸€ä¸ª DataFrame è¾“å‡ºçš„å¤šä¸ªå·¥ä½œè¡¨ # æ·»åŠ åç¼€ï¼Œæœ€åçš„æ ¼å¼å½¢å¦‚ï¼ˆ{name}è¡¨ç¤ºå¼•ç”¨ï¼‰ # {è¡¨å}^{è¡Œåˆ‡åˆ†åºå·}_{åˆ—åˆ‡åˆ†åºå·} # å‡è®¾æŸä¸ª DataFrame è¢«åˆ‡åˆ†æˆäº† # sheet^0_0, sheet^0_1, sheet^1_0, sheet^1_0 # é‚£ä¹ˆæ•°æ®åœ¨åŸæ¥çš„ DataFrame ä¸­çš„åˆ†å¸ƒåˆ™æ˜¯ # |sheet^0_0 | sheet^0_1 | # |â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”|â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”| # |sheet^1_0 | sheet^1_0 | suffix_template = &quot;&quot; # TIPS: å·¥ä½œè¡¨æœ€å¤šåªèƒ½æœ‰ 31 ä¸ªå­—ç¬¦ï¼Œå› æ­¤å¦‚æœæ·»åŠ åç¼€åï¼Œå¯¼è‡´å’Œè¡¨åçš„ç»„åˆå¤šäº # 31 å­—ç¬¦ï¼Œé‚£ä¹ˆå°±è¦ä»è¡¨åçš„å°¾éƒ¨å»æ‰ä¸€äº›å­—ç¬¦ suffix_len = 0 if len(rng_row) &gt; 1: q, r = divmod(len(rng_row), 16) l = q + (r &gt; 0) suffix_template += &quot;^{0:0%dx}&quot; % l suffix_len += l + 1 if len(rng_col) &gt; 1: q, r = divmod(len(rng_col), 16) l = q + (r &gt; 0) suffix_template += &quot;_{1:0%dx}&quot; % l suffix_len += l + 1 if suffix_len &gt; 31: raise RuntimeError(f&quot;DataFrame is too large: {old_k!r}&quot;) if suffix_len: for i, row0 in enumerate(rng_row): for j, col0 in enumerate(rng_col): suffix = suffix_template.format(i, j) key = k[:31-suffix_len] + suffix warn(f&quot;DataFrame is too large, generate sub-sheet: {key!r} (of {old_k!r})&quot;) df.iloc[row0:row0+rng_row_step, col0:col0+rng_col_step].to_excel( writer, index=whether_output_index, sheet_name=key) else: key = k[:31] if key != k: warn(f&quot;Sheetname is too long, convert {old_k!r} to {key!r}&quot;) if key == &quot;&quot;: key = &quot;Sheet1&quot; df.to_excel(writer, index=whether_output_index, sheet_name=key) return writer.read()def pandas_read_sqls( sqls: Union[str, dict[str, str], Iterable[str]], con, read_workers: int = -1,) -&gt; dict[str, DataFrame]: &quot;&quot;&quot;è¯»å–ä¸€æ‰¹ SQL æŸ¥è¯¢è¯­å¥ï¼Œæ¯ä¸ª SQL çš„æŸ¥è¯¢ç»“æœéƒ½æ˜¯ä¸€ä¸ª `pandas` çš„ `DataFrame` å¯¹è±¡ã€‚ :param sqls: ä¸€ä¸ªæˆ–ä¸€æ‰¹ SQL æŸ¥è¯¢è¯­å¥ :param con: SQL æŸ¥è¯¢çš„æœåŠ¡å™¨è¿æ¥ SQLAlchemy connectable, str, or sqlite3 connection Using SQLAlchemy makes it possible to use any DB supported by that library. If a DBAPI2 object, only sqlite3 is supported. The user is responsible for engine disposal and connection closure for the SQLAlchemy connectable; str connections are closed automatically. See `here &lt;https://docs.sqlalchemy.org/en/13/core/connections.html&gt;`_. :param read_workers: å¹¶å‘çš„æŸ¥è¯¢æ•° - å¦‚æœå°äº 0 æˆ–ç­‰äº 1ï¼Œåˆ™å¹¶å‘æ•°ä¸º 1ï¼Œå³ä¸å¹¶å‘ - å¦‚æœç­‰äº 0ï¼Œåˆ™ç”¨ ThreadPoolExecutor é»˜è®¤çš„å¹¶å‘æ•° - å¦‚æœå¤§äº 0ï¼Œåˆ™æ•°å€¼å°±æ˜¯å¹¶å‘æ•° :return: è¿”å›å€¼çš„å†…å®¹å–å†³äºå‚æ•° `sqls`ï¼Œå…·ä½“ä¸º if isinstance(sqls, str): return {&quot;&quot;: pandas.read_sql(sqls, con)} elif isinstance(sqls, dict): return {k: pandas.read_sql(sql, con) for k, sql in sqls.items()} else: return {str(i): pandas.read_sql(sql, con) for i, sql in enumerate(sqls)} &quot;&quot;&quot; if isinstance(sqls, str): return {&quot;&quot;: read_sql(sqls, con)} else: if not isinstance(sqls, dict): sqls = dict((str(i), sql) for i, sql in enumerate(sqls)) sqls = cast(dict[str, str], sqls) if read_workers &lt; 0 or read_workers == 1: return {k: read_sql(sql, con) for k, sql in sqls.items()} else: with ThreadPoolExecutor( None if read_workers == 0 else min(read_workers, len(sqls)) ) as worker: df_iter = worker.map(lambda sql: read_sql(sql, con), sqls) return {k: df for k, df in zip(sqls, df_iter)}def sql_to_excel_bytes( sqls: Union[str, dict[str, str], Iterable[str]], con, read_workers: int = -1,) -&gt; bytes: &quot;&quot;&quot;æ‰§è¡Œä¸€äº› SQL æŸ¥è¯¢è¯­å¥ï¼Œå¹¶æŠŠæŸ¥è¯¢ç»“æœä¿å­˜åˆ°åŒä¸€ä¸ª xlsx æ ¼å¼çš„ Excel æ–‡ä»¶ä¸­ï¼Œ ç„¶åè¯»å–è¿™ä¸ª Excel æ–‡ä»¶å¹¶è¿”å›å­—èŠ‚æ•°æ®ã€‚ :param sqls: ä¸€ä¸ªæˆ–ä¸€æ‰¹ SQL æŸ¥è¯¢è¯­å¥ï¼Œå·¥ä½œè¡¨åçš„ç¡®å®šæ–¹å¼å¦‚ä¸‹ï¼š - å¦‚æœ `sql` æ˜¯ strï¼Œåˆ™å·¥ä½œè¡¨åä¸º &quot;Sheet1&quot;ï¼Œ`sqls`æ˜¯ç›¸åº”çš„ SQL - å¦‚æœ `sql` æ˜¯ dictï¼Œ åˆ™å­—å…¸çš„é”®æ˜¯å·¥ä½œè¡¨åï¼Œå€¼æ˜¯ç›¸åº”çš„ SQL &gt; æ³¨æ„ï¼šæ¯ä¸ªå·¥ä½œè¡¨çš„åå­—ï¼Œä¸å…è®¸åŒ…å«è¿™äº›å­—ç¬¦ä¹‹ä¸€ []:*?/\\\\ ï¼Œ å¦‚æœåŒ…å«ï¼Œåˆ™ä¼šè¢«è‡ªåŠ¨æ›¿æ¢æˆ _ - å¦åˆ™ `sql` å°±æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œ åˆ™å€¼æ˜¯ SQLï¼Œåºå·ï¼ˆä»0å¼€å§‹é€’å¢ï¼‰æ˜¯ç›¸åº”çš„å·¥ä½œè¡¨å &gt; æ³¨æ„ï¼šæ¯ä¸ª SQL æŸ¥è¯¢è¿”å›çš„æ•°æ®é‡ï¼Œè¡Œæ•°å°½é‡ &lt;= 1048575(==2**20-1ï¼Œç¬¬ 1 è¡Œæ˜¯è¡¨å¤´)ï¼Œ åˆ—æ•°æœ€å¥½ &lt;= 16384 (==2**14)ï¼Œå¦åˆ™ä¼šè¢«è‡ªåŠ¨æ‹†åˆ† :param con: SQL æŸ¥è¯¢çš„æœåŠ¡å™¨è¿æ¥ SQLAlchemy connectable, str, or sqlite3 connection Using SQLAlchemy makes it possible to use any DB supported by that library. If a DBAPI2 object, only sqlite3 is supported. The user is responsible for engine disposal and connection closure for the SQLAlchemy connectable; str connections are closed automatically. See `here &lt;https://docs.sqlalchemy.org/en/13/core/connections.html&gt;`_. :param read_workers: å¹¶å‘çš„æŸ¥è¯¢æ•° - å¦‚æœå°äº 0 æˆ–ç­‰äº 1ï¼Œåˆ™å¹¶å‘æ•°ä¸º 1ï¼Œå³ä¸å¹¶å‘ - å¦‚æœç­‰äº 0ï¼Œåˆ™ç”¨ ThreadPoolExecutor é»˜è®¤çš„å¹¶å‘æ•° - å¦‚æœå¤§äº 0ï¼Œåˆ™æ•°å€¼å°±æ˜¯å¹¶å‘æ•° :return: Excel æ–‡ä»¶æ•°æ®ï¼Œbytes å½¢å¼ Example:: å¯ä»¥ç”¨ sqllite3 è¿›è¡Œæµ‹è¯• &gt;&gt;&gt; sql = '''\\\\ ... with recursive range(x) as ( ... values(0) ... union all ... select x + 1 from range where x &lt; POW(2, 21) ... ) ... select * from range;''' &gt;&gt;&gt; data = sql_to_excel_bytes([sql]*2, &quot;sqlite:///:memory:&quot;) ... &gt;&gt;&gt; import pandas as pd &gt;&gt;&gt; df0 = pd.read_excel(data, sheet_name=&quot;0^0&quot;) &gt;&gt;&gt; df1 = pd.read_excel(data, sheet_name=&quot;0^1&quot;) &gt;&gt;&gt; df2 = pd.read_excel(data, sheet_name=&quot;0^2&quot;) &gt;&gt;&gt; df = pd.concat([df0, df1, df2], ignore_index=True) &gt;&gt;&gt; (df.x == range(2 ** 21 + 1)).all() True &quot;&quot;&quot; dfs = pandas_read_sqls(sqls, con, read_workers) return df_to_excel_bytes(dfs)if __name__ == &quot;__main__&quot;: import doctest doctest.testmod() æ‰©å±•é˜…è¯»1. æŠŠ pandas çš„ DataFrame å¯¼å‡ºå„ç§ç¼–ç æ ¼å¼çš„å­—ç¬¦ä¸²å¦‚æœæ¯ä¸ª pandas çš„ DataFrameï¼Œå„è‡ªå¯¼å‡ºåˆ°ä¸åŒçš„ç›®æ ‡ï¼Œé‚£ä¹ˆå¯ä»¥è¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œå®ç°ä¸€ä¸ªç‰¹åˆ«ç®€å•çš„ç»Ÿä¸€å¤„ç†å‡½æ•°ï¼Œè¿”å›å¯¼å‡ºçš„ bytes æˆ– strã€‚ pandas_df_2_string å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ filetype outtype RETURN TYPE 0 'csv' bytes bytes 1 'csv' str str 2 'csv' None str 3 'excel' bytes bytes 4 'excel' None bytes 5 'feather' bytes bytes 6 'feather' None bytes 7 'hdf' bytes bytes 8 'hdf' None bytes 9 'html' bytes bytes 10 'html' str str 11 'html' None str 12 'json' bytes bytes 13 'json' str str 14 'json' None str 15 'latex' bytes bytes 16 'latex' str str 17 'latex' None str 18 'markdown' bytes bytes 19 'markdown' str str 20 'markdown' None str 21 'parquet' bytes bytes 22 'parquet' None bytes 23 'pickle' bytes bytes 24 'pickle' None bytes 25 'stata' bytes bytes 26 'stata' None bytes 27 'string' bytes bytes 28 'string' str str 29 'string' None str 30 'xml' bytes bytes 31 'xml' str str 32 'xml' None str pandas_df_2_string.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131#!/usr/bin/env python3# coding: utf-8__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1)__all__ = [&quot;pandas_df_2_string&quot;]from io import BytesIO, StringIOfrom os import removefrom tempfile import mktempfrom uuid import uuid4def _to_bytes(write, /, **kwds): fio = BytesIO() write(fio, **kwds) fio.seek(0) return fio.read()def _to_str(write, /, **kwds): fio = StringIO() write(fio, **kwds) fio.seek(0) return fio.read()def _to_str_bytes(write, /, **kwds): return _to_str(write, **kwds).encode(encoding=&quot;utf-8&quot;)def _call_none(write, /, **kwds): return write(None, **kwds)def _to_hdf_bytes(write, /, **kwds): kwds.setdefault(&quot;key&quot;, &quot;default&quot;) path = mktemp(str(uuid4())) try: write(path, **kwds) return open(path, &quot;rb&quot;).read() finally: try: remove(path) except: passMAP = { &quot;csv&quot;: { bytes: _to_bytes, str: _to_str, None: _call_none, }, &quot;excel&quot;: { bytes: _to_bytes, None: _to_bytes, }, &quot;feather&quot;: { bytes: _to_bytes, None: _to_bytes, }, &quot;hdf&quot;: { bytes: _to_hdf_bytes, None: _to_hdf_bytes, }, &quot;html&quot;: { bytes: _to_str_bytes, str: _to_str, None: _call_none, }, &quot;json&quot;: { bytes: _to_bytes, str: _to_str, None: _call_none, }, &quot;latex&quot;: { bytes: _to_str_bytes, str: _to_str, None: _call_none, }, &quot;markdown&quot;: { bytes: _to_str_bytes, str: _to_str, None: _call_none, }, &quot;parquet&quot;: { bytes: _to_bytes, None: _call_none, }, &quot;pickle&quot;: { bytes: _to_bytes, None: _to_bytes, }, &quot;stata&quot;: { bytes: _to_bytes, None: _call_none, }, &quot;string&quot;: { bytes: _to_str_bytes, str: _to_str, None: _call_none, }, &quot;xml&quot;: { bytes: _to_bytes, str: _to_str, None: _call_none, },}def pandas_df_2_string(df, filetype=&quot;csv&quot;, outtype=None, **kwds): &quot;&quot;&quot;æŠŠ dataframe å¯¼å‡ºä¸º bytes æˆ– str :param df: pandas.DataFrame å¯¹è±¡ :param filetype: æ–‡ä»¶æ ¼å¼ï¼Œå¯ä»¥å–å€¼å¦‚ä¸‹ï¼š 'csv', 'excel', 'feather', 'hdf', 'html', 'json', 'latex', 'markdown', 'parquet', 'pickle', 'stata', 'string', 'xml' :param outtype: è¾“å‡ºæ ¼å¼ï¼Œå¯ä»¥å–å€¼å¦‚å³ï¼šbytes, str, None &gt; æ³¨æ„ï¼šbytes å’Œ None éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯ str åªå¯¹æŸäº› filetype æœ‰æ•ˆ :param kwds: è°ƒç”¨çš„æ–¹æ³•ä¼šè½å®åˆ° getattr(pandas.DataFrame, 'to_' + filetype) ï¼Œè€Œ `kwds` æ˜¯ä¼ ç»™è¿™ä¸ªæ–¹æ³•çš„å…¶å®ƒå…³é”®å­—å‚æ•° :return: æ ¹æ® outtype çš„å€¼æ¥å†³å®šï¼š - outtype æ˜¯ bytesï¼Œè¾“å‡ºç±»å‹ bytes - outtype æ˜¯ strï¼Œè¾“å‡ºç±»å‹ str - outtype æ˜¯ Noneï¼Œè¾“å‡ºç±»å‹ç”±å…·ä½“ filetype å†³å®š &quot;&quot;&quot; submap = MAP.get(filetype) if submap is None: raise ValueError(f&quot;Invalid filetype, expected value in {MAP.keys()}, got {filetype!r}&quot;) outm = submap.get(outtype) if outm is None: raise ValueError(f&quot;Invalid outtype for filetype {filetype!r}, expected value in {submap.keys()}, got {outtype!r}&quot;) method = getattr(df, &quot;to_&quot; + filetype) return outm(method, **kwds) 2. åŸºäºpandaså®ç°ä¸€ä¸ªç®€å•çš„ETLç¨‹åºæˆ‘ç”¨çš„ Python å’Œ pandas ç‰ˆæœ¬å¦‚ä¸‹ 1234$ python -VPython 3.9.12$ python -c &quot;import pandas;print(pandas.__version__)&quot;1.4.2 ETL çš„ extract è¿™ä¸€æ­¥ï¼Œéœ€è¦å°è£…æ‰€æœ‰ pandas.read_* æ–¹æ³•ï¼Œç½—åˆ—å¦‚ä¸‹ 12345678910import pandas as pddf = pd.DataFrame( [( &quot;pandas.&quot; + f, pd.__dict__[f].__doc__.split(&quot;\\n&quot;, 2)[1].strip() ) for f in dir(pd) if f.startswith(&quot;read_&quot;)], columns=[&quot;è¯»å…¥æ–¹æ³•&quot;, &quot;è¯´æ˜&quot;], )print(df.to_markdown()) è¯»å…¥æ–¹æ³• è¯´æ˜ 0 pandas.read_clipboard Read text from clipboard and pass to read_csv. 1 pandas.read_csv Read a comma-separated values (csv) file into DataFrame. 2 pandas.read_excel Read an Excel file into a pandas DataFrame. 3 pandas.read_feather Load a feather-format object from the file path. 4 pandas.read_fwf Read a table of fixed-width formatted lines into DataFrame. 5 pandas.read_gbq Load data from Google BigQuery. 6 pandas.read_hdf Read from the store, close it if we opened it. 7 pandas.read_html Read HTML tables into a list of DataFrame objects. 8 pandas.read_json Convert a JSON string to pandas object. 9 pandas.read_orc Load an ORC object from the file path, returning a DataFrame. 10 pandas.read_parquet Load a parquet object from the file path, returning a DataFrame. 11 pandas.read_pickle Load pickled pandas object (or any object) from file. 12 pandas.read_sas Read SAS files stored as either XPORT or SAS7BDAT format files. 13 pandas.read_spss Load an SPSS file from the file path, returning a DataFrame. 14 pandas.read_sql Read SQL query or database table into a DataFrame. 15 pandas.read_sql_query Read SQL query into a DataFrame. 16 pandas.read_sql_table Read SQL database table into a DataFrame. 17 pandas.read_stata Read Stata file into DataFrame. 18 pandas.read_table Read general delimited file into DataFrame. 19 pandas.read_xml Read XML document into a DataFrame object. è€Œåš ETL çš„ load è¿™ä¸€æ­¥ï¼Œéœ€è¦å°è£…æ‰€æœ‰ pandas.DataFrame.to_* æ–¹æ³•ï¼Œç½—åˆ—å¦‚ä¸‹ 12345678910import pandas as pddf = pd.DataFrame( [( &quot;pandas.DataFrame.&quot; + f, getattr(pd.DataFrame, f).__doc__.split(&quot;\\n&quot;, 2)[1].strip() ) for f in dir(pd.DataFrame) if f.startswith(&quot;to_&quot;)], columns=[&quot;å†™å‡ºæ–¹æ³•&quot;, &quot;è¯´æ˜&quot;], )print(df.to_markdown()) å†™å‡ºæ–¹æ³• è¯´æ˜ 0 pandas.DataFrame.to_clipboard Copy object to the system clipboard. 1 pandas.DataFrame.to_csv Write object to a comma-separated values (csv) file. 2 pandas.DataFrame.to_dict Convert the DataFrame to a dictionary. 3 pandas.DataFrame.to_excel Write object to an Excel sheet. 4 pandas.DataFrame.to_feather Write a DataFrame to the binary Feather format. 5 pandas.DataFrame.to_gbq Write a DataFrame to a Google BigQuery table. 6 pandas.DataFrame.to_hdf Write the contained data to an HDF5 file using HDFStore. 7 pandas.DataFrame.to_html Render a DataFrame as an HTML table. 8 pandas.DataFrame.to_json Convert the object to a JSON string. 9 pandas.DataFrame.to_latex Render object to a LaTeX tabular, longtable, or nested table/tabular. 10 pandas.DataFrame.to_markdown Print DataFrame in Markdown-friendly format. 11 pandas.DataFrame.to_numpy Convert the DataFrame to a NumPy array. 12 pandas.DataFrame.to_parquet Write a DataFrame to the binary parquet format. 13 pandas.DataFrame.to_period Convert DataFrame from DatetimeIndex to PeriodIndex. 14 pandas.DataFrame.to_pickle Pickle (serialize) object to file. 15 pandas.DataFrame.to_records Convert DataFrame to a NumPy record array. 16 pandas.DataFrame.to_sql Write records stored in a DataFrame to a SQL database. 17 pandas.DataFrame.to_stata Export DataFrame object to Stata dta format. 18 pandas.DataFrame.to_string Render a DataFrame to a console-friendly tabular output. 19 pandas.DataFrame.to_timestamp Cast to DatetimeIndex of timestamps, at beginning of period. 20 pandas.DataFrame.to_xarray Return an xarray object from the pandas object. 21 pandas.DataFrame.to_xml Render a DataFrame to an XML document. åœ¨ ETL çš„ä¸‰ä¸ªæ­¥éª¤ä¸­ï¼Œæœ€é‡è¦çš„æ˜¯ T (transform)ã€‚æˆ‘ä¹‹å‰çš„é¡¹ç›®ï¼Œåœ¨ transform è¿™ä¸€æ­¥ï¼Œä¸“é—¨å¼€å‘äº†ä¸€ä¸ª DSL(Domain-specific language)ï¼Œä¼šæŠŠä¸€ç§ç›¸å¯¹ç®€å•çš„è¯­è¨€ç¿»è¯‘æˆ Python å’Œ pandas æ“ä½œã€‚ä½†æ˜¯ä½œä¸ºç¤ºä¾‹æ¥è¯´ï¼Œè¿™è¿‡äºå¤æ‚äº†ï¼Œç­‰ä¸‹æ¬¡åˆ†äº«å¦‚ä½•å¼€å‘è„šæœ¬è¯­è¨€æ—¶ï¼Œæˆ‘å†å±•å¼€è¿™ä¸ªä¾‹å­ã€‚ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘æŠŠ ETL ç®€åŒ–æˆå¦‚ä¸‹è¿™æ ·ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ 12345678910111213from contextlib import contextmanagerfrom typing import Any, Callablefrom pandas.core.frame import DataFrame@contextmanagerdef ctx_dataframe_as_pipe( read: Callable[[], DataFrame], write: Callable[[DataFrame], Any], ): df = read() yield df write(df) å…¶ä¸­ read å’Œ write åœ¨è°ƒç”¨å‡½æ•°æ—¶ä¼ å…¥ï¼Œè¯·ç¡®ä¿ä¼ å…¥çš„å‚æ•°ç±»å‹æ­£ç¡®ï¼Œå¿…é¡»æ˜¯ä¸¤ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå¦‚æœå®ƒä»¬å„è‡ªè¿˜æœ‰å…¶å®ƒå‚æ•°ï¼Œè¯·æå‰ç”¨åå‡½æ•° functools.partial è¿›è¡Œæ†ç»‘ã€‚ æœªå®Œå¾…ç»­","link":"/2022/09/08/13.Python%E6%A8%A1%E5%9D%97-pandas.DataFrame%E8%BD%ACExcel%E6%A0%BC%E5%BC%8F%E7%9A%84bytes%E6%95%B0%E6%8D%AE/"},{"title":"Pythonæ¨¡å—-æ‰“åŒ…å¤šä¸ªå‚æ•°äºä¸€ä½“","text":"èƒŒæ™¯åœ¨è°ƒç”¨ Python å‡½æ•° (See also realpython - Defining Your Own Python Function) çš„æ—¶å€™ï¼Œå¾€å¾€éœ€è¦ä¼ å…¥ä¸€äº›å‚æ•°ã€‚å‡½æ•°æ‰€éœ€çš„å‚æ•°è¢«ç§°ä¸ºå½¢å¼å‚æ•° parameterï¼Œä¼ å…¥çš„å‚æ•°è¢«ç§°ä¸ºå®é™…å‚æ•° argument (See also 5 Types of Arguments in Python Function Definitions))ã€‚ See also the FAQ question on the difference between arguments and parameters, the inspect.Parameter class, the Function definitions section, and PEP 362. æˆ‘å¸¸å¸¸éœ€è¦æŠŠä¸€äº›å®é™…å‚æ•°æ”¶é›†èµ·æ¥ï¼Œå¯èƒ½åç»­è¿˜è¦è¿›è¡Œä¸€äº›æ›´æ–°ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™åå¤ä½¿ç”¨ã€‚æœ‰ä¸€ç§åŠæ³•æ˜¯ä½¿ç”¨åå‡½æ•° functools.partialï¼Œä½†è¿™éœ€è¦ç»‘å®šå…·ä½“çš„å‡½æ•°ã€‚ 123456789&gt;&gt;&gt; from functools import partial&gt;&gt;&gt; basetwo = partial(int, base=2)&gt;&gt;&gt; basetwo.__doc__ = 'Convert base 2 string to an int.'&gt;&gt;&gt; basetwo('10010')18&gt;&gt;&gt; basethree = partial(basetwo, base=3)&gt;&gt;&gt; basethree.__doc__ = 'Convert base 3 string to an int.'&gt;&gt;&gt; basethree('10010')84 äºæ˜¯æˆ‘å®ç°äº†ä¸€ä¸ªç±» Argsï¼Œå®ƒå¯ä»¥ä¸€æ¬¡æ€§æ”¶é›†ä¸€äº›ä½ç½®å‚æ•°(positional argumentï¼ŒSee also stackoverflow - Understanding positional arguments in Python)å’Œå…³é”®å­—å‚æ•°(keyword argumentï¼ŒSee also realpython - Python args and kwargs: Demystified)ï¼Œå¹¶åœ¨ä»¥åéœ€è¦æ—¶ï¼Œåå¤ç›´æ¥ä½¿ç”¨ã€‚ 1234567&gt;&gt;&gt; from args import UpdativeArgs&gt;&gt;&gt; args = UpdativeArgs('10010', base=2)&gt;&gt;&gt; args(int)18&gt;&gt;&gt; args.update(base=3)&gt;&gt;&gt; args(int)84 Args ç±»æ›´å¯ä»¥ç®€åŒ–å…¶å®ƒå‡½æ•°çš„å®šä¹‰ï¼Œä¾‹å¦‚ä¸‹é¢çš„åˆ›å»ºæ•°æ®åº“æ¸¸æ ‡ ï¼ˆSee PEP 249 â€“ Python Database API Specification v2.0ï¼‰çš„ä»£ç ç‰‡æ®µ 123456789101112131415161718192021222324252627282930from args import Argsfrom contextlib import closing, contextmanager@contextmanagerdef ctx_cursor( connect, con_args, cur_args = (), do_tsac: bool = False, ): &quot;&quot;&quot;åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œè¿”å›æ•°æ®åº“çš„æ¸¸æ ‡å¯¹è±¡ :param connect: åˆ›å»ºè¿æ¥çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ•°æ®åº“è¿æ¥å¯¹è±¡ :param con_args: åˆ›å»ºè¿æ¥å¯¹è±¡æ—¶çš„å‚æ•° :param cur_args: åˆ›å»ºæ¸¸æ ‡å¯¹è±¡æ—¶çš„å‚æ•° :param do_tsac: æ˜¯å¦æäº¤äº‹åŠ¡ :return: ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œè¿”å›æ¸¸æ ‡å¯¹è±¡ &quot;&quot;&quot; with closing(Args.call(connect, con_args)) as con: with closing(Args.call(con.cursor, cur_args)) as cur: if do_tsac: try: yield cur con.commit() except BaseException: con.rollback() raise else: yield cur ç¤ºä¾‹ï¼šåˆ›å»ºå’Œä½¿ç”¨ä¸€ä¸ª sqlite æ¸¸æ ‡ 12345&gt;&gt;&gt; import sqlite3&gt;&gt;&gt; with ctx_cursor(... sqlite3.connect, &quot;:memory:&quot;... ) as cur: ... ... ç¤ºä¾‹ï¼šåˆ›å»ºå’Œä½¿ç”¨ä¸€ä¸ª mysql æ¸¸æ ‡ 123456789101112&gt;&gt;&gt; import pymysql&gt;&gt;&gt; from args import Args&gt;&gt;&gt; with ctx_cursor(... pymysql.connect,... Args(... user=&quot;root&quot;,... password=&quot;12345&quot;,... database=&quot;test&quot;,... ),... Args(pymysql.cursors.DictCursor),... ) as cur:... ... ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/6cd16d7aa29adfc852c3f3d9a39c0b81 æ–‡ä»¶åç§°æ˜¯ args.pyï¼ŒPython å®ç°ä»£ç å¦‚ä¸‹ï¼š args.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266#!/usr/bin/env python3# coding: utf-8&quot;&quot;&quot;This module provides several classes, which are used to collect some arguments at one time and then use them repeatedly later.&quot;&quot;&quot;__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1)__all__ = [&quot;Args&quot;, &quot;UpdativeArgs&quot;]from copy import copyfrom typing import Any, Callable, Generic, TypeVarT = TypeVar(&quot;T&quot;)P = TypeVar(&quot;P&quot;, bound=tuple)K = TypeVar(&quot;K&quot;, bound=dict)class Args(Generic[T, P]): &quot;&quot;&quot;Takes some positional arguments and keyword arguments, and put them into an instance, which can be used repeatedly every next time. Fields:: self.pargs: the collected positional arguments self.kargs: the collected keyword arguments &quot;&quot;&quot; __slots__ = (&quot;pargs&quot;, &quot;kargs&quot;) def __init__(self, /, *pargs, **kargs): self.pargs: P = pargs self.kargs: K = kargs def __call__(self, /, func: Callable[..., T]) -&gt; T: &quot;&quot;&quot;Pass in the collected positional arguments and keyword arguments when calling the callable `func`.&quot;&quot;&quot; return func(*self.pargs, **self.kargs) def __copy__(self, /): return type(self)(*self.pargs, **self.kargs) def __eq__(self, other): if isinstance(other, Args): return self.pargs == other.pargs and self.kargs == other.kargs return False def __iter__(self, /): return iter((self.pargs, self.kargs)) def __repr__(self): return &quot;%s(%s)&quot; % ( type(self).__qualname__, &quot;, &quot;.join(( *map(repr, self.pargs), *(&quot;%s=%r&quot; % e for e in self.kargs.items()), )), ) @classmethod def call(cls, /, func: Callable[..., T], args: Any = ()) -&gt; T: &quot;&quot;&quot;Call the callable `func` and pass in the arguments `args`. The actual behavior as below: if isinstance(args, Args): return args(func) elif type(args) is tuple: return func(*args) elif type(args) is dict: return func(**args) return func(args) &quot;&quot;&quot; if isinstance(args, Args): return args(func) type_ = type(args) if type_ is tuple: return func(*args) elif type_ is dict: return func(**args) return func(args)class UpdativeArgs(Args): &quot;&quot;&quot;Takes some positional arguments and keyword arguments, and put them into an instance, which can be used repeatedly every next time. This derived class provides some methods to update the collected arguments. Fields:: self.pargs: the collected positional arguments self.kargs: the collected keyword arguments &quot;&quot;&quot; __slots__ = (&quot;pargs&quot;, &quot;kargs&quot;) def extend(self, /, *pargs, **kargs): &quot;&quot;&quot;Extend the collected arguments. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.extend(7, 8, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(1, 2, 3, 7, 8, x=4, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 True &quot;&quot;&quot; if pargs: self.pargs += pargs if kargs: kargs0 = self.kargs kargs0.update( (k, kargs[k]) for k in kargs.keys() - kargs0.keys() ) return self def copy_extend(self, /, *pargs, **kargs): &quot;&quot;&quot;Extend the collected arguments in a copied instance. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.copy_extend(7, 8, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(1, 2, 3, 7, 8, x=4, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 False &quot;&quot;&quot; return copy(self).extend(*pargs, **kargs) def prepend(self, /, *pargs, **kargs): &quot;&quot;&quot;Prepend the collected arguments. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.prepend(7, 8, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(7, 8, 1, 2, 3, x=9, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 True &quot;&quot;&quot; if pargs: self.pargs = pargs + self.pargs if kargs: self.kargs.update(kargs) return self def copy_prepend(self, /, *pargs, **kargs): &quot;&quot;&quot;Prepend the collected arguments in a copied instance. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.copy_prepend(7, 8, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(7, 8, 1, 2, 3, x=9, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 False &quot;&quot;&quot; return copy(self).prepend(*pargs, **kargs) def update(self, /, *pargs, **kargs): &quot;&quot;&quot;Update the collected arguments. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.update(7, 8, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(7, 8, 3, x=9, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 True &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args.update(7, 8, 10, 11, x=9, r=0) UpdativeArgs(7, 8, 10, 11, x=9, y=5, z=6, r=0) &quot;&quot;&quot; if pargs: n = len(pargs) - len(self.pargs) if n &gt;= 0: self.pargs = pargs else: self.pargs = pargs + self.pargs[n:] if kargs: self.kargs.update(kargs) return self def copy_update(self, /, *pargs, **kargs): &quot;&quot;&quot;Update the collected arguments in a copied instance. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.copy_update(7, 8, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(7, 8, 3, x=9, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 False Idempotence &gt;&gt;&gt; args3 = args2.copy_update(7, 8, x=9, r=0) &gt;&gt;&gt; args2 == args3 True Idempotence &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.copy_update(7, 8, 10, 11, x=9, r=0) &gt;&gt;&gt; args3 = args2.copy_update(7, 8, 10, 11, x=9, r=0) &gt;&gt;&gt; args2 == args3 True &quot;&quot;&quot; return copy(self).update(*pargs, **kargs) def update_extend(self, /, *pargs, **kargs): &quot;&quot;&quot;Update and entend the collected arguments. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.update_extend(7, 8, 10, 11, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(1, 2, 3, 11, x=4, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 True &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args.update_extend(7, 8, x=9, r=0) UpdativeArgs(1, 2, 3, x=4, y=5, z=6, r=0) &quot;&quot;&quot; if pargs: n = len(self.pargs) - len(pargs) if n &lt; 0: self.pargs += pargs[n:] if kargs: kargs0 = self.kargs kargs0.update( (k, kargs[k]) for k in kargs.keys() - kargs0.keys() ) return self def copy_update_extend(self, /, *pargs, **kargs): &quot;&quot;&quot;Update and extend the collected arguments in a copied instance. Examples:: &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.copy_update_extend(7, 8, 10, 11, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(1, 2, 3, 11, x=4, y=5, z=6, r=0) &gt;&gt;&gt; args is args2 False Idempotence &gt;&gt;&gt; args3 = args2.copy_update_extend(7, 8, 10, 11, x=9, r=0) &gt;&gt;&gt; args2 == args3 True Idempotence &gt;&gt;&gt; args = UpdativeArgs(1, 2, 3, x=4, y=5, z=6) &gt;&gt;&gt; args2 = args.copy_update_extend(7, 8, x=9, r=0) &gt;&gt;&gt; args2 UpdativeArgs(1, 2, 3, x=4, y=5, z=6, r=0) &gt;&gt;&gt; args3 = args2.copy_update_extend(7, 8, x=9, r=0) &gt;&gt;&gt; args2 == args3 True &quot;&quot;&quot; return copy(self).update_extend(*pargs, **kargs)if __name__ == &quot;__main__&quot;: import doctest doctest.testmod()","link":"/2022/09/01/12.Python%E6%A8%A1%E5%9D%97-%E6%89%93%E5%8C%85%E5%A4%9A%E4%B8%AA%E5%8F%82%E6%95%B0%E4%BA%8E%E4%B8%80%E4%BD%93/"},{"title":"åœ¨Linux&#x2F;MacOSXä¸Šéƒ¨ç½²AListå’Œclouddrive","text":"èƒŒæ™¯ AList æ˜¯ä¸€ä¸ªå¼€æºçš„ç½‘ç›˜æ–‡ä»¶ç½—åˆ—ç¨‹åºï¼Œå®ƒæ”¯æŒæ•°åä¸ªç½‘ç›˜çš„æŒ‚è½½ï¼Œå¹¶æä¾› WebDav çš„è®¿é—®æ–¹å¼ã€‚ clouddrive æ˜¯ä¸€ä¸ªé—­æºçš„ç½‘ç›˜æ–‡ä»¶ç½—åˆ—ç¨‹åºï¼Œè™½ç„¶å®ƒåªæ”¯æŒå‡ ä¸ªç½‘ç›˜ï¼Œä½†æ˜¯ä¹Ÿæœ‰ç‹¬ç‰¹çš„åŠŸèƒ½ã€‚å®ƒä¹Ÿæ”¯æŒ WebDavã€‚ æˆ‘ç¼–å†™äº† 2 ä¸ªè„šæœ¬ï¼šdeploy-alist.sh å¯ç”¨äºä¸€é”®éƒ¨ç½² AListï¼Œdeploy-clouddrive.sh å¯ç”¨äºä¸€é”®éƒ¨ç½² clouddriveã€‚æ‚¨çš„è®¾å¤‡ä¸Šå¯èƒ½æœ‰ä¸€ä¸ªåº”ç”¨å•†åº—ï¼Œæœ¬èº«å°±æä¾›äº†å®‰è£… alist æˆ– clouddriveï¼Œæˆ–è€…ä½ ä½¿ç”¨äº†å®˜æ–¹æä¾›çš„ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆä½†æ”¯æŒçš„å¹³å°æœ‰é™ï¼‰ï¼Œæˆ–è€…ä½ ç”¨ docker æ¥éƒ¨ç½²ï¼Œç­‰ç­‰ï¼Œè¿™æ ·ä½ å¯èƒ½ç”¨ä¸åˆ°æˆ‘çš„è„šæœ¬ã€‚ä¸è¿‡å¦‚æœä½ çš„å¹³å°ä¸Šæ‰¾ä¸åˆ°å¯ç”¨çš„ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆï¼Œä¸å¦‚å°è¯•ä¸€ä¸‹æˆ‘çš„åŠæ³•å§ğŸ˜‚ã€‚ ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/e8e520de651e6375dad552b5a761902f 1. éƒ¨ç½² AListæ–‡ä»¶åç§°æ˜¯ deploy-alist.shï¼Œæ‚¨å¯ä»¥ç”¨ bash æˆ– zsh è¿è¡Œä»£ç ï¼Œç”±äºç”¨åˆ°äº†ä¸€äº›è¾ƒæ–°çš„è¯­æ³•ï¼Œè¯·ç¡®ä¿ä½ çš„è§£é‡Šå™¨ç‰ˆæœ¬ä¸èƒ½å¤ªä½ï¼š 1bash -c &quot;$(wget -q -O - https://gist.githubusercontent.com/ChenyangGao/e8e520de651e6375dad552b5a761902f/raw/deploy-alist.sh)&quot; 2. éƒ¨ç½² clouddrive2æ–‡ä»¶åç§°æ˜¯ deploy-clouddrive.shï¼Œæ‚¨å¯ä»¥ç”¨ bash æˆ– zsh è¿è¡Œä»£ç ï¼š 1bash -c &quot;$(wget -q -O - https://gist.githubusercontent.com/ChenyangGao/e8e520de651e6375dad552b5a761902f/raw/deploy-clouddrive.sh)&quot; 3. Termux ä¸­çš„è‡ªå¯åŠ¨è„šæœ¬ Termux æ˜¯ Android å¹³å°ä¸Šçš„ä¸€ä¸ªç»ˆç«¯æ¨¡æ‹Ÿå™¨å’Œå¼€å‘ç¯å¢ƒï¼Œç”±äºæ²¡æœ‰ç±»ä¼¼ systemd ä¹‹ç±»çš„è¿›ç¨‹ç®¡ç†å™¨ï¼Œæ‰€ä»¥æƒ³è¦è‡ªå¯åŠ¨éœ€è¦ä¸€äº›å…¶ä»–çš„åŠæ³•ã€‚ ä¸€ç§åŠæ³•æ˜¯ä½¿ç”¨ termux:bootï¼Œå¹¶æŒ‰ç…§æ–‡æ¡£ï¼Œç¼–å†™è„šæœ¬å¹¶æ”¾ç½®åˆ° ~/.termux/boot/ ç›®å½•ã€‚è™½ç„¶å¼€æœºåï¼ŒTermux ä¼šå¯åŠ¨ï¼Œè„šæœ¬ä¼šè¿è¡Œï¼Œä½†æ˜¯å¦‚æœå…³é—­ Termuxï¼Œè„šæœ¬ä¼šéšä¹‹å…³é—­ï¼Œå³ä½¿é‡å¯ Termuxï¼Œè„šæœ¬ä¹Ÿä¸ä¼šè¿è¡Œï¼Œå› ä¸ºè¿™åªåœ¨å¼€æœºæ—¶å¯åŠ¨ä¸€æ¬¡ã€‚ æˆ‘æä¾›å¦ä¸€ç§åŠæ³•ï¼Œä¸‹é¢æˆ‘æä¾›ä¸¤ä¸ªè„šæœ¬ alist.sh å’Œ clouddrive.shï¼Œå¯ä»¥åˆ†åˆ«å®ç°å¯¹ AList å’Œ clouddrive çš„å¯åŠ¨ã€åœæ­¢ã€é‡å¯ã€è¿›ç¨‹çŠ¶æ€æŸ¥çœ‹ã€å¼€å…³å¯åŠ¨é¡¹ï¼ˆé€šè¿‡åœ¨å½“å‰ shell çš„ rc æ–‡ä»¶ä¸­å†™å…¥ä¸€ä¸ªå¯åŠ¨å‘½ä»¤æ¥å®ç°ï¼‰ã€‚å½“ä½ å¼€äº†å¯åŠ¨é¡¹ï¼Œåˆ™æ‰“å¼€ Termux åå°±ä¼šå¼€å¯ AList æˆ– clouddriveï¼Œå¹¶ä¸”ä¼šæœ‰æ—¥å¿—æ–‡ä»¶ ~/alist.log å’Œ ~/clouddrive.logã€‚ AList çš„ shell å¯åŠ¨è„šæœ¬12wget -q https://gist.githubusercontent.com/ChenyangGao/e8e520de651e6375dad552b5a761902f/raw/alist.sh -O ~/alist.shchmod +x ~/alist.sh ç”¨æ³•å’Œä¾‹å­å¦‚ä¸‹ 123456789101112131415161718192021222324$ ~/alist.sh&gt;&gt;&gt; å¸®åŠ©ä¿¡æ¯start å¯åŠ¨ alistã€‚å¯æŒ‡å®š -d åå°è¿è¡Œã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”stop åœæ­¢ alistã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”restart é‡å¯ alistã€‚å¯æŒ‡å®š -d åå°è¿è¡Œã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”status æ˜¾ç¤º alist çš„è¿›ç¨‹ä¿¡æ¯ã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”log æ˜¾ç¤º alist çš„æ—¥å¿—ä¿¡æ¯ã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”enable æ‰“å¼€ç»ˆç«¯åè‡ªåŠ¨å¯åŠ¨ alistï¼Œå¯æŒ‡å®šä¸€ä¸ª rcfile çš„è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œå¦åˆ™è‡ªåŠ¨æ ¹æ®é»˜è®¤ shell æ¥ç¡®å®šã€‚ é€šè¿‡åœ¨é»˜è®¤ SHELL çš„ rcfile æ–‡ä»¶ä¸­å†™å…¥å¯åŠ¨å‘½ä»¤æ¥å®ç°ï¼Œæ—¥å¿—åœ¨ ~/alist.logã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”disable å»é™¤ enable æ³¨å†Œçš„å¯åŠ¨ï¼Œå¯æŒ‡å®šä¸€ä¸ª rcfile çš„è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œå¦åˆ™è‡ªåŠ¨æ ¹æ®é»˜è®¤ shell æ¥ç¡®å®šã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”startup ç­‰åŒäº enableã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”unstartup ç­‰åŒäº disableã€‚$ # å¼€å¯ alist éš Termux å¯åŠ¨$ ~/alist.sh enable$ # åå°è¿è¡Œ alist$ ~/alist.sh start -d AList ä¼´éš Termux å¯åŠ¨ç”±äº Termux çš„åŒ…ç®¡ç†å™¨å¯ç›´æ¥å®‰è£… AListï¼Œæ‰€ä»¥å¯ä»¥ç”¨ä¸‹é¢çš„è„šæœ¬å®ç°ä¼´éš Termux æ‰“å¼€åçš„è‡ªåŠ¨å¯åŠ¨ã€‚ 1bash -c &quot;$(wget -q -O - https://gist.githubusercontent.com/ChenyangGao/e8e520de651e6375dad552b5a761902f/raw/termux-init-alist.sh)&quot; æºç å¦‚ä¸‹ termux-init-alist.sh123456789101112131415161718#!/usr/bin/env bashecho &quot;Step 1: å®‰è£… AList&quot;apt updateapt install -y alist jq wgetecho &quot;Step 2: è®¾ç½®è‡ªå¯åŠ¨&quot;wget -q https://gist.githubusercontent.com/ChenyangGao/e8e520de651e6375dad552b5a761902f/raw/alist.sh -O ~/alist.shchmod +x ~/alist.sh~/alist.sh enable~/alist.sh start -decho &quot;Step 3: ä¿®æ”¹ admin çš„å¯†ç ä¸º 123456&quot;alist admin set 123456echo &quot;Step 4: å¯ç”¨ guest ç”¨æˆ·ï¼Œå…å¯†ç ã€å¯ç”¨ Webdavã€åªè¯»&quot;AlistToken=$(wget -q -O - --header=&quot;Content-Type: application/json&quot; --post-data='{&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;123456&quot;}' http://localhost:5244/api/auth/login | jq -r '.data.token')wget -q -O - --header=&quot;Content-Type: application/json&quot; --header &quot;Authorization: $AlistToken&quot; --post-data='{&quot;id&quot;: 2, &quot;username&quot;: &quot;guest&quot;, &quot;password&quot;: &quot;&quot;, &quot;role&quot;: 1, &quot;permission&quot;: 258, &quot;disabled&quot;: false}' http://localhost:5244/api/admin/user/update clouddrive çš„ shell å¯åŠ¨è„šæœ¬12wget -q https://gist.githubusercontent.com/ChenyangGao/e8e520de651e6375dad552b5a761902f/raw/clouddrive.sh -O ~/clouddrive.shchmod +x ~/clouddrive.sh ç”¨æ³•å’Œä¾‹å­å¦‚ä¸‹ 123456789101112131415161718192021222324$ ~/clouddrive.sh&gt;&gt;&gt; å¸®åŠ©ä¿¡æ¯start å¯åŠ¨ clouddriveã€‚å¯æŒ‡å®š -d åå°è¿è¡Œã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”stop åœæ­¢ clouddriveã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”restart é‡å¯ clouddriveã€‚å¯æŒ‡å®š -d åå°è¿è¡Œã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”status æ˜¾ç¤º clouddrive çš„è¿›ç¨‹ä¿¡æ¯ã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”log æ˜¾ç¤º clouddrive çš„æ—¥å¿—ä¿¡æ¯ã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”enable æ‰“å¼€ç»ˆç«¯åè‡ªåŠ¨å¯åŠ¨ clouddriveï¼Œå¯æŒ‡å®šä¸€ä¸ª rcfile çš„è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œå¦åˆ™è‡ªåŠ¨æ ¹æ®é»˜è®¤ shell æ¥ç¡®å®šã€‚ é€šè¿‡åœ¨é»˜è®¤ SHELL çš„ rcfile æ–‡ä»¶ä¸­å†™å…¥å¯åŠ¨å‘½ä»¤æ¥å®ç°ï¼Œæ—¥å¿—åœ¨ ~/clouddrive.logã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”disable å»é™¤ enable æ³¨å†Œçš„å¯åŠ¨ï¼Œå¯æŒ‡å®šä¸€ä¸ª rcfile çš„è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œå¦åˆ™è‡ªåŠ¨æ ¹æ®é»˜è®¤ shell æ¥ç¡®å®šã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”startup ç­‰åŒäº enableã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”unstartup ç­‰åŒäº disableã€‚$ # å¼€å¯ clouddrive éš Termux å¯åŠ¨$ ~/clouddrive.sh enable$ # åå°è¿è¡Œ clouddrive$ ~/clouddrive.sh start -d æ‰©å±•çŸ¥è¯†OpenWrt æ˜¯ä¸€ä¸ªå¼€æºçš„åµŒå…¥å¼æ“ä½œç³»ç»Ÿï¼Œä¸“é—¨ä¸ºè·¯ç”±å™¨å’Œå…¶ä»–åµŒå…¥å¼è®¾å¤‡è®¾è®¡ã€‚å®ƒåŸºäº Linuxå†…æ ¸ï¼Œå¹¶æä¾›äº†ä¸€å¥—å®Œæ•´çš„ç³»ç»Ÿè½¯ä»¶åŒ…ï¼Œç”¨äºæ„å»ºå’Œå®šåˆ¶ç½‘ç»œè®¾å¤‡çš„å›ºä»¶ã€‚é€šè¿‡ OpenWrtï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰é…ç½®å’Œæ‰©å±•åŠŸèƒ½ï¼Œå¹¶äº«å—å¼ºå¤§çš„ç½‘ç»œç®¡ç†å’Œè·¯ç”±åŠŸèƒ½ã€‚é€šè¿‡ä¸€äº›é€‚å½“çš„æ‰©å±•ï¼ŒOpenWrt å¯ä»¥ä½œä¸º NAS ä½¿ç”¨ï¼Œä¸‹é¢æ˜¯ä¸€äº›å…¶å®ƒçš„åµŒå…¥å¼ NAS ç³»ç»Ÿï¼š openmediavaultï¼šä¸€ä¸ªåŸºäº Debian Linux çš„å¼€æº NAS ç³»ç»Ÿï¼Œè®¾è®¡ç”¨äºå®¶åº­å’Œå°å‹åŠå…¬å®¤ç¯å¢ƒã€‚å®ƒæä¾›äº†æ˜“äºä½¿ç”¨çš„ç®¡ç†ç•Œé¢å’Œä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¦‚æ–‡ä»¶å…±äº«ã€è¿œç¨‹è®¿é—®ã€å¤‡ä»½ã€åª’ä½“æœåŠ¡å™¨ç­‰ã€‚ FreeNASï¼šä¸€ä¸ªå…è´¹çš„ç½‘ç»œå­˜å‚¨æ“ä½œç³»ç»Ÿï¼ŒåŸºäº FreeBSDã€‚ç”¨äºæ„å»ºå’Œç®¡ç†ç½‘ç»œå­˜å‚¨æœåŠ¡å™¨ã€‚å®ƒæä¾›äº† ZFS æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®å…±äº«ã€å¤‡ä»½å’Œæ¢å¤ã€å¤šåª’ä½“æœåŠ¡ç­‰åŠŸèƒ½ï¼Œé€‚ç”¨äºå®¶åº­ç”¨æˆ·å’Œå°å‹ä¼ä¸šã€‚ XigmaNASï¼šå®ƒæ˜¯ FreeNAS é¡¹ç›®çš„å‰èº«ï¼Œä¹Ÿæ˜¯åŸºäº FreeBSD çš„ï¼Œæä¾›äº†ç±»ä¼¼ FreeNAS çš„åŠŸèƒ½ã€‚å†å²ä¸Šï¼Œå®ƒç»è¿‡äº†æ•°æ¬¡æ”¹åã€‚ OpenNASï¼šè¿™æ˜¯ä¸€ä¸ªåŸºäº OpenMediaVault çš„è¡ç”Ÿé¡¹ç›®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç½‘ç»œå­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œæä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½å’Œç•Œé¢ï¼Œå¯ä»¥ç”¨äºæ­å»ºå®¶åº­æˆ–å°å‹åŠå…¬å®¤çš„ç½‘ç»œå­˜å‚¨æœåŠ¡å™¨ã€‚ æˆ‘åœ¨æˆ‘çš„æ ‘è“æ´¾ä¸Šå®‰è£…äº† OpenWrtï¼Œå¹¶ä¿®æ”¹äº†ä¸€äº›ç½‘ç»œé…ç½®ï¼š HOWTO: OpenWrt on the Raspberry Pi 4 OpenWRT on Pi â€“ Light OS with Network Features Turn your Raspberry Pi into a WiFi Router using OpenWrt Raspberry Pi x OpenWRT Travel Router æ ‘è“æ´¾å…¥é—¨æŒ‡å—ï½œæ˜æ˜ç™½ç™½ç© Pi ç³»åˆ— æ ‘è“æ´¾å®éªŒå®¤ è¿™æ ·æˆ‘çš„æ ‘è“æ´¾å°±æ˜¯ä¸€ä¸ª NASï¼Œå†ç”¨ AList å’Œ clouddrive æŒ‚è½½å‡ ä¸ªç½‘ç›˜ï¼Œä½¿ç”¨ä½“éªŒéå¸¸ä»¤äººæ»¡æ„ã€‚","link":"/2023/08/02/14.%E5%9C%A8Linux:MacOSX%E4%B8%8A%E9%83%A8%E7%BD%B2AList%E5%92%8Cclouddrive/"},{"title":"CPythonä¸­å‡½æ•°çš„éæœ¬åœ°å˜é‡","text":"å‡½æ•°å¯¹è±¡çš„ç‰¹æ®Šå±æ€§ NOTE å½“å‰æµ‹è¯•çš„CPythonè§£é‡Šå™¨ç‰ˆæœ¬ä¸º 123&gt;&gt;&gt; print(__import__('sys').version)3.7.3 (default, Mar 27 2019, 16:54:48)[Clang 4.0.1 (tags/RELEASE_401/final)] ä»¥å½“å‰ç‰ˆæœ¬çš„è§£é‡Šå™¨ä¸‹æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œå¯å¾—åˆ°ä¸€ä¸ªMarkdownè¡¨æ ¼ 1234567891011121314151617def outer(freevar=None): def inner(a, b: int=1, *args, c: str='1', **kwds) -&gt; tuple: 'a test function' return freevar, a, b, args, c, kwds return innerfn = outer()print('attribute', 'type', 'setable', 'reason', sep=' | ')print(*'-'*4, sep=' | ')for attr in dir(fn): try: obj = getattr(fn, attr) setattr(fn, attr, obj) print('`%s`'%attr, type(obj), True, '', sep=' | ') except Exception as exc: print('`%s`'%attr, type(obj), False, '`%s`'%exc, sep=' | ') attribute type setable reason __annotations__ &lt;class â€˜dictâ€™&gt; True __call__ &lt;class â€˜method-wrapperâ€™&gt; True __class__ &lt;class â€˜typeâ€™&gt; False __class__ assignment only supported for heap types or ModuleType subclasses __closure__ &lt;class â€˜tupleâ€™&gt; False readonly attribute __code__ &lt;class â€˜codeâ€™&gt; True __defaults__ &lt;class â€˜tupleâ€™&gt; True __delattr__ &lt;class â€˜method-wrapperâ€™&gt; True __dict__ &lt;class â€˜dictâ€™&gt; True __dir__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True __doc__ &lt;class â€˜strâ€™&gt; True __eq__ &lt;class â€˜method-wrapperâ€™&gt; True __format__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True __ge__ &lt;class â€˜method-wrapperâ€™&gt; True __get__ &lt;class â€˜method-wrapperâ€™&gt; True __getattribute__ &lt;class â€˜method-wrapperâ€™&gt; True __globals__ &lt;class â€˜dictâ€™&gt; False readonly attribute __gt__ &lt;class â€˜method-wrapperâ€™&gt; True __hash__ &lt;class â€˜method-wrapperâ€™&gt; True __init__ &lt;class â€˜method-wrapperâ€™&gt; True __init_subclass__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True __kwdefaults__ &lt;class â€˜dictâ€™&gt; True __le__ &lt;class â€˜method-wrapperâ€™&gt; True __lt__ &lt;class â€˜method-wrapperâ€™&gt; True __module__ &lt;class â€˜strâ€™&gt; True __name__ &lt;class â€˜strâ€™&gt; True __ne__ &lt;class â€˜method-wrapperâ€™&gt; True __new__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True __qualname__ &lt;class â€˜strâ€™&gt; True __reduce__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True __reduce_ex__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True __repr__ &lt;class â€˜method-wrapperâ€™&gt; True __setattr__ &lt;class â€˜method-wrapperâ€™&gt; True __sizeof__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True __str__ &lt;class â€˜method-wrapperâ€™&gt; True __subclasshook__ &lt;class â€˜builtin_function_or_methodâ€™&gt; True å‘½åç©ºé—´å’Œä½œç”¨åŸŸ NOTE åœ¨ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œä½œç”¨åŸŸï¼ˆscopeï¼‰å°±æ˜¯ä¸€æ®µç¨‹åºä»£ç ä¸­æ‰€ç”¨åˆ°çš„åå­—è¢«é™åˆ¶çš„å¯ç”¨èŒƒå›´ã€‚æœ¬åœ°ï¼ˆå±€éƒ¨ï¼Œlocalï¼‰ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨å—æˆ–å‡½æ•°ä½“å†…ï¼Œè€Œå…¨å±€ï¼ˆglobalï¼‰ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨æœ¬åœ°ä»¥ä¸Šæœ€é•¿å¯è¾¾ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚æœ‰äº›ç¼–ç¨‹è¯­è¨€å…è®¸ï¼Œåœ¨æœ¬åœ°ä½œç”¨åŸŸå†…æ„å»ºä¸€ä¸ªæ›´ä½å±‚æ¬¡çš„æœ¬åœ°ä½œç”¨åŸŸï¼Œä½å±‚ä½œç”¨åŸŸè®¿é—®ä¸€ä¸ªéæœ¬åœ°çš„åå­—ï¼Œå®ƒå°±ä¼šåˆ°è¾ƒé«˜å±‚ä¸­å¯»æ‰¾ï¼Œé€å±‚å¾€ä¸Šï¼Œç›´åˆ°æ‰¾åˆ°æˆ–è€…æœ€ç»ˆä¸èƒ½æ‰¾åˆ°ã€‚ä½†æ˜¯è¿™ä¼šå¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼šå®šä¹‰åœ¨ä¸€ä¸ªå‡½æ•°outerå†…çš„å‡½æ•°innerè¢«ä½œä¸ºè¿”å›å€¼ï¼Œinnerä¸­å¼•ç”¨äº†innerä¸­æ²¡æœ‰è€Œåœ¨outerä¸­æœ‰çš„åå­—ï¼Œä¸ºäº†ä¿è¯ç†è®ºä¸Šçš„æŸäº›ä¸€è‡´æ€§ï¼Œæ˜¯å¦è¦æ±‚ç¼–è¯‘å™¨æä¾›ä¸€ç§è¢«ç§°ä¸ºé—­åŒ…ï¼ˆclosureï¼‰çš„æœºåˆ¶ï¼šouterä¸­çš„è¿™äº›åå­—åŠå…¶å¼•ç”¨åº”è¯¥ç»§ç»­ä¿ç•™åœ¨ä¸€ä¸ªå¯è¢«innerè®¿é—®ä½†å¯¹æ›´é«˜å±‚ä½œç”¨åŸŸéšè—ï¼ˆå¹¶éæŒ‡ç»å¯¹ä¸èƒ½è¢«æ›´é«˜å±‚å‘ç°ï¼‰ã€‚ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¿…å®šä¼šå¤„äºæŸä¸ªä½œç”¨åŸŸä¸­ï¼Œä½œç”¨åŸŸå…¶å®æ˜¯åœ¨ç»´æŠ¤ä¸€äº›åå­—å¯¹ä¸€äº›èµ„æºçš„å ç”¨å…³ç³»ã€‚ä¸€æ—¦ç¨‹åºç¦»å¼€æŸä¸ªä½œç”¨åŸŸï¼Œé‚£ä¹ˆæ³¨é”€å…¶ä¸­çš„åå­—å’Œé‡Šæ”¾å¯¹ç›¸å…³èµ„æºçš„å ç”¨å¾€å¾€è¢«è®¤ä¸ºæ˜¯å”¯ä¸€æ­£ç¡®çš„ã€‚åœ¨CPythonä¸­ï¼Œå‘½åç©ºé—´ï¼ˆnamespaceï¼‰å’Œä½œç”¨åŸŸè™½ç„¶è”ç³»ç´§å¯†ï¼Œä½†å´æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚åœ¨ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€Cä¸­ï¼Œå…¨å±€ä½œç”¨åŸŸå»ºç«‹åœ¨å †ä¸Šï¼Œè€Œæœ¬åœ°ä½œç”¨åŸŸå»ºç«‹åœ¨æ ˆä¸Šï¼Œä½†æ˜¯åœ¨Pythonä¸­ï¼Œå‘½åç©ºé—´å®é™…ä¸Šå°±æ˜¯ä¸ªå­—å…¸ï¼Œè€Œå›æ”¶èµ„æºåˆæ˜¯å¦ä¸€å›äº‹äº†ï¼Œä¸å†æ˜¯â€œé”€æ¯â€ï¼Œåªæ˜¯â€œè§£é™¤â€å¯¹èµ„æºçš„å¼•ç”¨å…³ç³»ã€‚å¯¹èµ„æºçš„ç®¡ç†åŸºäºå¦ä¸€å¥—æœºåˆ¶ï¼ˆå¼•ç”¨è®¡æ•°å’Œåƒåœ¾å›æ”¶ï¼‰ï¼Œå®ƒä»£ç†äº†èµ„æºçš„åˆ›å»ºå’Œé”€æ¯çš„æ“ä½œï¼Œå®ƒä¾é å»ºç«‹ç»Ÿè®¡ä¿¡æ¯æ¥å®ç°æœ‰æ•ˆçš„ç®¡ç†ã€‚ç›¸å…³çš„æƒ…å†µéå¸¸å¤æ‚ï¼Œä½†ç®€å•æ¥è¯´ï¼šæ›´æ–°å…¨å±€å‘½åç©ºé—´globals()ï¼Œä¼šæ”¹å˜æ¨¡å—çº§åˆ«ä½œç”¨åŸŸä¸­ç›¸åº”å˜é‡çš„å€¼ï¼Œä½†æ˜¯æ›´æ–°æœ¬åœ°å‘½åç©ºé—´locals()ï¼Œå…¶å®é™…æ•ˆæœè§†æ‰€å¤„æƒ…å†µä¼šæœ‰æ‰€ä¸åŒã€‚åœ¨å‡½æ•°å†…è¿˜å¯ä»¥æœ‰æœ¬åœ°ä½œç”¨åŸŸä¸€è¯´ï¼Œä½†æ¨¡å—çº§åˆ«è¿˜æ˜¯ä½äºä¼ ç»Ÿçš„å…¨å±€æ¦‚å¿µçš„ï¼Œåœ¨å…¶ä¸Šå°šæœ‰builtinsä¸€çº§ï¼Œè€Œä¸”è§£é™¤ä¸€ä¸ªæ¨¡å—å¯¹èµ„æºçš„å ç”¨å…³ç³»æ›´æ˜¯è½»è€Œæ˜“ä¸¾ã€‚å‘½åç©ºé—´ä¹Ÿå­˜åœ¨ä½çº§å¯¹é«˜çº§çš„é®ç›–ï¼Œè¿™åœ¨é¢å‘å¯¹è±¡ä¸­ç”šè‡³å¯ç”¨æ¥å®ç°å¤šæ€ï¼ˆpolymorphismï¼‰ã€‚ NOTE CPythonä¸­å¯¹åå­—çš„å¯»æ‰¾é¡ºåºï¼šlocals &gt; closure &gt; globals &gt; builtins 1. å…¨å±€å‘½åç©ºé—´å’Œæ¨¡å—ä½œç”¨åŸŸ æ›´æ–°å…¨å±€å‘½åç©ºé—´globals()ï¼Œä¼šåŒæ—¶æ›´æ–°æ¨¡å—ä½œç”¨åŸŸä¸­çš„å˜é‡ 1234&gt;&gt;&gt; val = 0&gt;&gt;&gt; globals()['val'] = 1&gt;&gt;&gt; val1 2. æ¨¡å—ä½œç”¨åŸŸä¸­çš„æœ¬åœ°å‘½åç©ºé—´ åœ¨æ¨¡å—ä½œç”¨åŸŸä¸­ï¼Œæœ¬åœ°å‘½åç©ºé—´locals()ç­‰åŒäºå…¨å±€å‘½åç©ºé—´globals() 123456&gt;&gt;&gt; locals() is globals()True&gt;&gt;&gt; val = 0&gt;&gt;&gt; locals()['val'] = 1&gt;&gt;&gt; val1 3. å‡½æ•°æœ¬åœ°ä½œç”¨åŸŸä¸­çš„æœ¬åœ°å‘½åç©ºé—´ åœ¨æœ¬åœ°ä½œç”¨åŸŸä¸­ï¼Œæœ¬åœ°å‘½åç©ºé—´locals()çš„æ›´æ–°å¹¶ä¸å½±å“æœ¬åœ°ä½œç”¨åŸŸä¸­å˜é‡çš„å€¼ï¼Œåä¹‹ä¸ç„¶ 1234def fn(): val = 0 locals()['val'] = 1 return val 12&gt;&gt;&gt; fn()0 12345def fn(): val = 0 print(locals()['val']) val = 1 print(locals()['val']) 123&gt;&gt;&gt; fn()01 æœ¬åœ°å‘½åç©ºé—´locals()åŒ…å«æœ¬åœ°ä½œç”¨åŸŸçš„åç§°å’Œè‡ªç”±å˜é‡ 12345678def outer(): nval = 0 def inner(): global gval nonlocal nval lval = 1 return locals() return inner 123&gt;&gt;&gt; gval = 0&gt;&gt;&gt; outer()() # âš ï¸ æ³¨æ„ç»“æœçš„é¡ºåº{'lval': 1, 'nval': 0} 4. æœ¬åœ°å‘½åç©ºé—´å’Œæœ¬åœ°ä½œç”¨åŸŸçš„æ›´æ–°å¯¹é—­åŒ…çš„å½±å“ å’Œåœ¨æœ¬åœ°ä½œç”¨åŸŸçš„èµ‹å€¼ä¸åŒï¼Œå¯¹æœ¬åœ°å‘½åç©ºé—´locals()çš„æ›´æ–°ï¼Œä¸èƒ½ä¸ºé—­åŒ…æ‰€ä¾¦æµ‹å’Œä½¿ç”¨ 1234567val = 0def outer(mapping): locals().update(mapping) def inner(): return val return inner 12&gt;&gt;&gt; outer(dict(val=1))()0 123456def outer(mapping): val = 0 locals().update(mapping) def inner(): return val return inner 12&gt;&gt;&gt; outer(dict(val=1))()0 å¹¶ä¸”åœ¨æœ¬åœ°ä½œç”¨åŸŸçš„èµ‹å€¼ï¼Œå¿…é¡»æ˜¯æ˜¾å¼çš„ï¼Œä½¿ç”¨execå’Œevalï¼ŒåŒæ ·åªä¼šæ›´æ–°ç›¸åº”çš„gloablså’Œlocals 123456def outer(mapping): for key in tuple(mapping): exec(f'{key}={key}', mapping, locals()) def inner(): return val return inner 12&gt;&gt;&gt; outer(dict(val=1))()NameError: name 'val' is not defined 123456def outer(mapping): for key in tuple(mapping): eval(compile(f'{key}={key}', '', 'single'), mapping, locals()) def inner(): return val return inner 12&gt;&gt;&gt; outer(dict(val=1))()NameError: name 'val' is not defined æ€»è€Œè¨€ä¹‹ï¼Œç¼–ç¨‹è¯­è¨€ä½œä¸ºç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨çš„é…ç½®æ–‡ä»¶ï¼Œç¼–ç¨‹è¯­è¨€çš„è¡Œä¸ºä¼šå—åˆ°è§£é‡Šå™¨æˆ–ç¼–è¯‘å™¨å®ç°æ–¹å¼çš„é™åˆ¶ã€‚åœ¨CPythonçš„å®ç°ä¸­ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯è®¤ä¸ºï¼Œæœ¬åœ°ä½œç”¨åŸŸæ˜¯é™æ€çš„ï¼Œæœ¬åœ°å‘½åç©ºé—´æ˜¯åŠ¨æ€çš„ï¼Œå¯¹æœ¬åœ°ä½œç”¨åŸŸæ›´æ–°çš„è¿‡ç¨‹ï¼Œåœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œè€Œåœ¨è¿è¡Œæ—¶æ›´æ–°æœ¬åœ°å‘½åç©ºé—´å’ŒåŠ¨æ€ç¼–è¯‘ä»£ç æ‰§è¡Œï¼Œåªä¼šå½±å“ä¸€äº›åŠ¨æ€çš„å±€é¢ã€‚ å‡½æ•°åˆ©ç”¨ç¼“å­˜çš„ç ”ç©¶ NOTE ä¸€èˆ¬åœ°è®²ï¼Œç³»ç»ŸAå’Œç³»ç»ŸBä¹‹é—´æœ‰é€šä¿¡ï¼ŒBå¯å­˜å‚¨Aå‘é€è¿‡æ¥çš„æ•°æ®ï¼Œå¹¶ä¸”å½“Aç´¢è¦æ—¶å¯åŸæ ·è¿”å›ï¼Œå°±èƒ½ç”¨Bæä¾›Açš„ç¼“å­˜éœ€æ±‚ã€‚æ— è®ºAç”¨ä»€ä¹ˆæ–¹å¼å»è®¿é—®Bï¼Œå®ƒä»¬ä¹‹é—´çš„è¿ä½œç€æ€æ ·çš„é€šä¿¡åè®®ï¼Œæ˜¯æœ¬åœ°è¿˜æ˜¯é€šè¿‡ç½‘ç»œã€‚ç”šè‡³Bå¯ä»¥æ˜¯Açš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…Aå’ŒBéƒ½æ˜¯æŸä¸ªç³»ç»ŸCçš„ä¸€éƒ¨åˆ†ï¼ŒAå€ŸåŠ©äº†æŸäº›åŸºç¡€è®¾æ–½å¯¹Bè¿›è¡Œäº†æ“ä½œï¼Œä¾‹å¦‚Bæ˜¯æŸä¸ªå¯è¯»å†™å­˜å‚¨å™¨ã€å®ƒçš„é©±åŠ¨ç¨‹åºæˆ–è€…åœ¨å­˜å‚¨å™¨ä¸Šæ„é€ çš„å®¹å™¨ï¼ˆcontainerï¼‰æ•°æ®ç»“æ„å’Œç›¸å…³å¤„ç†æ–¹æ³•é›†åˆï¼Œå°±ç®—è¿™ä¸ªå­˜å‚¨å™¨æˆ–æ•°æ®ç»“æ„åœ¨æ•°æ®å†™å…¥åå°±ä¸å¯æ›´æ”¹ã€‚ä¸€èˆ¬çš„ï¼Œå½“æˆ‘ä»¬åœ¨è¯´ç¼“å­˜æ—¶ï¼Œå…¶å®æ˜¯è¯´ï¼šä»¥ä»»æ„æ–¹å¼ï¼ŒæŠŠæ•°æ®å­˜å‚¨åœ¨å®¹å™¨ä¸­ï¼Œéœ€è¦çš„æ—¶å€™å°±ä»å®¹å™¨ä¸­è·å–ã€‚è™½ç„¶å¹¶ä¸è§„å®šä½¿ç”¨æ¬¡æ•°ï¼Œä½†åˆç†çš„ç­–ç•¥æ˜¯è‡³å°‘ä½¿ç”¨åˆ°1æ¬¡ï¼ŒğŸš« ä½¿ç”¨0æ¬¡çš„ä¸åº”ç¼“å­˜ã€‚å®è´¨ä¸Šï¼Œç¼“å­˜å”¯ä¸€é—®é¢˜æ˜¯å­˜å‚¨å’Œè®¿é—®ï¼Œå…¶å®ƒé—®é¢˜éƒ½æ˜¯é™„åŠ çš„ã€‚æ‰§è¡Œä¸€æ¬¡æ“ä½œçš„ç»“æœè¢«åç»­å¤šæ¬¡ä½¿ç”¨éœ€æ±‚ï¼Œå°±æ˜¯ä¸šåŠ¡é—®é¢˜å¯¹ç¼“å­˜çš„é™„åŠ é—®é¢˜ï¼šæŠŠæŸä¸ªæ“ä½œçš„ç»“æœå­˜å‚¨èµ·æ¥ï¼Œåœ¨ä»¥åéœ€è¦ç”¨åˆ°æ—¶ç›´æ¥è¿”å›ç›¸åº”ç»“æœï¼Œè€Œä¸æ˜¯å†æ¬¡æ‰§è¡Œæ“ä½œç„¶åæŠŠç»“æœè¿”å›ã€‚ä½†ä¸€ä¸ªæ“ä½œï¼Œå®ƒå¯èƒ½ï¼šå¯è¿›ä¸€æ­¥ç»†åˆ†ï¼Œæ“ä½œçš„è¿‡ç¨‹ä¼šæ”¹å˜ä¸€äº›å¯¹è±¡çš„æ•°æ®ï¼Œå¤šæ¬¡æ‰§è¡Œçš„ç»“æœä¸åŒã€‚ç¼“å­˜åªæ˜¯æŠŠç»“æœå­˜å‚¨èµ·æ¥ï¼Œä½•æ—¶æ›´æ–°ã€ä½•æ—¶å¤±æ•ˆå–å†³äºç°å®è€ƒè™‘å’Œç¨‹åºå®ç°ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ç¼“å­˜æ¥è‡ªåŠ¨å¤„ç†å…¶å®ƒé—®é¢˜ï¼Œåªè¦é™„åŠ ç›¸å…³çš„å¤„ç†é€»è¾‘å³å¯ã€‚ NOTE è®¨è®ºä¸€ä¸ªç‰¹æ®Šæƒ…å½¢ï¼šå‡è®¾å‡½æ•°fnéœ€è¦å¼•ç”¨æŸä¸ªæ•°æ®ï¼Œå¹¶ä¸”å¸Œæœ›èƒ½åœ¨å¤šæ¬¡è°ƒç”¨é—´æŒç»­ã€‚é€šå¸¸çš„åšæ³•æ˜¯ï¼Œåœ¨ä¸€ä¸ªæ‰€å±çš„é«˜å±‚å‘½åç©ºé—´æˆ–ä½œç”¨åŸŸä¸­æœ‰åç§°ç»‘å®šäº†è¿™ä¸ªå¼•ç”¨æˆ–è€…è¿™ä¸ªåç§°æ‰€å¼•ç”¨çš„å®¹å™¨ç›´æ¥æˆ–é—´æ¥æŒæœ‰è¿™ä¸ªå¼•ç”¨ï¼Œç„¶ååœ¨æœ¬åœ°æ— å†²çªçš„ç­–ç•¥ä¸‹ï¼Œä½¿ç”¨åç§°å’Œå¦å¤–çš„é—´æ¥æ“ä½œå»è·å–è¿™ä¸ªå¼•ç”¨ã€‚ä½¿ç”¨åç§°å»è·å–ï¼Œå¹¶ä¸ä¿è¯æ¯æ¬¡è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œä½†åœ¨è§„åˆ™çº¦æŸä¸‹ï¼Œå´æ˜¯å¯ä»¥åŠ ä»¥ä¿è¯ã€‚ 1. å®šä¹‰åœ¨å‡½æ•°ä½“ä¸­123def fn(): val = '&lt;time-consuming&gt;' return val NOTE å¦‚æœfn.__code__.co_constsåŒ…å«è¿™é¡¹è®¡ç®—ç»“æœï¼ˆè§£é‡Šå™¨éšå«åœ°ç¼“å­˜äº†è¿™é¡¹å¸¸é‡ï¼‰ï¼Œé‚£ä¹ˆæ„å‘³ç€è¿™é¡¹è®¡ç®—åªåœ¨å‡½æ•°ç¼–è¯‘æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè¿™ä¸ªæ–¹æ¡ˆå°±æ˜¯å¯å–çš„ æŸäº›å­—é¢é‡çš„ç®€å•è®¡ç®— å‡½æ•°(defå’Œlambda)å’Œç±»çš„å®šä¹‰ï¼ˆç¼“å­˜çš„æ˜¯codeå¯¹è±¡ï¼Œâš ï¸åœ¨å‡½æ•°å†…å®šä¹‰çš„ç±»ï¼Œç±»ä¼¼å‡½æ•°ï¼‰ âš ï¸ ç¼“å­˜å¾€å¾€æŒ‡çš„æ˜¯ä¸€æ¬¡æ“ä½œçš„ç»“æœè¢«å¤šæ¬¡ä½¿ç”¨ï¼ŒæŠŠæ•°æ®ä¿å­˜åœ¨æŸä¸ªåç§°ä¸Šï¼Œç„¶ååœ¨éœ€è¦ä½¿ç”¨çš„æ—¶é—´å’Œåœ°ç‚¹ï¼Œä½¿ç”¨åç§°è¿›è¡Œè®¿é—®ï¼Œé‚£ä¹ˆå¹¿ä¹‰ä¸Šè®²ï¼Œä¿å­˜åœ¨åç§°ä¸Šçš„å€¼ï¼Œåœ¨å…¶ä½œç”¨èŒƒå›´å†…ï¼Œéƒ½æ˜¯ç¼“å­˜çš„(cached)ã€‚ 1234567val = '&lt;expr&gt;'...# æ­¤å¤„æ˜¯`val`æˆ–è€…æŸä¸ª`val`çš„å¼•ç”¨è€…çš„ä½œç”¨èŒƒå›´# å¹¶åŒ…æ‹¬`val`ä½œä¸ºå‚æ•°ä¼ å…¥è¿™ä¸ªä½œç”¨èŒƒå›´çš„æƒ…å†µuse(val) âš ï¸ å‡½æ•°çš„åŸºæœ¬ä¿¡æ¯åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šï¼Œåœ¨æ‰§è¡Œæ—¶åˆå—åˆ°ä¼ å…¥å‚æ•°çš„å½±å“ã€‚æœ¬åœ°æœ‰å“ªäº›å˜é‡åï¼Œåœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šï¼Œæ ¹æ®æ˜¾å¼çš„èµ‹å€¼è¯­å¥ï¼Œä»¥åŠå‡½æ•°å’Œç±»çš„å®šä¹‰è¯­å¥æ¥åˆ¤å®šã€‚å‡½æ•°ç¼–è¯‘æ˜¯ä¸€ä¸ªå¤šé˜¶æ®µçš„è¿‡ç¨‹ï¼Œå¦‚æœå‡½æ•°bçš„å®šä¹‰åµŒå¥—åœ¨å‡½æ•°açš„å®šä¹‰å†…ï¼Œé‚£ä¹ˆåœ¨açš„æœ¬åœ°å˜é‡åä¿¡æ¯æ”¶é›†å®Œæˆåï¼Œbæ‰èƒ½è¢«ç¼–è¯‘ï¼Œä½†bçš„ç¼–è¯‘å®Œæˆæ—¶é—´ä¼šæ—©äºaï¼Œbçš„æŸäº›ä¸Šä¸‹æ–‡ä¿¡æ¯ä¹Ÿä¼šå–è‡ªaï¼Œä¾‹å¦‚è‡ªç”±å˜é‡ã€‚âš ï¸ æœ¬åœ°ä½œç”¨åŸŸä¸­å˜é‡çš„èµ‹å€¼ï¼ˆåŒ…æ‹¬å‡½æ•°å’Œç±»çš„å®šä¹‰ï¼‰æ˜¯ä¸€ä¸ªå¤æ‚æœºåˆ¶ï¼Œè¿œè¿œä¸æ˜¯ä¿®æ”¹æœ¬åœ°å‘½åç©ºé—´çš„åç§°å’Œå€¼çš„æ˜ å°„å…³ç³»é‚£ä¹ˆç®€å•ã€‚è¿™ç±»èµ‹å€¼ï¼Œä¼šå»ä¿®æ”¹å¤šä¸ªåœ°æ–¹ï¼Œæ ˆã€æœ¬åœ°å‘½åç©ºé—´ã€é—­åŒ…çš„è‡ªç”±å˜é‡å¯¹åº”cellå¯¹è±¡çš„cell_contentsç­‰ã€‚è¿™ç§å¤æ‚æ€§ä¹Ÿæ˜¯æœ‰æˆæœ¬çš„ï¼Œä¸»è¦å½±å“è¿è¡Œæ—¶çš„æ•ˆç‡ã€‚ 2. å®šä¹‰åœ¨å‡½æ•°æ‰€åœ¨çš„å…¨å±€å‘½åç©ºé—´ä¸­1234val = '&lt;time-consuming&gt;'def fn(): return val NOTE è¿™æ„å‘³ç€ä¼šåœ¨å…¨å±€å‘½åç©ºé—´ä¸­å»ºç«‹ä¸€ä¸ªåç§°ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¼šè®¤ä¸ºï¼Œè¿™æ˜¯å¯¹å…¨å±€å‘½åç©ºé—´çš„æ±¡æŸ“ï¼Œå°¤å…¶æ˜¯å½“è¿™ä¸ªåç§°åªè¢«æŸä¸€ä¸ªå‡½æ•°ç”¨åˆ°æ—¶ã€‚å‡½æ•°çš„__globals__å±æ€§å¼•ç”¨çš„å°±æ˜¯æ‰€åœ¨çš„å…¨å±€å‘½åç©ºé—´ï¼Œä¸è¿‡è¿™å¹¶ä¸æ„å‘³ç€è¿™ä¸ªå‘½åç©ºé—´ä¿ç•™ç€å¯¹å®ƒçš„å¼•ç”¨ã€‚å‡½æ•°çš„__globals__å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸è¿‡__code__å±æ€§æ˜¯å¯æ›¿æ¢çš„ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªåŠŸèƒ½ç›¸åŒçš„æ–°å‡½æ•°ï¼Œå¼•ç”¨æŸä¸ªdictå¯¹è±¡ï¼Œå……å½“å®ƒçš„å…¨å±€å‘½åç©ºé—´ã€‚ 1234567891011121314151617181920212223242526import functoolsfrom typing import Optional, TypeFunction = Type[type(lambda:None)]def redirect_globals( namespace: dict, fn: Optional[Function] = None) -&gt; Function: ''' åˆ©ç”¨ä¼ å…¥çš„å‘½åç©ºé—´`namespace`å’Œå‡½æ•°`fn`ï¼Œåˆ›å»ºä¸€ä¸ªå’Œ`fn`åŠŸèƒ½å’Œç­¾åå®Œå…¨ç›¸åŒçš„å‡½æ•°ï¼Œ ä½†æ˜¯__globals__å±æ€§ä¸º`namespace`çš„å‡½æ•°ï¼Œè¦æ±‚`fn.__closure__`æ²¡æœ‰è¢«è®¾ç½® :param namespace: ä½œä¸ºæ–°å‡½æ•°çš„å…¨å±€å‘½åç©ºé—´ :param fn: å‡½æ•° :return: å’Œ`fn`åŠŸèƒ½å’Œç­¾åå®Œå…¨ç›¸åŒï¼Œä½†å…¨å±€å‘½åç©ºé—´ä¸º`namespace`çš„å‡½æ•° ''' if fn is None: return functools.partial(redirect_globals, namespace) f = eval('lambda: None', namespace) # `fn`çš„è‡ªç”±å˜é‡ä¸ªæ•°ä¸ä¸º0æ—¶ï¼Œä¼šæŠ›å‡º`ValueError`ï¼Œæ„å‘³ç€å®ƒå…¶å®æ˜¯ä¸€ä¸ªé—­åŒ… # å¯æ ¹æ®`fn.__closure__`æˆ–`fn.__code__.co_freevars`åˆ¤æ–­ f.__code__ = fn.__code__ return functools.update_wrapper(f, fn) 3. åœ¨å‡½æ•°çš„å®šä¹‰å¤´ä¸­å®šä¹‰é»˜è®¤å‚æ•°12def fn(val='&lt;time-consuming&gt;'): return val NOTE åœ¨å®šä¹‰å¤´ä¸­å®šä¹‰ï¼Œåªåœ¨å‡½æ•°ç¼–è¯‘æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå…è®¸æ˜¯ä»»ä½•è¡¨è¾¾å¼ï¼Œæ— è®ºå®ƒæœ‰å¤šå¤æ‚ã€‚ä¸è¿‡è¿™ç§åšæ³•ä¹Ÿä¼šè¢«è®¤ä¸ºæ±¡æŸ“äº†å‡½æ•°çš„ç­¾åï¼Œå¯¹ä½¿ç”¨è€…é€ æˆå›°æƒ‘ï¼Œå³ä¾¿å‚æ•°åä»¥ä¸‹åˆ’çº¿å¼€å¤´ã€‚ NOTE åœ¨å‡½æ•°å¤´ä¸­å®šä¹‰é»˜è®¤å‚æ•°ï¼Œè‡ªåŠ¨è®¾ç½®äº†å®ƒçš„__defaults__å’Œ__kwdefaults__çš„å±æ€§ï¼Œå®ƒä»¬éƒ½æ˜¯å¯æ›¿æ¢çš„ï¼Œè€Œä¸”__kwdefaults__æ˜¯ä¸€ä¸ªæ™®é€šçš„å­—å…¸ï¼Œæœ¬èº«å°±æ˜¯å¯æ”¹çš„ã€‚åœ¨å‡½æ•°è°ƒç”¨æ—¶ï¼Œæ–°ä¼ å…¥çš„å‚æ•°ä¼šé®ç›–è¿™äº›é»˜è®¤å‚æ•°ï¼Œå…·ä½“è¡Œä¸ºå¦‚ä¸‹ï¼š 12345678910111213141516&gt;&gt;&gt; def fn(foo=1, bar=2, *, baz='0'): return foo, bar, baz&gt;&gt;&gt; fn.__defaults__(1, 2)&gt;&gt;&gt; fn.__kwdefaults__{'baz': '0'}&gt;&gt;&gt; fn.__defaults__ = (1, 2, 3)&gt;&gt;&gt; fn.__defaults__['baz'] = 'inf'&gt;&gt;&gt; fn()(2, 3, 'inf')&gt;&gt;&gt; fn(1, 2, baz=3)(1, 2, 3)&gt;&gt;&gt; fn.__defaults__ = (0,)&gt;&gt;&gt; fn()Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;TypeError: fn() missing 1 required positional argument: 'foo' âœ åœ¨å®šä¹‰å¤´ä¸Šçš„å‚æ•°åç§°ï¼Œæ˜¯å‡½æ•°æœ¬åœ°çš„ï¼Œä¼šè®¡å…¥fn.__code__.co_nlocalså’Œfn.__code__.co_varnamesä¸­ï¼Œä½†ä¸ä¼šè®¡å…¥fn.__code__.co_constsä¸­ã€‚ä½ç½®å‚æ•°è®¡å…¥fn.__code__.co_argcountï¼Œä½†å¯å˜é•¿åº¦å‚æ•°ä¸è®¡å…¥ï¼Œä¾‹å¦‚*argsã€‚__defaults__å’Œ__kwdefaults__éƒ½æ˜¯å®¹å™¨ï¼Œè¿™æ˜¯è§£é‡Šå™¨çš„è‡ªåŠ¨ç¼“å­˜ç­–ç•¥ï¼Œç¼–è¯‘å‡½æ•°é™¤äº†ç”Ÿæˆæœºå™¨ï¼ˆä¾‹å¦‚PVMï¼‰çš„å­—èŠ‚ç ï¼Œè¿˜æœ‰æ”¶é›†ä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯ç»‘å®šåˆ°å‡½æ•°å¯¹è±¡çš„è¿‡ç¨‹ã€‚ 4. é—­åŒ…12345678def outer(): val = '&lt;time-consuming&gt;' def fn(): return val return fnfn = outer()# del outer NOTE å¦‚æœä½¿ç”¨é—­åŒ…å­˜ç²¹æ˜¯ä¸ºäº†ä¸æ±¡æŸ“å…¨å±€å‘½åç©ºé—´ï¼Œé‚£ä¹ˆå¤–å±‚å‡½æ•°ä½¿ç”¨ä¸€æ¬¡ï¼ŒæŠŠå®ƒçš„è¿”å›å€¼ç»‘å®šåˆ°ä¸€ä¸ªå˜é‡åï¼Œå°±å¯ä»¥åˆ é™¤äº†ã€‚åœ¨Pythonä¸­ï¼Œä½¿ç”¨def(ä¹ŸåŒ…æ‹¬async defç­‰defè¡ç”Ÿ)å®šä¹‰å‡½æ•°çš„æ„é€ è¢«è®¤ä¸ºæ˜¯è¯­å¥è€Œéè¡¨è¾¾å¼ï¼Œç”¨lambdaå®šä¹‰å‡½æ•°çš„æ„é€ è™½ç„¶æ˜¯è¡¨è¾¾å¼ï¼Œä½†æ˜¯å®šä¹‰ä½“ä¸­åªå…è®¸ç”¨ä¸”åªç”¨1ä¸ªè¡¨è¾¾å¼ï¼Œè¿ç”¨è¿™ç§æŠ€æœ¯å°±å¿…é¡»å†™ä¸€äº›å†—ä½™çš„ä»£ç ã€‚JavaScriptçš„ç”¨æˆ·ç¬‘äº†ğŸ˜„ï¼Œå› ä¸ºJavaScriptä¸­å‡ ä¹æ‰€æœ‰ç»“æ„éƒ½æ˜¯è¡¨è¾¾å¼ï¼Œæ„å‘³ç€æœ‰è¿”å›å€¼ï¼Œè¿™ç§æ€§è´¨å¯è°“awesomeã€‚ 1234fn = (function(){ val = '&lt;time-consuming&gt;'; return () =&gt; val;})() Pythonçš„å‡½æ•°ï¼Œä¹Ÿæœ‰ä¸€ä¸ªè®¾è®¡é—®é¢˜ï¼Œå°±æ˜¯å®ƒä»¬çš„__closure__å±æ€§æ˜¯åªè¯»çš„ã€‚è¿™å¯ä»¥ç†è§£ï¼Œå› ä¸º__closure__å®é™…ä¸Šå’Œ__code__.co_freevarså­˜åœ¨å…³ç³»ï¼Œå³ä¾¿å‡½æ•°çš„__code__å±æ€§å¯è¢«æ›¿æ¢ï¼Œä½†ä¹Ÿè¦å’Œ__closure__å±æ€§åè°ƒï¼Œå³å¹¶éæ‰€æœ‰çš„æ›¿æ¢éƒ½èƒ½è¢«æ¥å—ã€‚å¦‚æœæƒ³æ„é€ ä¸€ä¸ªåªæ˜¯__closure__å±æ€§ä¸åŒï¼ŒåŠŸèƒ½ç›¸åŒçš„å‡½æ•°ï¼Œå…¶å®æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚ 1234567891011121314151617181920212223242526272829303132import functoolsimport inspectfrom typing import Optional, Type, MappingFunction = Type[type(lambda:None)]def use_closure( namespace: Mapping, fn: Optional[Function] = None) -&gt; Function: ''' åˆ©ç”¨ä¼ å…¥çš„å‘½åç©ºé—´`namespace`å’Œå‡½æ•°`fn`ï¼Œåˆ›å»ºä¸€ä¸ªå’Œ`fn`åŠŸèƒ½å’Œç­¾åå®Œå…¨ç›¸åŒçš„å‡½æ•°ï¼Œ ä½†æ˜¯__closure__å±æ€§å¯èƒ½æœ‰æ‰€ä¸åŒçš„å‡½æ•° :param namespace: `fn`ä¸­çš„éæœ¬åœ°å˜é‡ä¼šå°è¯•ä»è¿™ä¸ªæ˜ å°„ä¸­æå– :param fn: å‡½æ•° :return: å’Œ`fn`åŠŸèƒ½å’Œç­¾åå®Œå…¨ç›¸åŒï¼Œä½†å°è¯•ä»`namespace`è·å–ä¸€äº›å€¼æ¥æ„å»º__closure__ ''' if fn is None: return functools.partial(use_closure, mapping) assign = '\\n '.join(map('{0} = __[&quot;{0}&quot;]'.format, mapping)) # è·å–çš„æºä»£ç ï¼Œå¯èƒ½æ˜¯ä¸å¯ç”¨çš„ï¼Œæˆ–è€…å¯èƒ½è·å–ä¸åˆ°ï¼Œå¯¹äºlambdaå‡½æ•°ï¼Œè¿™æ ·çš„å¤„ç†ä¹Ÿæ˜¯ä¸é€‚åˆçš„ source = ' '.join(inspect.getsourcelines(fn)[0]) exec(f'''def outer(__): {assign} {source} return {fn.__name__}''', fn.__globals__, locals()) return functools.update_wrapper(locals()['outer'](mapping), fn) NOTE è™½ç„¶å‡½æ•°çš„__closure__å±æ€§ä¸å¯æ›´æ”¹ï¼Œä½†æ˜¯__closure__ä¸­æ‰€æœ‰cellå¯¹è±¡çš„cell_contentsæ˜¯å¯æ›´æ”¹çš„ã€‚å®Œå…¨å¯ä»¥ç²¾å¿ƒè®¾è®¡å‡½æ•°å®šä¹‰ï¼Œå…ˆå ç”¨å‡ ä¸ª__closure__ä½ç½®ï¼Œåœ¨ä»¥åéœ€è¦çš„æ—¶å€™è¿›è¡Œæ›´æ”¹ã€‚ 12345def outer(): val: int = 1 def inner(): return val return inner 12345678&gt;&gt;&gt; fn = outer()&gt;&gt;&gt; fn.__closure__(&lt;cell at 0x10e375d68: int object at 0x10e0105a0&gt;,)&gt;&gt;&gt; fn.__closure__[0].cell_contents = 'foo'&gt;&gt;&gt; fn.__closure__(&lt;cell at 0x10e375d68: str object at 0x10e3dd180&gt;,)&gt;&gt;&gt; fn()'foo' âœ ä½†æˆ‘å»ºè®®ä¸€ç§æ›´ä¸ºé›†ä¸­çš„ç®¡ç†åŠæ³•ï¼ŒæŠŠæ•°æ®ä¿å­˜åˆ°æ˜ å°„å®¹å™¨é‡Œé¢ï¼Œæ¨èdict 12345678def outer(): _closure_ns: dict = {} def inner(): if 'val' not in _closure_ns: _closure_ns['val'] = '&lt;time-consuming&gt;' val = _closure_ns['val'] return i return inner 5. nonlocalå’Œglobal NOTE nonlocalç”¨äºå£°æ˜æŸä¸ªåç§°æ˜¯è‡ªç”±å˜é‡ï¼ˆéæœ¬åœ°å’Œæ¨¡å—å±‚æ¬¡ï¼Œå±äºé—­åŒ…å±‚æ¬¡ä½œç”¨åŸŸï¼‰ï¼Œè€Œglobalç”¨äºå£°æ˜æŸä¸ªåç§°æ˜¯å…¨å±€å˜é‡ï¼ˆglobals()ï¼Œæ¨¡å—å±‚æ¬¡ä½œç”¨åŸŸï¼‰ã€‚å½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨ç»“æŸåï¼Œåœ¨æœ¬åœ°ä½œç”¨åŸŸå»ºç«‹çš„æ‰€æœ‰åç§°éƒ½ä¼šè¢«é”€æ¯ï¼ˆä½“ç°ä¸ºå®ƒä»¬æ‰€å¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è‡ªåŠ¨å‡å°ç›¸åº”æ•°ç›®ï¼‰ï¼ŒåŒ…æ‹¬ï¼š æœ¬åœ°èµ‹å€¼çš„åç§° å®šä¹‰å¤´ä¸­çš„åç§° nonlocalå’Œglobalå£°æ˜çš„åç§° 2.ä¸­çš„é»˜è®¤å‚æ•°å’Œ3.éƒ½æœ‰è‡ªåŠ¨ç¼“å­˜ï¼Œä½†æ¯æ¬¡æ‰§è¡Œæ—¶éƒ½éœ€è¦æ‹¿ç¼“å­˜æ‰§è¡Œèµ‹å€¼ï¼Œå¹¶ä¸ç­‰åŒäºä¼ ç»Ÿè¯­è¨€çš„é™æ€å˜é‡ã€‚å½“åœ¨æœ¬åœ°ç”¨èµ‹å€¼è¯­å¥ä¿®æ”¹è‡ªç”±å˜é‡çš„å€¼æ—¶ï¼Œä¼šè‡ªåŠ¨æ›´æ–°å‡½æ•°çš„__closure__ä¸­ç›¸åº”cellå¯¹è±¡çš„cell_contentçš„å€¼ï¼Œä¿®æ”¹å…¨å±€å˜é‡åˆ™æ—¶æ›´æ–°å¯¹åº”çš„æ¨¡å—å±‚æ¬¡å‘½åç©ºé—´globals()ä¸­çš„åç§°å’Œå€¼çš„æ˜ å°„å…³ç³»ã€‚ 6. å®¹å™¨ NOTE å®¹å™¨åŒ…æ‹¬ä½œç”¨åŸŸã€å‘½åç©ºé—´ã€ç‰©ç†å­˜å‚¨åŒºåŸŸåœ¨é€»è¾‘ä¸Šçš„ç®¡ç†æœºåˆ¶ç­‰ã€‚ç¼“å­˜åªæ˜¯å®¹å™¨çš„è¿ç”¨ä¹‹ä¸€ï¼Œå®¹å™¨ä¸»è¦çš„åŠŸèƒ½åœ¨äºå®ç°ç¨‹åºçš„åŠ¨æ€å’Œæ•°æ®çš„é›†ä¸­ï¼ˆæ›´ä¸€èˆ¬çš„è¯´ï¼Œæ•°æ®ç»“æ„å®ç°äº†æ•°æ®çš„ç§©åºï¼Œå®¹å™¨æ˜¯ä¸€ç±»æ•°æ®ç»“æ„ï¼‰ã€‚ NOTE åœ¨å‡½æ•°çš„å¤šæ¬¡è°ƒç”¨é—´æŒç»­å¼•ç”¨éœ€åˆ©ç”¨éæœ¬åœ°çš„å®¹å™¨ç¼“å­˜ï¼š å­˜å‚¨äºæ¯”å‡½æ•°æœ¬åœ°çš„æ›´é«˜å±‚çš„ä½œç”¨åŸŸæˆ–å‘½åç©ºé—´è€…å‡½æ•°çš„é»˜è®¤å‚æ•°ä¸­ï¼Œä¸€ä¸ªPythonå‡½æ•°ä¼šè‡ªåŠ¨å¯»æ‰¾æœªåœ¨æœ¬åœ°å£°æ˜è€Œéœ€è¦ç”¨åˆ°çš„åç§°ï¼› æˆ–è€…å­˜å‚¨äºä¸Šè¿°éæœ¬åœ°åç§°æ‰€å¼•ç”¨çš„å®¹å™¨ä¸­ã€‚ âœ å¦‚æœæŠŠç¼“å­˜çš„ä½¿ç”¨å°è£…åˆ°ä¸€æ¡æŒ‡ä»¤ä¸­ï¼Œä¾‹å¦‚å‡½æ•°ï¼Œå®ƒä»¥ä¸Šè¿°æ–¹å¼å¼•ç”¨äº†ä¸€ä¸ªå¤–éƒ¨å®¹å™¨ï¼Œç”±æ­¤å¯å®ç°æƒ°æ€§è®¡ç®—å’Œç¼“å­˜ã€‚å¯¹äºçº¯å‡½æ•°ï¼Œç›¸åŒçš„å‚æ•°ä¼ å…¥è¿”å›ç›¸åŒçš„ç»“æœï¼Œé‚£ä¹ˆæŠŠå…·ä½“å‚æ•°å’Œç›¸åº”è¿”å›å€¼å»ºç«‹å…³è”ï¼Œå­˜å…¥ä¸€ä¸ªæ˜ å°„å‹å®¹å™¨ä¸­ï¼Œé‚£ä¹ˆæ¯ä¸ªä¸åŒçš„å‚æ•°ä¼ å…¥åªéœ€è¦è®¡ç®—ä¸€æ¬¡ã€‚å¦‚æœè®©å‡½æ•°è‡ªåŠ¨ç»´æŠ¤ç¼“å­˜ï¼Œéœ€è¦å¢åŠ å¯¹å®¹å™¨çš„æŸ¥è¯¢å’Œå†™å…¥çš„æ“ä½œï¼ŒæŸ¥è¯¢æ˜¯æ¯æ¬¡æ‰§è¡Œï¼Œå†™å…¥æ‰§è¡Œä¸€æ¬¡ï¼ˆè‹¥æœ‰ç¼“å­˜åˆ é™¤åˆ™æ¬¡æ•°å–å†³äºç®—æ³•å’Œå®é™…æƒ…å†µï¼‰ï¼Œè¿™ä¹Ÿæ˜¯æœ‰æˆæœ¬çš„ï¼Œéœ€è¦å’Œè®¡ç®—çš„æˆæœ¬è¿›è¡Œæƒè¡¡å–èˆã€‚functools.lru_cacheå®ç°äº† Least Recently Used ç®—æ³•çš„ç¼“å­˜ç®¡ç†ï¼Œç¼“å­˜å¹¶éä¸€ç›´æœ‰æ•ˆï¼Œå½“é•¿æ—¶é—´ä¸ç”¨çš„ç¼“å­˜å°†ä¼šè¢«æ¸…ç†ã€‚è¿™ä¸æ˜¯å”¯ä¸€çš„ç¼“å­˜ç®¡ç†ç®—æ³•ï¼Œä¾‹å¦‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ LFU(Least Frequently Used) ç­‰ç®—æ³•ã€‚ âœ å‘½åç©ºé—´ï¼ˆnamespaceï¼‰å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ˜ å°„å‹çš„æ•°æ®ç»“æ„ï¼Œå°¤å…¶æ˜¯æ•£åˆ—è¡¨ï¼Œè¢«å¹¿æ³›ç”¨äºå……å½“å‘½åç©ºé—´ã€‚æ‰€è°“åç§°å®šä¹‰åœ¨æŸä¸ªå‘½åç©ºé—´ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨å‘½åç©ºé—´æœ‰è¿™ä¸ªåç§°çš„åç§°-å€¼å¯¹ï¼Œè®¿é—®æŸä¸ªå‘½åç©ºé—´ä¸­çš„æŸä¸ªåç§°ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªå‘½åç©ºé—´ä¸­è¿™ä¸ªåç§°çš„åç§°-å€¼å¯¹ä¸­çš„å€¼ã€‚é€šè¿‡åç§°ï¼Œè®¿é—®ä½œç”¨åŸŸæˆ–å‘½åç©ºé—´è¿™ç±»å®¹å™¨ä¸­çš„å€¼ï¼Œåªèƒ½ç¡®ä¿åç§°æ˜¯ç¡®å®šçš„ï¼Œè€Œå€¼è¦å–å¾—åæ‰èƒ½ç¡®å®šï¼Œæˆ–è€…è¯´ï¼Œå¦‚æœå€¼å‘ç”Ÿå˜æ›´é‚£ä¹ˆå–å¾—å€¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œè¿™è®©æƒ…å†µå˜å¾—ç›¸å½“çµæ´»å’Œå¤æ‚å¤šå˜ã€‚","link":"/2019/04/30/2.CPython%E4%B8%AD%E5%87%BD%E6%95%B0%E7%9A%84%E9%9D%9E%E6%9C%AC%E5%9C%B0%E5%8F%98%E9%87%8F/"},{"title":"åˆ©ç”¨å¼‚å¸¸å®ç°è¶Šçº§returnï¼ˆPythonå®ç°ï¼‰","text":"å¼‚å¸¸æ˜¯ä¸€ç±»æ¶ˆæ¯åœ¨é¢å‘å¯¹è±¡çš„ä¸–ç•Œé‡Œï¼Œå¯¹è±¡ä¹‹é—´çš„äº¤äº’è¡¨ç°ä¸ºæ¶ˆæ¯çš„ä¼ é€’ã€‚ å¼‚å¸¸ä¹Ÿæ˜¯ä¸€ç§æ¶ˆæ¯ï¼Œå°±æˆ‘çš„ç†è§£ï¼Œå¼‚å¸¸å¹¶éé”™è¯¯ï¼Œå®ƒç»å¸¸ç”¨æ¥è¡¨æ˜å­˜åœ¨é”™è¯¯ï¼Œä½†æœ¬è´¨ä¸Šå®ƒæ˜¯ä¸€ç±»ç‰¹æ®Šçš„æ¶ˆæ¯ï¼Œå…³è”ç€ä¸€ç§è·³å‡ºå±€éƒ¨èŒƒå›´çš„æœºåˆ¶ã€‚ It is my understanding that exceptions are not errors, and that they should only be used for exceptional conditions (e.g. I try to write a file into disk and there is no more space, or maybe I do not have permission), and not for flow control. â€”â€” Is it a good practice to use try-except-else in Python? è€Œåœ¨Pythonçš„ä¸–ç•Œé‡Œï¼Œæ‰€æœ‰å¼‚å¸¸éƒ½å¿…é¡»æ˜¯BaseExceptionçš„å­ç±»ã€‚æ‰€è°“å¼‚å¸¸æ˜¯æ¶ˆæ¯ï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡å¯ä»¥æºå¸¦ä¿¡æ¯ï¼Œæ•è·å¼‚å¸¸ï¼ˆå°±å¾—åˆ°äº†ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼‰æˆ–è€…ä¼ é€’ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œä½ å°±å¯ä»¥ä»è¿™ä¸ªå¼‚å¸¸å¯¹è±¡ä¸­æå–ä¿¡æ¯ã€‚è¿™ä¸ªæ¶ˆæ¯æœ‰æ—¶ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæŒ‡ä»¤æˆ–è€…ä¿¡å·ï¼Œå³ä¾¿ä»…ä»…åªæ˜¯æ•è·åˆ°äº†ä¸€ä¸ªç‰¹å®šç±»å‹çš„å¼‚å¸¸å¯¹è±¡ï¼Œä¾‹å¦‚ï¼ŒæŸä¸ªæ— é™å¾ªç¯ä¸­æœ‰ä¸€ä¸ªæ•è·å¼‚å¸¸çš„è¯­å¥ï¼Œå½“æ•è·åˆ°æŸä¸ªç±»å‹çš„å¼‚å¸¸å¯¹è±¡æ—¶ï¼Œå®ƒå°±è®¤ä¸ºæ¥æ”¶åˆ°äº†é€€å‡ºçš„ä¿¡å·ï¼Œå¿«é€Ÿã€ä¼˜é›…åœ°é€€å‡ºã€‚ å¤„ç†å¼‚å¸¸çš„è¯­å¥æ˜¯æµç¨‹æ§åˆ¶è¯­å¥å½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œå¼‚å¸¸ç°åœºæ‰€åœ¨çš„å±€éƒ¨èŒƒå›´å°±å°†è¢«ä¸¢å¼ƒï¼Œå¹¶ä¸”æŠŠç›¸å…³ç»Ÿè®¡ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ä¸­å‘ä¸Šå†’æ³¡ã€‚æ‰€è°“çš„å±€éƒ¨èŒƒå›´ï¼ŒåŒ…æ‹¬æ§åˆ¶è¯­å¥å†…éƒ¨ã€å±€éƒ¨ä½œç”¨åŸŸç­‰å±‚æ¬¡ç»“æ„ä¸­ã€‚å¦‚æœå®šä¹‰äº†ä¸€ä¸ªå…³äºå¼‚å¸¸çš„ç±»å‹ç³»ç»Ÿï¼Œé‚£ä¹ˆå°±ä¼šé…å¥—å®ç°å¯¹å¼‚å¸¸ç°åœºçš„ä¿¡æ¯æœé›†ç­–ç•¥ã€å¼‚å¸¸çš„å†’æ³¡æœºåˆ¶å’Œå¤„ç†å¼‚å¸¸çš„è¯­å¥ã€‚å¤„ç†å¼‚å¸¸çš„è¯­å¥ï¼Œä¸“é—¨é’ˆå¯¹å¼‚å¸¸æ¶ˆæ¯ï¼Œä¼šæ ¹æ®æ¡ä»¶æ¥åˆ¤å®šï¼Œå¯¹æŸä¸ªå¼‚å¸¸æ˜¯æ”¾è¡Œè¿˜æ˜¯å‹ä¸‹ã€‚è¿™ç§æµç¨‹æ§åˆ¶ï¼Œè®¾è®¡ä¸“é—¨ç”¨æ¥æ§åˆ¶å¼‚å¸¸å¯¹å±€éƒ¨èŒƒå›´çš„ç ´åã€‚ å¼‚å¸¸æ˜¯ä¸€ç§å¼ºåŒ–ç‰ˆçš„returnä¸€ä¸ªå‡½æ•°è°ƒç”¨å®Œæˆæ—¶ï¼Œå°±ä¼šåœ¨è°ƒç”¨å®ƒçš„åœ°æ–¹è¿”å›ä¸€ä¸ªå€¼ã€‚è°ƒç”¨å®Œæˆï¼Œæ„å‘³ç€ä»¥ä¸‹3ç§å«ä¹‰ä¹‹ä¸€ï¼š æ‰§è¡Œå®Œå‡½æ•°ä½“ä¸­çš„ä»£ç ï¼Œè‡ªåŠ¨è¿”å› é‡åˆ°returnè¯­å¥ï¼Œè¿”å› æŠ›å‡ºå¼‚å¸¸ å½“å‡½æ•°è°ƒç”¨å®Œæˆåï¼Œå°†ä¼šé”€æ¯è°ƒç”¨æ—¶æ‰€ä¸´æ—¶åˆ›å»ºçš„å±€éƒ¨ä½œç”¨åŸŸå¹¶å›æ”¶ç›¸å…³èµ„æºã€‚å¦‚æœå‡½æ•°aåœ¨å®ƒçš„å‡½æ•°ä½“å†…è°ƒç”¨äº†å‡½æ•°bï¼Œè€Œbä¸­å†’æ³¡äº†ä¸€ä¸ªå¼‚å¸¸ï¼Œæœªèƒ½åœ¨aä¸­å‹ä¸‹ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨aå†’æ³¡ç»™açš„è°ƒç”¨è€…ã€‚åœ¨å¤šå±‚æ¬¡è°ƒç”¨ç»“æ„ä¸­ï¼Œå¦‚æœåˆ°è¾¾é¡¶çº§å±‚æ¬¡ä¾ç„¶ä¸èƒ½è¢«å‹ä¸‹ï¼Œé‚£ä¹ˆç¨‹åºå°†ä¼šé€€å‡ºã€‚åœ¨ä¸€äº›è§£é‡Šå™¨ã€è™šæ‹Ÿæœºæˆ–è€…æŸäº›å…·æœ‰ç›‘æ§åŠŸèƒ½çš„æ‰§è¡Œç¯å¢ƒä¸­ï¼Œç¨‹åºå› ä¸ºå¼‚å¸¸é€€å‡ºæ—¶ï¼Œå°†ä¼šè‡ªåŠ¨è®°å½•ä¸‹ç›¸å…³çš„ä¿¡æ¯ï¼Œä¾¿äºå¼€å‘è€…ç†è§£é—®é¢˜æ‰€åœ¨ã€‚æŠ›å‡ºå¼‚å¸¸ï¼Œæœªèƒ½è¢«å‹ä¸‹ï¼Œå°†ä¼šä¸æ–­åœ°å¾€ä¸Šå†’æ³¡ï¼Œå¹¶è®©å±€éƒ¨ç¯å¢ƒä¸å¯è¢«å†æ¬¡åˆ©ç”¨ï¼Œç¨‹åºçš„æ‰§è¡Œç¯å¢ƒå°†è‡ªåŠ¨å›æ”¶è¿™ä¸ªå±€éƒ¨ç¯å¢ƒæ‰€å ç”¨çš„èµ„æºã€‚ä¸è¿‡å¼‚å¸¸å¯ä»¥å¼•ç”¨å…¶å®ƒå¯¹è±¡ï¼Œå¯ä»¥è¢«æ•è·ï¼Œä»ä¸­æå–ä¿¡æ¯ã€‚æ­£å› ä¸ºå¯ä»¥åœ¨é€€å‡ºå‡½æ•°æ—¶æºå¸¦ä¿¡æ¯å†’æ³¡ç»™å‡½æ•°çš„è°ƒç”¨è€…ï¼Œæ‰€ä»¥æˆ‘è¯´å¼‚å¸¸æ˜¯ä¸€ç§å¼ºåŒ–ç‰ˆçš„returnï¼Œè°ƒç”¨è€…å®Œå…¨å¯ä»¥å‹ä¸‹å¼‚å¸¸ï¼Œä»é‡Œé¢å–å‡ºä¿¡æ¯ï¼Œå°±åƒæ˜¯returnç»™å®ƒçš„ä¸€æ ·ã€‚ åœ¨Pythonä¸­ç”¨å¼‚å¸¸å®ç°ä¸€ä¸ªè¶Šçº§returnæœºåˆ¶leepfrog.py123456789101112131415161718192021222324252627282930313233import functools__all__ = ['BubbleReturnSignal', 'leepfrog']class BubbleReturnSignal(Exception): '''ä½¿ç”¨è¿™ä¸ªå¼‚å¸¸ä½œä¸ºä¸€ä¸ªreturnä¿¡å·ï¼Œå¯ä»¥å®ç°åœ¨å¤šå±‚ è°ƒç”¨ä¸­ï¼Œå¿«é€Ÿé€€å‡ºnä¸ªè°ƒç”¨å±‚ï¼Œå¹¶å­˜å‚¨äº†ä¸€ä¸ªè¿”å›å€¼`r` :param n: è¦è·³å‡ºçš„è°ƒç”¨å±‚æ¬¡å±‚æ•° :param r: è¿”å›å€¼ï¼Œé»˜è®¤ä¸ºNone ''' def __init__(self, n: int, r=None): self.n = n self.r = r def test(self): if self.n &lt;= 0: return self.r else: self.n -= 1 raise selfdef leepfrog(fn): 'è¿™ä¸ªè£…é¥°å™¨ï¼Œä½¿å‡½æ•°è‡ªåŠ¨å¤„ç†BubbleReturnSignalå¼‚å¸¸ä¿¡å·ï¼Œè®©è°ƒç”¨å±‚çš„é€€å‡ºè‡ªåŠ¨è¿›è¡Œ' def wrapper(*args, **kwds): try: return fn(*args, **kwds) except BubbleReturnSignal as exc: return exc.test() return functools.update_wrapper(wrapper, fn) ä¸‹é¢æ–‡ä»¶ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œç”¨äºæµ‹è¯•è¯´æ˜leepfrogè£…é¥°å™¨å‡½æ•°çš„åŠŸç”¨ 123456789101112131415161718192021222324252627282930313233343536373839404142import functoolsfrom leepfrog import leepfrogdef test(fn): 'æµ‹è¯•å‡½æ•°ï¼Œæ‰“å°ä¸€äº›ä¿¡æ¯ï¼Œç”¨äºè¯´æ˜' def wrapper(*args, **kwds): try: return fn() except Exception as exc: print(f'å‡½æ•°åç§°: {fn.__qualname__}\\tå¼‚å¸¸å‚æ•°: {exc.args}\\tå‰©ä½™å†’æ³¡: {exc.n}') raise return functools.update_wrapper(wrapper, fn)@test@leepfrogdef foo1(): return foo2()@test@leepfrogdef foo2(): return foo3()@test@leepfrogdef foo3(): return foo4()@test@leepfrogdef foo4(): return foo5()@test@leepfrogdef foo5(): return bar()@testdef bar(): raise BubbleReturnSignal(4, 'value') æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š 12345678&gt;&gt;&gt; value = foo1()å‡½æ•°åç§°: bar å¼‚å¸¸å‚æ•°: (4, 'value') å‰©ä½™å†’æ³¡: 4å‡½æ•°åç§°: foo5 å¼‚å¸¸å‚æ•°: (4, 'value') å‰©ä½™å†’æ³¡: 3å‡½æ•°åç§°: foo4 å¼‚å¸¸å‚æ•°: (4, 'value') å‰©ä½™å†’æ³¡: 2å‡½æ•°åç§°: foo3 å¼‚å¸¸å‚æ•°: (4, 'value') å‰©ä½™å†’æ³¡: 1å‡½æ•°åç§°: foo2 å¼‚å¸¸å‚æ•°: (4, 'value') å‰©ä½™å†’æ³¡: 0&gt;&gt;&gt; value'value'","link":"/2019/05/28/3.%E5%88%A9%E7%94%A8%E5%BC%82%E5%B8%B8%E5%AE%9E%E7%8E%B0%E8%B6%8A%E7%BA%A7return%EF%BC%88Python%E5%AE%9E%E7%8E%B0%EF%BC%89/"},{"title":"pythonçš„å­—å…¸å’Œé›†åˆçš„é€€åŒ–","text":"Python çš„å­—å…¸ dict å’Œé›†åˆ set ä»¥ hashable ä½œä¸º keyï¼Œå­˜å‚¨æ•°æ®äºå…¶ä¸­ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢æ“ä½œå…·æœ‰ $O(1)$ çš„æ—¶é—´å¤æ‚åº¦ã€‚ä½†å¦‚æœä½ æƒ³å½“ç„¶åœ°è®¤ä¸ºï¼Œç°å®æ€»æ˜¯å’Œç†æƒ³å·®ä¸å¤ªå¤šï¼Œé‚£ä¹ˆå°±å¯èƒ½ä¼šæ‰å…¥ä¸€ä¸ªé™·é˜±ä¹‹ä¸­ã€‚ æ“ä½œ æ•°ç»„ (Array) é“¾è¡¨ (Linked List) æ•£åˆ—è¡¨ (Hash Table) å¢ï¼ˆæ’å…¥ï¼‰ $O(n)$ ï¼ˆä¸­é—´ï¼‰ / $O(1)$ ï¼ˆæœ«å°¾ï¼‰ $O(n)$ ï¼ˆéœ€è¦éå†ï¼‰ å¹³å‡ $O(1)$ åˆ ï¼ˆåˆ é™¤ï¼‰ $O(n)$ ï¼ˆä¸­é—´ï¼‰ / $O(1)$ ï¼ˆæœ«å°¾ï¼‰ $O(n)$ ï¼ˆéœ€è¦éå†ï¼‰ å¹³å‡ $O(1)$ æŸ¥ï¼ˆæŸ¥æ‰¾ï¼‰ $O(1)$ ï¼ˆæŒ‰ç´¢å¼•ï¼‰ / $O(n)$ ï¼ˆæŒ‰å€¼ï¼‰ $O(n)$ å¹³å‡ $O(1)$ æ”¹ï¼ˆä¿®æ”¹ï¼‰ $O(1)$ ï¼ˆæŒ‰ç´¢å¼•ï¼‰ $O(n)$ å¹³å‡ $O(1)$ Python å®ç°å­—å…¸å’Œé›†åˆï¼Œåˆ©ç”¨äº† hash è¡¨ã€‚å­˜å‚¨å…ƒç´ åˆ° hash è¡¨æ—¶ï¼Œé¦–å…ˆä¼šç”¨æ•£åˆ—å‡½æ•°å¯¹å…ƒç´ è®¡ç®— hash å€¼ï¼Œç„¶åç›¸åŒ hash å€¼çš„å…ƒç´ ï¼Œä¼šå­˜å‚¨åœ¨åŒä¸€ä¸ªé“¾è¡¨ä¹‹ä¸­ã€‚è¿™ä¸ª hash å‡½æ•°ï¼Œå°±æ˜¯å…ƒç´ çš„ç±»ä¸Šæ‰€å®šä¹‰çš„ __hash__ ç‰¹æ®Šæ–¹æ³•ï¼Œä¼šä»¥å…ƒç´ è¿›è¡Œè®¡ç®—ç„¶åå¾—åˆ°ä¸€ä¸ªæ•´æ•°å€¼ã€‚Python åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨å­—å…¸å’Œé›†åˆä¸­ï¼ˆ__contains__ï¼‰ï¼Œè¿˜è¦åˆ¤æ–­å…ƒç´ æ˜¯å¦ç›¸ç­‰ ï¼ˆ__eq__ï¼Œé»˜è®¤æ¯”è¾ƒå…ƒç´ çš„å†…å­˜åœ°å€ï¼Œå³ idï¼‰ã€‚é¦–å…ˆæ˜¯æ‰¾åˆ°å…ƒç´ çš„ hash å€¼æ‰€åœ¨çš„é“¾è¡¨ï¼Œç„¶åå¯¹é“¾è¡¨å…ƒç´ è¿›è¡Œé€ä¸ªæ¯”å¯¹ï¼Œä»…å½“ç›¸ç­‰æ—¶æ‰è®¤ä¸ºå…ƒç´ åœ¨å…¶ä¸­ï¼Œåœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n)$ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­—å…¸å’Œé›†åˆåœ¨æœ€åæƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ $O(1 * n)$ï¼Œå³ $O(n)$ã€‚ æ‰€ä»¥ï¼Œå¦‚æœä¸€å¤§å †å…ƒç´ æœ‰ç›¸åŒçš„ hash å€¼ï¼Œåˆ™å­˜å‚¨å®ƒä»¬çš„å­—å…¸æˆ–é›†åˆä¼šå‘ç”Ÿé€€åŒ–ã€‚ ç°åœ¨å‡è®¾ä½ æœ‰è¿™æ ·ä¸€ä¸ªç±»ï¼Œå®ƒæ€»æ˜¯å¯¹ä»»ä½•å®ä¾‹ï¼Œè®¡ç®—å‡ºçš„ hash å€¼ä¸º 0ã€‚ 123class A: def __hash__(self, /) -&gt; int: return 0 ç„¶ååˆ†åˆ«åˆ›å»ºåˆ—è¡¨ã€å­—å…¸å’Œé›†åˆï¼Œä¸ºäº†æµ‹é‡è€—æ—¶ï¼Œæˆ‘åœ¨ IPython ä¸­æ‰§è¡Œäº†ä»£ç ã€‚ 123In [2]: %time list0 = [A() for _ in range(10000)]CPU times: user 2.38 ms, sys: 132 Î¼s, total: 2.51 msWall time: 2.51 ms 123In [3]: %time dict0 = {A(): None for _ in range(10000)}CPU times: user 846 ms, sys: 1.3 ms, total: 847 msWall time: 850 ms 123In [4]: %time set0 = {A() for _ in range(10000)}CPU times: user 718 ms, sys: 1.13 ms, total: 719 msWall time: 721 ms å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é›†åˆå’Œå­—å…¸ä¸­æ–°å¢å…ƒç´ ï¼Œæ¯”åœ¨åˆ—è¡¨ä¸­æ…¢çš„å¤šå¾—å¤šï¼Œè€Œé›†åˆæ¯”å­—å…¸å¿«ä¸€äº›ï¼Œå› ä¸ºé›†åˆçš„ç»“æ„æ›´ç®€å•ä¸€äº›ã€‚ä¹‹æ‰€ä»¥éƒ½æ¯”åˆ—è¡¨æ…¢é‚£ä¹ˆå¤šï¼Œæ˜¯å› ä¸ºé›†åˆå’Œå­—å…¸åœ¨æ–°å¢ã€åˆ é™¤æˆ–ä¿®æ”¹æ—¶ï¼Œä¹Ÿè¦å…ˆæŸ¥è¯¢å…ƒç´ æ˜¯å¦åœ¨å…¶ä¸­ï¼Œç„¶åæ‰èƒ½æ‰§è¡Œå®é™…çš„æ“ä½œï¼Œè€Œåœ¨æŸ¥è¯¢ä¸Šé€€åŒ–ä¸º $O(n)$ï¼Œåœ¨æ–°å¢ã€åˆ é™¤æˆ–ä¿®æ”¹ $n$ ä¸ªå…ƒç´ æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿä¼šé€€åŒ–ä¸º $O(n^2)$ã€‚ å¦å¤–åœ¨ Python ä¸­ï¼Œåˆ—è¡¨çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œå´åˆæ¯”é“¾è¡¨å¿«ä¸€å€ 12In [5]: %timeit A() in list084.8 Î¼s Â± 77.4 ns per loop (mean Â± std. dev. of 7 runs, 10,000 loops each) 12In [6]: %timeit A() in set0156 Î¼s Â± 648 ns per loop (mean Â± std. dev. of 7 runs, 10,000 loops each) 12In [7]: %timeit A() in dict0124 Î¼s Â± 1.01 Î¼s per loop (mean Â± std. dev. of 7 runs, 10,000 loops each) ä¸è¿‡æœ‰è¶£çš„æ˜¯ï¼Œå­—å…¸çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œæ¯”é›†åˆå¿«äº†ä¸€äº›ã€‚","link":"/2025/08/20/15.python%E7%9A%84%E5%AD%97%E5%85%B8%E5%92%8C%E9%9B%86%E5%90%88%E7%9A%84%E9%80%80%E5%8C%96/"},{"title":"CPythonä¸­å‡½æ•°å¼•ç”¨å®ƒè‡ªèº«","text":"âš ï¸ è¯·ç¡®ä¿CPythonçš„ç‰ˆæœ¬ä¸ä½äº3.8ï¼Œå› è¯­æ³•æ¶‰åŠ2ä¸ªPEPï¼šPEP570ï¼ŒPEP572 é—®é¢˜ å¯å‘è‡ªè¿™ç¯‡é—®ç­”ï¼šIs there a generic way for a function to reference itself?æ›¾æœ‰ä¸€ä¸ªæè®®PEP 3130 â€“ Access to Current Module/Class/Functionï¼Œä½†æ˜¯å› ä¸ºæ–¹æ¡ˆä¸å®Œå–„è€Œè¢«æ‹’ç»äº† å°±åƒ__class__åœ¨å‡½æ•°ä½“å†…æŒ‡å‘äºè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„ç±»ï¼Œæ˜¯å¦æœ‰ä¸€ä¸ªæŒ‡é’ˆæˆ–è€…è¯´é­”æ³•å…³é”®è¯ï¼Œä¾‹å¦‚__func__ï¼Œåœ¨å‡½æ•°ä½“å†…ä½¿ç”¨æ—¶ï¼Œèƒ½æŒ‡å‘è¢«è°ƒç”¨çš„å‡½æ•°æœ¬èº«ï¼Ÿå› æ­¤ï¼Œæˆ‘å¯ä»¥å†™å‡ºåƒä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š 12345def foo(): print(__func__.__name__) print(__func__.__hash__) print(__func__.__code__) ... # other simliars è§£å†³æ–¹æ¡ˆ æš‚æ—¶è¿˜æ²¡æœ‰è¿™æ ·çš„ä¸€ä¸ªæŒ‡é’ˆå’Œé­”æ³•å…³é”®è¯ï¼Œèµ·ç å°±python 3.8æ¥çœ‹ã€‚å› æ­¤æš‚æ—¶åªèƒ½ç”¨ä¸€äº›ä¾µå…¥å¼çš„æ–¹æ¡ˆï¼Œæ¥æ¨¡æ‹Ÿå®ç°è¿™ä¸€éœ€æ±‚ã€‚ é€šè¿‡è°ƒç”¨æ ˆä¿¡æ¯æ¥è·å–å‡½æ•°å¼•ç”¨æˆ‘å¯ä»¥åœ¨ä¸€ä¸ªå‡½æ•°çš„å‡½æ•°ä½“å†…è®¿é—®è¿™ä¸ªå‡½æ•°æœ¬èº«ï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç ï¼š 12345def foo(): print(foo.__name__) print(foo.__hash__) print(foo.__code__) ... # other simliars å› ä¸ºä»¥ä¸Šæ–¹å¼éœ€è¦æ˜¾å¼åœ°æŒ‡å®šå‡½æ•°åï¼Œå½“å‡½æ•°åå‘ç”Ÿæ”¹å˜æ—¶ï¼Œå‡½æ•°ä½“å†…ç›¸åº”çš„åå­—ä¹Ÿè¦è¿›è¡Œæ”¹å˜ã€‚ä¸ºäº†é¿å…è¿™ä¸€ç‚¹ï¼Œéœ€è¦å‡½æ•°æœ‰å……è¶³çš„ä¿¡æ¯ä»¥å®šä½è‡ªèº«ã€‚ä¾‹å¦‚ï¼Œå½“å¯ä»¥é€šè¿‡å‡½æ•°åœ¨å®šä¹‰æ—¶çš„åå­—åœ¨ç›¸åº”çš„å…¨å±€å‘½åç©ºé—´ä¸­æŸ¥æ‰¾å¼•ç”¨æ—¶ è¿™ä¸ªåå­—å­˜å‚¨äºfunction.__code__.co_nameï¼šå¦‚æœç”¨def func_nameæˆ–è€…async def func_nameåˆ›å»ºå‡½æ•°ï¼Œfunc_nameå°±æ˜¯åå­—ï¼›å¦‚æœç”¨lambdaåˆ›å»ºå‡½æ•°ï¼Œåå­—å°±æ˜¯&lt;lambda&gt;ï¼Œæˆ‘ç‰¹åˆ«ä¸å»ºè®®å¦‚æ­¤ã€‚âš ï¸ è¿™ä¸ªå±æ€§co_nameæ˜¯åªè¯»çš„ä¸”ä¸èƒ½è¢«æ”¹å˜ã€‚ä½†ä½ å¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªæ–°çš„codeå¯¹è±¡ï¼Œå¤åˆ¶ç›¸åŒçš„åŠŸèƒ½ï¼Œé€‰ç”¨ä¸åŒçš„åå­—ã€‚âš ï¸ è¿™é‡Œå¹¶æ²¡æœ‰ç”¨åˆ°function.__name__ï¼Œè¿™ä¸ªå±æ€§æ˜¯å¯å˜çš„ï¼Œè€Œä¸”æ›´åŠ çµæ´»å’Œåˆé€‚ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´è·å–å›°éš¾ï¼Œæ‰€ä»¥ä¸é‡‡ç”¨ã€‚ç‰¹åˆ«æ˜¯ï¼Œfunction.__qualname__ä¹ŸåŒæ ·éš¾ä»¥è·å¾—ï¼Œä¸ç„¶å¯ä»¥ç»Ÿä¸€åœ°è§£å†³å¾ˆå¤šé—®é¢˜äº†ã€‚Note Name of a Python function ï¼Œå°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å¸®åŠ©å‡½æ•°æ¥è·å–è¿™ä¸ªå‡½æ•°çš„å¼•ç”¨ï¼š 1234567891011121314151617181920import sysdef getfuncref(): ''' Get a reference to the `function` which is called recently in this threadï¼Œas long as the key where in `globals` that point to the function is equal to `function.__code__.co_name`. ''' # REF: https://www.oreilly.com/library/view/python-cookbook/0596001673/ch14s08.html # This introspective task is easily performed with sys._getframe. # This function returns a frame object whose attribute f_code is # a code object and the co_name attribute of that object is the # function name. # By calling sys._getframe(1), you can get this information # for the caller of the current function. So you can package # this functionality into your own handy functions. # This calls sys._getframe with argument 1, because the call # to `getfuncref` is now frame 0. f = sys._getframe(1) return f.f_globals[f.f_code.co_name] See Also http://code.activestate.com/recipes/66062/ https://stackoverflow.com/questions/33162319/how-can-get-current-function-name-inside-that-function-in-python https://stackoverflow.com/questions/21218416/reference-to-the-function-from-inside-itself-like-arguments-callee-in-javascrip https://stackoverflow.com/questions/4492559/how-to-get-current-function-into-a-variable https://stackoverflow.com/questions/5067604/determine-function-name-from-within-that-function-without-using-traceback â€¦ æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š 123&gt;&gt;&gt; def foo(): return getfuncref()&gt;&gt;&gt; foo is foo()True Note æˆªè‡³python 3.8ï¼Œè°ƒç”¨æ ˆçš„å¸§frameï¼ˆframe-objectsï¼‰ä¸Šå¹¶æ²¡æœ‰å¯¹å‡½æ•°å¯¹è±¡çš„å¼•ç”¨ï¼Œåªæ˜¯å¼•ç”¨äº†å‡½æ•°ç›¸åº”çš„codeå¯¹è±¡ï¼Œä»¥åŠç›¸å…³çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯ã€‚å› æ­¤ï¼Œé€šè¿‡å®¡æŸ¥è°ƒç”¨æ ˆæ¥è·å–å‡½æ•°functionè°ƒç”¨æ—¶å¯¹åº”çš„å¸§frameçš„ä¿¡æ¯ï¼Œä»¥è·å–functionçš„å¼•ç”¨ï¼Œéœ€è¦æ ¹æ®ä¸€äº›ä¿¡æ¯ä»¥é—´æ¥æ–¹å¼åœ¨ç›¸å…³çš„å‘½åç©ºé—´ä¸Šæœç´¢ã€‚è€Œä¸”ç”±äºcodeå¯¹è±¡ä¸Šæ²¡æœ‰å­˜å‚¨å‡½æ•°çš„æè¿°ä¿¡æ¯ï¼ˆå°½ç®¡è¿™ç§ç­–ç•¥æœ‰åˆ©äºcodeå¯¹è±¡çš„å¤ç”¨ï¼‰ï¼Œå¦‚æœå‡½æ•°å®šä¹‰åœ¨ç±»ä¸­ï¼Œé‚£ä¹ˆå®šä½è¿™ä¸ªå‡½æ•°çš„ç­–ç•¥å°†ä¼šæ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºæœ‰ä¸€äº›ä¸åŒçš„æƒ…å†µéœ€è¦åˆ†åˆ«å¯¹å¾…ï¼Œè€Œä¸”å¯èƒ½è¿˜éœ€è¦ä¸€äº›å¦å¤–çš„ä¿¡æ¯ã€‚ğŸ”” æˆ‘è§‰å¾—ä½ å¯ä»¥åˆ©ç”¨inspectæ¨¡å—æ¥è¾…åŠ©æ”¶é›†ä¿¡æ¯ã€‚ é€šè¿‡æŠŠå‡½æ•°çš„å¼•ç”¨ç»‘å®šåˆ°å‚æ•°ä¸Šå¯ä»¥é€šè¿‡åœ¨è°ƒç”¨å‡½æ•°æ—¶ä¼ å…¥è¿™ä¸ªå‡½æ•°çš„å¼•ç”¨ï¼Œåœ¨å‡½æ•°ä½“å†…ä½¿ç”¨ï¼š 12345def foo(__func__, /): print(__func__.__name__) print(__func__.__hash__) print(__func__.__code__) ... # other simliars ä¸ºæ­¤ï¼Œæˆ‘è®¾è®¡äº†3ä¸ªè£…é¥°å™¨æ¥å®ç°ä¸€ç§ç»‘å®šæ•ˆæœ 123456789101112131415161718192021from functools import partial, update_wrapper############### plan 1 ###############def partial_bind_func(f, /): 'Decorate function `f` to pass a reference to the function as the first argument' return update_wrapper(partial(f, f), f)############### plan 2 ###############def method_bind_func(f, /): 'Decorate function `f` to pass a reference to the function as the first argument' return f.__get__(f, type(f))############### plan 3 ###############import inspectdef assign_bind_func(f, /): 'Decorate function `f` to pass a reference to the function as the first argument' wrapper = update_wrapper(lambda *a, **k: f(f, *a, **k), f) params = tuple(inspect.signature(f).parameters.values()) wrapper.__signature__ = inspect.Signature(params[1:]) return wrapper æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š 123456789&gt;&gt;&gt; def foo(__func__, /, a, *b, c, **d): pass&gt;&gt;&gt; inspect.signature(foo)&lt;Signature (__func__, /, a, *b, c, **d)&gt;&gt;&gt;&gt; inspect.signature(partial_bind_func(foo), follow_wrapped=False)&lt;Signature (a, *b, c, **d)&gt;&gt;&gt;&gt; inspect.signature(method_bind_func(foo))&lt;Signature (a, *b, c, **d)&gt;&gt;&gt;&gt; inspect.signature(assign_bind_func(foo))&lt;Signature (a, *b, c, **d)&gt;","link":"/2019/07/12/5.CPython%E4%B8%AD%E5%87%BD%E6%95%B0%E5%BC%95%E7%94%A8%E5%AE%83%E8%87%AA%E8%BA%AB/"},{"title":"PythonæŠŠHTMLä¸­çš„imgå…ƒç´ çš„srcè½¬æ¢æˆdatauri","text":"èƒŒæ™¯æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ç¼–å†™å®Œ markdown æ–‡æ¡£ï¼Œä¸ºäº†ä¾¿äºåˆ†äº«é˜…è¯»ï¼Œä¼šæŠŠå®ƒè½¬æ¢æˆ HTML æ–‡æ¡£ã€‚ä½†æ˜¯ï¼Œå¤§å¤šæ•°çš„ markdown è½¬ HTML å·¥å…·ï¼Œåªä¼šä¿ç•™å¤–éƒ¨èµ„æºé“¾æ¥ï¼Œè€Œä¸æ˜¯æŠŠèµ„æºæ•´åˆåˆ° HTML æ–‡æ¡£ä¹‹ä¸­ã€‚å¦‚æœæ˜¯ç½‘ç»œèµ„æºï¼Œåªè¦è”ç½‘å°±èƒ½ä¸‹è½½ï¼Œå¦‚æœæ˜¯æœ¬åœ°èµ„æºï¼Œé‚£ä¹ˆå¿…é¡»æŠŠå¯¹åº”æ–‡ä»¶ä¹Ÿä¸€èµ·æ‰“åŒ…ï¼Œåˆ†äº«ç»™åˆ«äººã€‚ æˆ‘ä¸ªäººè§‰å¾—ï¼Œåˆ†äº«ä¸€ä¸ªå•ç‹¬çš„ HTML ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª HTML ä»¥åŠä¸€å †æ–‡ä»¶çš„æ‰“åŒ…ï¼Œå¯ä»¥æ›´æ–¹ä¾¿ç”¨æˆ·çš„é˜…è¯»ã€‚è¿™é‡Œï¼Œæˆ‘åˆ†äº«ä¸€ä¸ª Python è„šæœ¬ï¼Œå¯ä»¥æŠŠä¸€ä¸ª HTML æ–‡æ¡£ä¸­æ‰€æœ‰ &lt;img&gt; å…ƒç´ ä¸­çš„ src å±æ€§çš„å€¼ï¼Œè½¬æ¢æˆ datauri ï¼ˆæ›´ç°ä»£çš„ç§°å‘¼æ˜¯ data URLï¼Œè¯¦é˜…ï¼šData URLs | MDNï¼‰ ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/5088ae89bc7359b5c931343f5e690e87 æ–‡ä»¶åç§°æ˜¯ html_img_src2datauri.pyï¼Œæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼ŒPython å®ç°ä»£ç å¦‚ä¸‹ï¼š html_img_src2datauri.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140#!/usr/bin/env python3# coding: utf-8__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1, 1)__all__ = [&quot;func_cmdline&quot;]# Inspired by:# - https://pypi.org/project/typer/import inspectfrom argparse import ArgumentParser, Namespace, RawDescriptionHelpFormatterfrom functools import partialfrom textwrap import dedent, indentfrom typing import Callable, Optionaldef func_cmdline( fn: Optional[Callable] = None, /, parser: Optional[ArgumentParser] = None, parse_map: dict[type, Callable] = {}, helpinfo_map: dict[str, str] = {}, ) -&gt; Callable: &quot;&quot;&quot;è£…é¥°å™¨è®©ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä½œä¸ºå‘½ä»¤è¡Œä½¿ç”¨ :param fn: è¢«è£…é¥°çš„å‡½æ•° :param parser: å‘½ä»¤è¡Œè§£æå™¨å¯¹è±¡ :param parse_map: ä¸åŒç±»å‹çš„è§£æå‡½æ•°çš„æ˜ å°„ï¼Œ å­—ç¬¦ä¸²é€šè¿‡ç›¸åº”çš„è§£æå‡½æ•°æ¥è½¬æ¢æˆå¯¹åº”å¯¹è±¡ï¼Œ å¦‚æœæ²¡æœ‰ç›¸åº”çš„è§£æå‡½æ•°ï¼Œåˆ™å°è¯•ç”¨å¯¹è±¡æœ¬èº« ï¼ˆå®ƒçš„æ„é€ å™¨ï¼‰ :param helpinfo_map: ä¸åŒå‚æ•°çš„å¸®åŠ©è¯´æ˜ï¼Œ ç”¨äºå‘½ä»¤è¡Œçš„å¸®åŠ©ä¿¡æ¯ :param: è¿”å‡½æ•°`fn`æœ¬èº«ï¼Œåªæ˜¯å®ƒèº«ä¸Šç»‘å®šäº†å‡ ä¸ªå±æ€§ .parser å­—æ®µï¼Œä½¿ç”¨çš„å‘½ä»¤è¡Œè§£æå™¨å¯¹è±¡ .parse() æ–¹æ³•ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•° .run() æ–¹æ³•ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°å¹¶è¿è¡Œå‡½æ•°`fn`ï¼Œ è¿”å›å‡½æ•°`fn`çš„æ‰§è¡Œç»“æœ :return: è¢«è£…é¥°å‡½æ•°æœ¬èº«ï¼Œæ·»åŠ äº†å‡ ä¸ªå±æ€§ &quot;&quot;&quot; if fn is None: return partial( func_cmdline, parser=parser, parse_map=parse_map, helpinfo_map=helpinfo_map, ) params = inspect.signature(fn).parameters if parser is None: parser = ArgumentParser( formatter_class=RawDescriptionHelpFormatter) if parser.epilog is None: parser.epilog = &quot;&quot; if fn.__doc__ is not None: parser.epilog += &quot;documentation:\\n&quot; + \\ indent(fn.__doc__, &quot; &quot;) parser.epilog += &quot;\\n\\nsource code:\\n&quot; + \\ indent(dedent(inspect.getsource(fn)), &quot; &quot;) abbrs: dict[str, int] = {} for name, param in params.items(): kargs: dict = {&quot;dest&quot;: name, &quot;help&quot;: helpinfo_map.get(name)} kind = param.kind if kind is inspect._ParameterKind.VAR_POSITIONAL: kargs[&quot;required&quot;] = False kargs[&quot;nargs&quot;] = &quot;*&quot; kargs[&quot;default&quot;] = [] elif kind is inspect._ParameterKind.VAR_KEYWORD: continue default = param.default if default is inspect._empty: kargs.setdefault(&quot;required&quot;, True) else: kargs[&quot;default&quot;] = default anno = param.annotation if anno is not inspect._empty: if anno is bool: kargs[&quot;required&quot;] = False if &quot;default&quot; in kargs: if kargs[&quot;default&quot;]: kargs[&quot;action&quot;] = &quot;store_false&quot; else: kargs[&quot;action&quot;] = &quot;store_true&quot; else: kargs[&quot;action&quot;] = &quot;store_true&quot; elif anno is list: kargs[&quot;nargs&quot;] = &quot;*&quot; elif getattr(anno, &quot;__origin__&quot;, None) is list and len(anno.__args__) == 1: kargs[&quot;nargs&quot;] = &quot;*&quot; kargs[&quot;type&quot;] = parse_map.get(anno.__args__[0], anno.__args__[0]) else: kargs[&quot;type&quot;] = parse_map.get(anno, anno) names = [] first_letter = name[0] n = abbrs.setdefault(first_letter, 0) if n == 0: abbr = first_letter else: abbr = f&quot;{first_letter}{n}&quot; abbrs[first_letter] += 1 names.append(f&quot;-{abbr}&quot;) names.append(f&quot;--{name}&quot;) if &quot;_&quot; in name: names.append(f&quot;--{name.replace('_', '-')}&quot;) parser.add_argument(*names, **kargs) def parse(argv: Optional[list[str]] = None) -&gt; Namespace: return parser.parse_args(argv) def run(argv: Optional[list[str]] = None): &quot;è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨&quot; args = parser.parse_args(argv).__dict__ pargs = [] kargs = {} for name, param in params.items(): kind = param.kind if name in args: if kind.value &lt; 2: pargs.append(args[name]) elif kind.value == 2: pargs.extend(args[name]) else: kargs[name] = args[name] return fn(*pargs, **kargs) setattr(fn, &quot;parser&quot;, parser) setattr(fn, &quot;parse&quot;, parse) setattr(fn, &quot;run&quot;, run) return fnif __name__ == &quot;__main__&quot;: @func_cmdline(helpinfo_map=dict( a=&quot;å‚æ•°a&quot;, b=&quot;å‚æ•°b&quot;, c=&quot;å‚æ•°c&quot;, d=&quot;å‚æ•°d&quot;, e=&quot;å‚æ•°e&quot;, f=&quot;å‚æ•°f&quot;, )) def foo(a: int, /, b: bool, c: bool = True, *d: int, e: list[int], f: int = 4): &quot;Example for function as command line.&quot; print(a, b, c, d, e, f) foo.run() ä½¿ç”¨è¯´æ˜åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ç±»ä¼¼å¦‚ä¸‹å‘½ä»¤ï¼Œå¯ä»¥è·å–å¸®åŠ©ä¿¡æ¯ï¼š 1python html_img_src2datauri.py -h è¿”å›çš„å¸®åŠ©ä¿¡æ¯ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š 12345678910111213141516usage: html_img_src2datauri.py [-h] [-e ENCODING] path_to_file_or_dir [path_to_file_or_dir ...]æŠŠ HTML æ–‡ä»¶ä¸­ &lt;img&gt; å…ƒç´ çš„ src å±æ€§è½¬æ¢æˆ datauriã€‚æ³¨æ„ï¼šæ‰€æœ‰HTML æ–‡ä»¶ä¼šè¢«åŸåœ°æ›¿æ¢ï¼Œå¹¶ä¸ç”Ÿæˆæ–°æ–‡ä»¶positional arguments: path_to_file_or_dir html æ‰€åœ¨çš„æ–‡ä»¶æˆ–æ–‡ä»¶ å¤¹options: -h, --help show this help message and exit -e ENCODING, --encoding ENCODING html æ–‡ä»¶çš„ç¼–ç  ç°åœ¨å‡è®¾ï¼Œåœ¨å½“å‰çš„å·¥ä½œç›®å½•ä¸‹ï¼Œæœ‰ 1 ä¸ª HTML æ–‡ä»¶ 3.html ï¼Œå¦å¤–è¿˜æœ‰ 1 ä¸ªæ–‡ä»¶å¤¹ srcï¼Œé‡Œé¢æœ‰ 2 ä¸ª HTML æ–‡ä»¶ï¼Œ1.htmlã€2.htmlï¼Œæ–‡æ¡£éƒ½é‡‡ç”¨ utf-8 ç¼–ç ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š 12# 4.html å¹¶ä¸å­˜åœ¨ï¼Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºå‘ç”Ÿé”™è¯¯æ—¶çš„æ•ˆæœpython html_img_src2datauri.py -e utf-8 src/ 3.html 4.html å¯ä»¥å¾—åˆ°å¦‚ä¸‹æ‰“å°ä¿¡æ¯ï¼š 123456789101112--------------------[PROCESSING] src/1.htmlğŸ˜„ SUCCESS--------------------[PROCESSING] src/2.htmlğŸ˜„ SUCCESS--------------------[PROCESSING] 3.htmlğŸ˜„ SUCCESS--------------------[PROCESSING] 4.htmlğŸ˜­ FAILED: [Errno 2] No such file or directory: '4.html' æœªæ¥è§„åˆ’æ­£å¦‚æˆ‘åœ¨å‰è¨€ä¸­æ‰€æåˆ°çš„ï¼Œè¦æŠŠå¤–éƒ¨èµ„æºæ•´åˆåˆ°ä¸€ä¸ª HTML ä¸­ï¼Œé‚£ä¾¿ä¸ä»…ä»…æ˜¯å›¾ç‰‡äº†ã€‚æˆ‘è®¡åˆ’åœ¨ä¹‹åçš„æ›´æ–°ä¸­ï¼Œå®ç°è¿™ä¸€æƒ³æ³•ï¼Œè€ŒæŠŠå›¾ç‰‡æ•´åˆè¿› HTML ä¸­ï¼Œåªæ˜¯ä½œä¸ºå°è¯•çš„ç¬¬ä¸€æ­¥ï¼Œæ‰€ä»¥ï¼Œæ•¬è¯·æœŸå¾…æˆ‘çš„åç»­æ›´æ–°ã€‚","link":"/2022/08/01/6.Python%E6%8A%8AHTML%E4%B8%AD%E7%9A%84img%E5%85%83%E7%B4%A0%E7%9A%84src%E8%BD%AC%E6%8D%A2%E6%88%90datauri/"},{"title":"Shellè„šæœ¬å®ç°åœ¨Linuxå‘½ä»¤è¡Œå¼€å¯ä»£ç†","text":"èƒŒæ™¯æˆ‘ä»¬åœ¨ Linux å‘½ä»¤è¡Œä¸­ï¼Œç»å¸¸ä¼šéœ€è¦ä½¿ç”¨ä»£ç†ï¼ˆå‚è€ƒï¼šHow To Use Proxy Server To Access Internet at Shell Prompt With http_proxy Variableï¼ŒLinux Proxy Server Settings â€“ Set Proxy For Command Lineï¼‰ï¼Œä»¥ä¾¿èƒ½è®¿é—®æŸäº›èµ„æºã€‚ åœ¨æˆ‘ä½¿ç”¨ Clash å¼€å¯äº†ä¸€ä¸ªä»£ç†ï¼Œç«¯å£ä¸º 7890 åï¼Œæˆ‘å¸¸å¸¸ç”¨ä¸‹é¢çš„ shell ä»£ç åœ¨å‘½ä»¤è¡Œä¸­å¯ç”¨æˆ–å–æ¶ˆä»£ç†ã€‚ 12345678910111213141516171819# å¯ä»¥æŠŠä»£ç å†™å…¥ bash å’Œ zsh çš„å¯åŠ¨æ–‡ä»¶ä¸­ï¼Œæ–°å¼€ session ä¸­å¯ç”¨#cat &gt;&gt; ~/.bashrc &gt;&gt; ~/.zshrc &lt;&lt; 'EOF'export proxy=localhost:7890# å¦‚æœæ˜¯åœ¨ WSL ä¸­ï¼Œå¯ä»¥æ›¿æ¢ä¸ºä¸‹é¢çš„è¯­å¥#export proxy=$(cat /etc/resolv.conf | grep -m 1 nameserver | awk '{ print $2 }'):7890;# proxy+ å‘½ä»¤ç”¨äºå¯ç”¨ä»£ç†alias proxy+='\\export https_proxy=http://$proxyexport http_proxy=http://$proxyexport all_proxy=socks5://$proxyexport no_proxy=localhost,127.0.0.1,::1echo &quot;proxy has been set to: $proxy&quot;curl ipinfo.io';# proxy- å‘½ä»¤ç”¨äºåœç”¨ä»£ç†alias proxy-='\\unset http_proxy https_proxy all_proxy no_proxyecho &quot;proxy has been cleared&quot;;curl ipinfo.io';#EOF ä¸ºäº†ä¾¿äºåšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»è‡ªå·±çš„åå¥½å‡ºå‘ï¼Œç¼–å†™äº†ä¸€ä¸ª shell è„šæœ¬ï¼Œå·²ç»åœ¨ bash å’Œ zsh ä¸­é€šè¿‡æµ‹è¯•ã€‚ ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/b5abf2de8bb5a91753764f9403adcc99 æ–‡ä»¶åç§°ä¸º mod-proxy.shï¼Œä»£ç ä¸­ç«¯å£çš„é»˜è®¤å€¼ PROXY_PORT è®¾ä¸º 7890ï¼Œæ˜¯ Clash çš„é»˜è®¤ç«¯å£ï¼Œå®ç°å¦‚ä¸‹ï¼š mod-proxy.sh123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200#? è®¾ç½®ä»£ç† ipï¼Œè¯·è¿è¡Œ proxy# è·å–å¸®åŠ©ä¿¡æ¯# AUTHOR='ChenyangGao &lt;https://chenyanggao.github.io/&gt;''# VERSION=0.2if [ -n &quot;${MOD_PROXY_sourced+x}&quot; ]; then return 0fi# inetutils (apt)# net-tools (yum)-proxy-get-local-ipv4-using-hostname() { hostname -I 2&gt;&amp;- | awk '{print $1}'}# iproute2-proxy-get-local-ipv4-using-iproute2() { # OR ip route get 1.2.3.4 | awk '{print $7}' ip -4 route 2&gt;&amp;- | awk '{print $NF}' | grep -Eo --color=never '[0-9]+(\\.[0-9]+){3}'}# net-tools-proxy-get-local-ipv4-using-ifconfig() { ( ifconfig 2&gt;&amp;- || ip addr show 2&gt;&amp;- ) | grep -Eo '^\\s+inet\\s+\\S+' | grep -Eo '[0-9]+(\\.[0-9]+){3}' | grep -Ev '127\\.0\\.0\\.1|0\\.0\\.0\\.0'}# è·å–æœ¬æœº IPv4 åœ°å€-proxy-get-local-ipv4() { set -o pipefail -proxy-get-local-ipv4-using-hostname || -proxy-get-local-ipv4-using-iproute2 || -proxy-get-local-ipv4-using-ifconfig}-proxy-get-local-ipv4-select() { local ips=$(-proxy-get-local-ipv4) local retcode=$? if [ $retcode -ne 0 ]; then return $retcode fi grep -m 1 &quot;^192\\.&quot; &lt;&lt;&lt;&quot;$ips&quot; || \\ grep -m 1 &quot;^172\\.&quot; &lt;&lt;&lt;&quot;$ips&quot; || \\ grep -m 1 &quot;^10\\.&quot; &lt;&lt;&lt;&quot;$ips&quot; || \\ head -n 1 &lt;&lt;&lt;&quot;$ips&quot;}-proxy-get-remote-ssh-ip-using-ssh-env() { ( [ -n &quot;$SSH_CLIENT&quot; ] &amp;&amp; awk '{print $1}' &lt;&lt;&lt;&quot;$SSH_CLIENT&quot; ) || \\ ( [ -n &quot;$SSH_CONNECTION&quot; ] &amp;&amp; awk '{print $1}' &lt;&lt;&lt;&quot;$SSH_CONNECTION&quot; )}-proxy-get-remote-ssh-ip-using-who() { who am i 2&gt;&amp;- | awk '{print $NF}' | grep '([^)]\\+)' | grep -o '[^()]\\+'}# è·å–è¿œç¨‹è¿æ¥åˆ°æœ¬æœºçš„ ssh å®¢æˆ·ç«¯çš„ ip åœ°å€-proxy-get-remote-ssh-ip() { -proxy-get-remote-ssh-ip-using-ssh-env || -proxy-get-remote-ssh-ip-using-who}# é»˜è®¤çš„ä»£ç†æœåŠ¡çš„ä¸»æœºåœ°å€ï¼Œå¯ä»¥æ˜¯ ip æˆ– åŸŸåPROXY_HOST=$(( -proxy-get-local-ipv4-select | head -n 1 ) || echo 127.0.0.1)# é»˜è®¤çš„ä»£ç†ç«¯å£ï¼ˆclash çš„é»˜è®¤ç«¯å£æ˜¯ 7890ï¼‰ï¼Œ0-65535 ä¹‹é—´çš„æ•°å­—PROXY_PORT=7890-proxy-format-proxy() { if [ -z &quot;$1&quot; ]; then echo &quot;$PROXY_HOST:$PROXY_PORT&quot; elif [[ $1 == \\[* ]]; then # as ipv6 if [[ $1 == *\\] ]]; then # as without port echo &quot;$1:$PROXY_PORT&quot; else # as with port echo &quot;$1&quot; fi elif [[ $1 =~ ^[0-9]+(\\.[0-9]+){3}$ ]]; then # as ipv4 (without port) echo &quot;$1:$PROXY_PORT&quot; elif [[ $1 =~ ^:[0-9]+$ ]]; then # as bare port echo &quot;$PROXY_HOST$1&quot; elif [[ $1 == *:*:* &amp;&amp; $1 =~ ^[0-9a-zA-Z:]+$ ]]; then # as ipv6 (without port) echo &quot;[$1]:$PROXY_PORT&quot; elif [[ $1 != *:* ]]; then # as hostname without port echo &quot;$1:$PROXY_PORT&quot; else # no op, here may be a mistake echo &quot;$1&quot; fi}# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œé»˜è®¤é‡‡ç”¨æœ¬æœºä¸Šçš„ 7890 ç«¯å£çš„ä»£ç†æœåŠ¡proxy-set() { local proxy=$(-proxy-format-proxy &quot;$1&quot;) export https_proxy=http://$proxy export http_proxy=http://$proxy export all_proxy=socks5://$proxy export no_proxy='localhost,127.0.0.1,::1' echo &quot;proxy has been set to: $proxy&quot; ## Get public ip in Linux command line ## NOTE curl â‰ˆ wget -qO - # curl api.ipify.org # curl checkip.amazonaws.com # curl cip.cc # curl httpbin.org/ip # curl ifconfig.cat # ipv6 # curl ifconfig.co # ipv6 # curl ifconfig.io # ipv6 # curl ifconfig.me # curl ifconfig.net # ipv6 # curl inet-ip.info # curl ipinfo.io # ğŸ‘ # curl ipv4.icanhazip.com # curl ipv4.ident.me # curl ipv4.ip.gs # curl ipv4.ip.sb # curl ip-api.com # ğŸ‘ # curl ip.threep.top # curl ipecho.net/plain # curl myip.dnsomatic.com # ğŸ‘ # curl myip.ipip.net # curl https://checkipv4.dedyn.io # curl https://ip.tool.lu # dig +short myip.opendns.com @resolver1.opendns.com # dig ANY +short @resolver2.opendns.com myip.opendns.com curl ipinfo.io}alias proxy+=proxy-set# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œä»£ç†æœåŠ¡æ¥è‡ª ssh è¿æ¥åˆ°è¿™å°æœºå™¨çš„è¿œç¨‹æœºå™¨ï¼ˆä»…é€‚ç”¨äºå±€åŸŸç½‘ï¼‰proxy-set-from-remote() { -proxy-get-remote-ssh-ip 1&gt;&amp;- &amp;&amp; proxy-set $(-proxy-get-remote-ssh-ip)}alias proxy++=proxy-set-from-remote# åœ¨ shell ä¸­åœç”¨ä»£ç†proxy-clear() { unset http_proxy https_proxy all_proxy no_proxy echo 'proxy has been cleared' curl ipinfo.io}alias proxy-=proxy-clear# æ‰“å° export å‘½ä»¤ï¼Œç”¨äºå¯ç”¨ shell ä¸­çš„ä»£ç†ï¼ˆæ¥è‡ªè¿™å°æœºå™¨ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨ï¼‰proxy-export() { local proxy=$(-proxy-format-proxy &quot;$1&quot;) echo &quot;\\# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨export https_proxy=http://$proxyexport http_proxy=http://$proxyexport all_proxy=socks5://$proxyexport no_proxy='localhost,127.0.0.1,::1'# ç”¨ä»¥ä¸‹å‘½ä»¤åœç”¨ä»£ç†# unset http_proxy https_proxy all_proxy no_proxy&quot;}alias proxy@=proxy-export# æ‰“å° alias å‘½ä»¤ï¼Œç”¨äºå¯ç”¨å’Œåœç”¨ shell ä¸­çš„ä»£ç†ï¼ˆæ¥è‡ªè¿™å°æœºå™¨ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨ï¼‰ï¼Œå…¶ä¸­ï¼š# proxy+ åœ¨ shell ä¸­å¯ç”¨ä»£ç†# proxy- åœ¨ shell ä¸­åœç”¨ä»£ç†proxy-alias() { local proxy=$(-proxy-format-proxy &quot;$1&quot;) cat &lt;&lt; EOF# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨alias proxy+=&quot;\\export https_proxy=http://$proxyexport http_proxy=http://$proxyexport all_proxy=socks5://$proxyexport no_proxy='localhost,127.0.0.1,::1'echo 'proxy has been set to: $proxy'curl ipinfo.io&quot;# åœ¨ shell ä¸­åœç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨alias proxy-=&quot;\\unset http_proxy https_proxy all_proxy no_proxyecho 'proxy has been cleared'curl ipinfo.io&quot;EOF}alias proxy@@=proxy-aliasalias proxy#='echo &quot;\\[ç¯å¢ƒå˜é‡]PROXY_HOST é»˜è®¤çš„ä»£ç†æœåŠ¡çš„ä¸»æœºåœ°å€ï¼Œå¯ä»¥æ˜¯ ip æˆ– åŸŸåPROXY_PORT é»˜è®¤çš„ä»£ç†ç«¯å£ï¼ˆclash å’Œ ssr(shadowsocksRï¼Œé…¸é…¸ä¹³) ç­‰ç§‘å­¦ä¸Šç½‘è½¯ä»¶çš„é»˜è®¤ç«¯å£æ˜¯ 7890ï¼‰ï¼Œ0-65535 ä¹‹é—´çš„æ•°å­—----------------------------------------[å‘½ä»¤]proxy# è¾“å‡ºä½¿ç”¨è¯´æ˜proxy+ åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œé»˜è®¤é‡‡ç”¨æœ¬æœºä¸Šçš„ 7890 ç«¯å£ï¼ˆclash å’Œ ssr ç­‰ç§‘å­¦ä¸Šç½‘è½¯ä»¶çš„é»˜è®¤ç«¯å£ï¼‰çš„ä»£ç†æœåŠ¡ã€‚å¦‚æœè¦æŒ‡å®šç«¯å£ï¼Œè¿è¡Œå½¢å¦‚ PROXY_PORT=&lt;port&gt; proxy+proxy++ åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œä»£ç†æœåŠ¡æ¥è‡ª ssh è¿æ¥åˆ°è¿™å°æœºå™¨çš„è¿œç¨‹æœºå™¨ï¼ˆä»…é€‚ç”¨äºå±€åŸŸç½‘ï¼‰ã€‚å¦‚æœè¦æŒ‡å®šç«¯å£ï¼Œè¿è¡Œå½¢å¦‚ PROXY_PORT=&lt;port&gt; proxy++proxy- åœç”¨ shell ä¸­çš„ä»£ç†proxy@ æ‰“å° export å‘½ä»¤ï¼Œç”¨äºå¯ç”¨ shell ä¸­çš„ä»£ç†ï¼ˆæ¥è‡ªè¿™å°æœºå™¨ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨ï¼‰proxy@@ æ‰“å° alias å‘½ä»¤ï¼Œç”¨äºå¯ç”¨å’Œåœç”¨ shell ä¸­çš„ä»£ç†ï¼ˆæ¥è‡ªè¿™å°æœºå™¨ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨ï¼‰&quot;'MOD_PROXY_sourced= ä½¿ç”¨è¯´æ˜å‡è®¾ä¸Šé¢çš„ä»£ç ä½äº /path/to/mod-proxy.shã€‚è¦åŠ è½½è¿™ä¸ªè„šæœ¬ï¼Œå°±åœ¨å‘½ä»¤è¡Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ 1source /path/to/mod-proxy.sh æˆ–è€…ä¿®æ”¹å½“å‰ç”¨æˆ·æ‰€ç”¨ shell çš„é…ç½®æ–‡ä»¶ï¼Œå¯¹äº bash å°±æ˜¯ âˆ¼/.bashrc ï¼Œå¯¹äº zsh å°±æ˜¯ âˆ¼/.zshrcã€‚æŠŠä¸Šé¢çš„å‘½ä»¤æ·»åŠ åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸­å»ã€‚ æ‰“å°å¸®åŠ©ä¿¡æ¯1234567891011121314$ proxy#[ç¯å¢ƒå˜é‡]PROXY_HOST é»˜è®¤çš„ä»£ç†æœåŠ¡çš„ä¸»æœºåœ°å€ï¼Œå¯ä»¥æ˜¯ ip æˆ– åŸŸåPROXY_PORT é»˜è®¤çš„ä»£ç†ç«¯å£ï¼ˆclash å’Œ ssr(shadowsocksRï¼Œé…¸é…¸ä¹³) ç­‰ç§‘å­¦ä¸Šç½‘è½¯ä»¶çš„é»˜è®¤ç«¯å£æ˜¯ 7890ï¼‰ï¼Œ0-65535 ä¹‹é—´çš„æ•°å­—----------------------------------------[å‘½ä»¤]proxy# è¾“å‡ºä½¿ç”¨è¯´æ˜proxy+ åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œé»˜è®¤é‡‡ç”¨æœ¬æœºä¸Šçš„ 7890 ç«¯å£ï¼ˆclash å’Œ ssr ç­‰ç§‘å­¦ä¸Šç½‘è½¯ä»¶çš„é»˜è®¤ç«¯å£ï¼‰çš„ä»£ç†æœåŠ¡ã€‚å¦‚æœè¦æŒ‡å®šç«¯å£ï¼Œè¿è¡Œå½¢å¦‚ PROXY_PORT=&lt;port&gt; proxy+proxy++ åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œä»£ç†æœåŠ¡æ¥è‡ª ssh è¿æ¥åˆ°è¿™å°æœºå™¨çš„è¿œç¨‹æœºå™¨ï¼ˆä»…é€‚ç”¨äºå±€åŸŸç½‘ï¼‰ã€‚å¦‚æœè¦æŒ‡å®šç«¯å£ï¼Œè¿è¡Œå½¢å¦‚ PROXY_PORT=&lt;port&gt; proxy++proxy- åœç”¨ shell ä¸­çš„ä»£ç†proxy@ æ‰“å° export å‘½ä»¤ï¼Œç”¨äºå¯ç”¨ shell ä¸­çš„ä»£ç†ï¼ˆæ¥è‡ªè¿™å°æœºå™¨ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨ï¼‰proxy@@ æ‰“å° alias å‘½ä»¤ï¼Œç”¨äºå¯ç”¨å’Œåœç”¨ shell ä¸­çš„ä»£ç†ï¼ˆæ¥è‡ªè¿™å°æœºå™¨ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨ï¼‰ æ‰“å° export å‘½ä»¤ï¼Œåœ¨å±€åŸŸç½‘çš„æŸå°æœºå™¨ä¸Šå¯ç”¨æœ¬æœºä¸Šä»£ç†1234567891011121314151617# å¯æ¥å— 1 ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®š host:portã€‚å¦‚æœè¦å•ç‹¬æŒ‡å®š hostï¼Œå†™ä½œ hostï¼›å¦‚æœè¦å•ç‹¬æŒ‡å®š portï¼Œå†™ä½œ :portï¼›å¦‚æœçœç•¥å‚æ•°ï¼Œåˆ™ç”¨ $PROXY_HOST:$PROXY_PORTã€‚$ proxy@# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨export https_proxy=http://192.168.1.2:7890export http_proxy=http://192.168.1.2:7890export all_proxy=socks5://192.168.1.2:7890export no_proxy='localhost,127.0.0.1,::1'# ç”¨ä»¥ä¸‹å‘½ä»¤åœç”¨ä»£ç†# unset http_proxy https_proxy all_proxy no_proxy$ proxy@ 192.168.1.66# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨export https_proxy=http://192.168.1.66:7890export http_proxy=http://192.168.1.66:7890export all_proxy=socks5://192.168.1.66:7890export no_proxy='localhost,127.0.0.1,::1'# ç”¨ä»¥ä¸‹å‘½ä»¤åœç”¨ä»£ç†# unset http_proxy https_proxy all_proxy no_proxy ä¸Šè¿°å‘½ä»¤è¾“å‡ºå‡ ä¸ª export å‘½ä»¤ï¼Œå¯ä»¥åœ¨åŒä¸€å±€åŸŸç½‘ä¸­çš„ä»»ä½• Linux æœºå™¨çš„å‘½ä»¤è¡Œä¸­è¿è¡Œï¼Œå³å¯å¯ç”¨ä»£ç†ã€‚ å¦‚æœè¦å–æ¶ˆä»£ç†ï¼Œåœ¨é‚£å°æœºå™¨çš„å‘½ä»¤è¡Œä¸­è¿è¡Œ 1unset http_proxy https_proxy all_proxy no_proxy æ‰“å° alias å‘½ä»¤ï¼Œåœ¨å±€åŸŸç½‘çš„æŸå°æœºå™¨ä¸Šå¯ç”¨å’Œåœç”¨æœ¬æœºä¸Šä»£ç†123456789101112131415161718192021222324252627# å¯æ¥å— 1 ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®š host:portã€‚å¦‚æœè¦å•ç‹¬æŒ‡å®š hostï¼Œå†™ä½œ hostï¼›å¦‚æœè¦å•ç‹¬æŒ‡å®š portï¼Œå†™ä½œ :portï¼›å¦‚æœçœç•¥å‚æ•°ï¼Œåˆ™ç”¨ $PROXY_HOST:$PROXY_PORTã€‚$ proxy@@# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨alias proxy+=&quot;export https_proxy=http://192.168.1.2:7890export http_proxy=http://192.168.1.2:7890export all_proxy=socks5://192.168.1.2:7890export no_proxy='localhost,127.0.0.1,::1'echo 'proxy has been set to: 192.168.1.2:7890'curl ipinfo.io&quot;# åœ¨ shell ä¸­åœç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨alias proxy-=&quot;unset http_proxy https_proxy all_proxy no_proxyecho 'proxy has been cleared'curl ipinfo.io&quot;$ proxy@@ 192.168.1.66# åœ¨ shell ä¸­å¯ç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨alias proxy+=&quot;export https_proxy=http://192.168.1.66:7890export http_proxy=http://192.168.1.66:7890export all_proxy=socks5://192.168.1.66:7890export no_proxy='localhost,127.0.0.1,::1'echo 'proxy has been set to: 192.168.1.66:7890'curl ipinfo.io&quot;# åœ¨ shell ä¸­åœç”¨ä»£ç†ï¼Œå‘½ä»¤å¯åœ¨å±€åŸŸç½‘ä¸­çš„å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨alias proxy-=&quot;unset http_proxy https_proxy all_proxy no_proxyecho 'proxy has been cleared'curl ipinfo.io&quot; ä¸Šè¿°å‘½ä»¤å¯è¾“å‡º 2 ä¸ª alias å‘½ä»¤ï¼Œå¯ä»¥åœ¨åŒä¸€å±€åŸŸç½‘ä¸­çš„ä»»ä½• Linux æœºå™¨çš„å‘½ä»¤è¡Œä¸­è¿è¡Œï¼Œä»¥ç”Ÿæˆåˆ«åï¼š proxy+åœ¨ shell ä¸­å¯ç”¨ä»£ç† 123456789101112$ proxy+proxy has been set to: 192.168.1.2:7890{ &quot;ip&quot;: &quot;103.47.100.220&quot;, &quot;city&quot;: &quot;Sham Shui Po&quot;, &quot;region&quot;: &quot;Sham Shui Po&quot;, &quot;country&quot;: &quot;HK&quot;, &quot;loc&quot;: &quot;22.3302,114.1595&quot;, &quot;org&quot;: &quot;AS38136 Akari Networks&quot;, &quot;timezone&quot;: &quot;Asia/Hong_Kong&quot;, &quot;readme&quot;: &quot;https://ipinfo.io/missingauth&quot;} proxy-åœ¨ shell ä¸­åœç”¨ä»£ç† 123456789101112$ proxy-proxy has been cleared{ &quot;ip&quot;: &quot;111.3.34.208&quot;, &quot;city&quot;: &quot;Shanghai&quot;, &quot;region&quot;: &quot;Shanghai&quot;, &quot;country&quot;: &quot;CN&quot;, &quot;loc&quot;: &quot;31.2222,121.4581&quot;, &quot;org&quot;: &quot;AS56041 China Mobile communications corporation&quot;, &quot;timezone&quot;: &quot;Asia/Shanghai&quot;, &quot;readme&quot;: &quot;https://ipinfo.io/missingauth&quot;} shell å‘½ä»¤ï¼šproxy+ã€proxy++ å’Œ proxy-proxy+åœ¨ shell ä¸­å¯ç”¨æœ¬æœºä¸Šä»£ç† 12345678910111213# å¯æ¥å— 1 ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®š host:portã€‚å¦‚æœè¦å•ç‹¬æŒ‡å®š hostï¼Œå†™ä½œ hostï¼›å¦‚æœè¦å•ç‹¬æŒ‡å®š portï¼Œå†™ä½œ :portï¼›å¦‚æœçœç•¥å‚æ•°ï¼Œåˆ™ç”¨ $PROXY_HOST:$PROXY_PORTã€‚$ proxy+proxy has been set to: 192.168.1.2:7890{ &quot;ip&quot;: &quot;103.47.100.220&quot;, &quot;city&quot;: &quot;Sham Shui Po&quot;, &quot;region&quot;: &quot;Sham Shui Po&quot;, &quot;country&quot;: &quot;HK&quot;, &quot;loc&quot;: &quot;22.3302,114.1595&quot;, &quot;org&quot;: &quot;AS38136 Akari Networks&quot;, &quot;timezone&quot;: &quot;Asia/Hong_Kong&quot;, &quot;readme&quot;: &quot;https://ipinfo.io/missingauth&quot;} proxy++åœ¨ shell ä¸­å¯ç”¨è¿œç¨‹ä»£ç†ï¼Œä»£ç†æœåŠ¡æ¥è‡ª ssh è¿æ¥åˆ°è¿™å°æœºå™¨çš„è¿œç¨‹æœºå™¨ï¼ˆä»…é€‚ç”¨äºå±€åŸŸç½‘ï¼‰ 123456789101112131415161718192021222324$ proxy++proxy has been set to: 192.168.1.66:7890{ &quot;ip&quot;: &quot;103.47.100.220&quot;, &quot;city&quot;: &quot;Sham Shui Po&quot;, &quot;region&quot;: &quot;Sham Shui Po&quot;, &quot;country&quot;: &quot;HK&quot;, &quot;loc&quot;: &quot;22.3302,114.1595&quot;, &quot;org&quot;: &quot;AS38136 Akari Networks&quot;, &quot;timezone&quot;: &quot;Asia/Hong_Kong&quot;, &quot;readme&quot;: &quot;https://ipinfo.io/missingauth&quot;}$ PROXY_PORT=1234 proxy++proxy has been set to: 192.168.1.66:1234{ &quot;ip&quot;: &quot;103.47.100.220&quot;, &quot;city&quot;: &quot;Sham Shui Po&quot;, &quot;region&quot;: &quot;Sham Shui Po&quot;, &quot;country&quot;: &quot;HK&quot;, &quot;loc&quot;: &quot;22.3302,114.1595&quot;, &quot;org&quot;: &quot;AS38136 Akari Networks&quot;, &quot;timezone&quot;: &quot;Asia/Hong_Kong&quot;, &quot;readme&quot;: &quot;https://ipinfo.io/missingauth&quot;} proxy-åœ¨ shell ä¸­åœç”¨æœ¬æœºä¸Šä»£ç† 123456789101112$ proxy-proxy has been cleared{ &quot;ip&quot;: &quot;111.3.34.208&quot;, &quot;city&quot;: &quot;Shanghai&quot;, &quot;region&quot;: &quot;Shanghai&quot;, &quot;country&quot;: &quot;CN&quot;, &quot;loc&quot;: &quot;31.2222,121.4581&quot;, &quot;org&quot;: &quot;AS56041 China Mobile communications corporation&quot;, &quot;timezone&quot;: &quot;Asia/Shanghai&quot;, &quot;readme&quot;: &quot;https://ipinfo.io/missingauth&quot;}","link":"/2022/08/02/7.Shell%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%9C%A8Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BC%80%E5%90%AF%E4%BB%A3%E7%90%86/"},{"title":"Pythonåœ¨å‘½ä»¤è¡Œä¿®æ”¹Propertiesé…ç½®æ–‡ä»¶","text":"èƒŒæ™¯æˆ‘åœ¨å¹³å¸¸çš„å·¥ä½œä¸­ï¼Œç»å¸¸éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶çš„æ ¼å¼å¤šç§å¤šæ ·ï¼Œæœ‰ä¸€ç§é…ç½®æ–‡ä»¶æœ€ä¸ºå¸¸è§ï¼Œå°±æ˜¯æ¯ä¸€è¡Œå½¢å¦‚ name=value æ ¼å¼ï¼Œä¾‹å¦‚ Java Propertiesã€‚åœ¨ç¼–å†™è¿™ä¸ªè„šæœ¬ä»¥å‰ï¼Œæˆ‘å¸¸å¸¸ç”¨ sed å‘½ä»¤æ¥åšå¢åˆ æ”¹æŸ¥ï¼Œä¸è¿‡æˆ‘è§‰å¾—è¿™å¹¶ä¸è¶³å¤Ÿæ–¹ä¾¿ã€‚ äºæ˜¯æˆ‘ä¸“é—¨å†™äº†ä¸€ä¸ª Python å‘½ä»¤è¡Œå·¥å…·ï¼Œæ¥æ‰¹é‡å¢åˆ æ”¹æŸ¥ä¸Šè¿°æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨æ—¶æ³¨æ„è¦ç»™ç”¨æˆ·å¯¹è¢«å¤„ç†çš„é…ç½®æ–‡ä»¶æˆäºˆå¿…è¦æƒé™ï¼Œæ¯”å¦‚ r å’Œ wã€‚ ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/41e33d761c1e532d5e0b89502bd21414 æ–‡ä»¶åç§°ä¸º config_props.pyï¼Œå®ç°å¦‚ä¸‹ï¼š config_props.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280#!/usr/bin/env python3# coding: utf-8assert __name__ == &quot;__main__&quot;, &quot;ä¸èƒ½è¢«å¼•å…¥æ¨¡å—&quot;__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1, 1)from argparse import ArgumentParser, RawTextHelpFormatterfrom sys import argvparser = ArgumentParser( description=&quot;å¢åˆ æ”¹æŸ¥ç±»å¦‚ Java Properties æ ¼å¼çš„é…ç½®æ–‡ä»¶&quot;, epilog=&quot;ğŸ˜† å‹æƒ…æç¤ºï¼š\\næ¯é¡¹ property éƒ½æ˜¯å•è¡Œçš„ï¼Œå¦‚æœè¦æ¢è¡Œï¼Œ&quot; &quot;è¯·åœ¨ä¸Šä¸€è¡Œçš„æœ«å°¾åŠ åæ–œæ ï¼ˆç»­è¡Œç¬¦ï¼‰\\\\&quot;, formatter_class=RawTextHelpFormatter,)subparsers = parser.add_subparsers(dest=&quot;command&quot;, help=&quot;Available commands&quot;)parser_get = subparsers.add_parser( &quot;get&quot;, formatter_class=RawTextHelpFormatter, help=&quot;è¯»å–é…ç½®ï¼šconfig_props.py get path name ...&quot;,)parser_get.add_argument(&quot;path&quot;, help=&quot;é…ç½®æ–‡ä»¶è·¯å¾„&quot;)parser_get.add_argument( &quot;patterns&quot;, metavar=&quot;pattern&quot;, nargs=&quot;+&quot;, help=&quot;å±æ€§åæˆ–æ¨¡å¼&quot;)parser_get.add_argument( &quot;-t&quot;, &quot;--type&quot;, choices=(&quot;raw&quot;, &quot;wild&quot;, &quot;re&quot;), default=&quot;raw&quot;, help=&quot;&quot;&quot;å±æ€§åä½œä¸ºä»€ä¹ˆæ¨¡å¼å¤„ç†ï¼š raw(é»˜è®¤): è§†ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼› wild: è§†ä¸º unix é€šé…ç¬¦æ¨¡å¼ï¼› re: è§†ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ã€‚&quot;&quot;&quot;,)parser_get.add_argument( &quot;-s&quot;, &quot;--sign&quot;, default=&quot;=&quot;, help=&quot;å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º =&quot;,)parser_get.add_argument( &quot;-e&quot;, &quot;--encoding&quot;, help=&quot;é…ç½®æ–‡ä»¶çš„ç¼–ç &quot;,)parser_set = subparsers.add_parser( &quot;set&quot;, formatter_class=RawTextHelpFormatter, help=&quot;æ›´æ–°é…ç½®ï¼šconfig_props.py set path name value ...&quot;,)parser_set.add_argument(&quot;path&quot;, help=&quot;é…ç½®æ–‡ä»¶è·¯å¾„&quot;)parser_set.add_argument( &quot;pairs&quot;, metavar=&quot;name value&quot;, nargs=&quot;+&quot;, help=&quot;å±æ€§åå’Œå±æ€§å€¼çš„å¯¹å¶ï¼Œæ­¤å‚æ•°å¿…é¡»ä¼ å¶æ•°ä¸ª&quot;,)parser_set.add_argument( &quot;-s&quot;, &quot;--sign&quot;, default=&quot;=&quot;, help=&quot;å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º =&quot;,)parser_set.add_argument( &quot;-e&quot;, &quot;--encoding&quot;, help=&quot;é…ç½®æ–‡ä»¶çš„ç¼–ç &quot;,)parser_del = subparsers.add_parser( &quot;del&quot;, formatter_class=RawTextHelpFormatter, help=&quot;åˆ é™¤é…ç½®ï¼šconfig_props.py del path name ...&quot;,)parser_del.add_argument(&quot;path&quot;, help=&quot;é…ç½®æ–‡ä»¶è·¯å¾„&quot;)parser_del.add_argument(&quot;patterns&quot;, metavar=&quot;pattern&quot;, nargs=&quot;+&quot;, help=&quot;å±æ€§åæˆ–æ¨¡å¼&quot;)parser_del.add_argument( &quot;-t&quot;, &quot;--type&quot;, choices=(&quot;raw&quot;, &quot;wild&quot;, &quot;re&quot;), default=&quot;raw&quot;, help=&quot;&quot;&quot;å±æ€§åä½œä¸ºä»€ä¹ˆæ¨¡å¼å¤„ç†ï¼š raw(é»˜è®¤): è§†ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼› wild: è§†ä¸º unix é€šé…ç¬¦æ¨¡å¼ï¼› re: è§†ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ã€‚&quot;&quot;&quot;,)parser_del.add_argument( &quot;-s&quot;, &quot;--sign&quot;, default=&quot;=&quot;, help=&quot;å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º =&quot;,)parser_del.add_argument( &quot;-e&quot;, &quot;--encoding&quot;, help=&quot;é…ç½®æ–‡ä»¶çš„ç¼–ç &quot;,)parser_uplines = subparsers.add_parser( &quot;uplines&quot;, formatter_class=RawTextHelpFormatter, help=&quot;æ›´æ–°é…ç½®ï¼šconfig_props.py uplines path name=value ...&quot;,)parser_uplines.add_argument(&quot;path&quot;, help=&quot;é…ç½®æ–‡ä»¶è·¯å¾„&quot;)parser_uplines.add_argument( &quot;lines&quot;, metavar=&quot;line&quot;, nargs=&quot;+&quot;, help=&quot;&quot;&quot;å½¢å¦‚ï¼š 1. name: åˆ é™¤åç§°æ˜¯nameçš„å±æ€§ï¼› 2. name=value: æ›´æ–°åç§°æ˜¯nameçš„å±æ€§ã€‚&quot;&quot;&quot;,)parser_uplines.add_argument( &quot;-s&quot;, &quot;--sign&quot;, default=&quot;=&quot;, help=&quot;å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º =&quot;,)parser_uplines.add_argument( &quot;-e&quot;, &quot;--encoding&quot;, help=&quot;é…ç½®æ–‡ä»¶çš„ç¼–ç &quot;,)# TODO: æ·»åŠ å‘½ä»¤ commentï¼Œå¢åˆ æ”¹å±æ€§ä¸Šé¢çš„æ³¨é‡Šï¼šconfig_props.py comment path name=value ...# TODO: æ·»åŠ å‘½ä»¤ mergeï¼Œåˆå¹¶å¤šä¸ªé…ç½®æ–‡ä»¶ï¼šconfig_props.py merge path path2 ...if len(argv) &lt; 2 or argv[1] not in (&quot;get&quot;, &quot;set&quot;, &quot;del&quot;, &quot;uplines&quot;): args = parser.parse_args([&quot;-h&quot;])args = parser.parse_args()sign = args.signassert len(sign) == 1, &quot;å±æ€§åå’Œå€¼çš„åˆ†éš”ç¬¦ sign å¿…é¡»æ˜¯å•å­—ç¬¦ï¼Œæ¯”å¦‚ =&quot;import reCRE_PROPLINE = re.compile(fr&quot;^[\\t ]*(?!#)(?P&lt;name&gt;[^{sign}\\s]+)[\\t ]*{sign}[\\t ]*(?P&lt;value&gt;.*)&quot;, re.M)class ConfigProps: &quot;&quot;&quot;é…ç½®æ–‡ä»¶ç®¡ç†å™¨ :param path: é…ç½®æ–‡ä»¶è·¯å¾„ :param encoding: é…ç½®æ–‡ä»¶çš„ç¼–ç ï¼Œé»˜è®¤ä¸º Noneï¼Œå³æ ¹æ®ç³»ç»Ÿç»™å®š &quot;&quot;&quot; def __init__(self, path, encoding=None): self._path = path self.encoding = encoding self.read() def __contains__(self, name): return name in self._map def __len__(self): return len(self._map) def __getitem__(self, name): return self._map[name] @property def path(self): &quot;é…ç½®æ–‡ä»¶è·¯å¾„&quot; return self._path def read(self): &quot;ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–é…ç½®&quot; try: self._lines = lines = open(self._path, &quot;r&quot;, encoding=self.encoding).readlines() except FileNotFoundError: self._lines = [] self._map = {} return if lines and not lines[-1].endswith(&quot;\\n&quot;): lines[-1] += &quot;\\n&quot; self._map = map_ = {} for lineno, line in enumerate(lines): match = CRE_PROPLINE.search(line) if match is not None: map_[match[&quot;name&quot;]] = [match[&quot;value&quot;], lineno] def write(self): &quot;æŠŠæœ€æ–°çš„é…ç½®å†™å…¥é…ç½®æ–‡ä»¶&quot; open(self._path, &quot;w&quot;, encoding=self.encoding).writelines(self._lines) def search(self, *pats, type=&quot;raw&quot;): &quot;&quot;&quot;ç”Ÿæˆå™¨ï¼Œä»é…ç½®æ–‡ä»¶ä¸­ç­›é€‰å±æ€§åç¬¦åˆä»»ä¸€æ¨¡å¼çš„å±æ€§è¡Œ :param pats: å±æ€§åçš„æ¨¡å¼ :param type: ä»¥ä½•ç§æ¨¡å¼å¤„ç†ï¼š raw(é»˜è®¤): è§†ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼› wild: è§†ä¸º unix é€šé…ç¬¦æ¨¡å¼ï¼› re: è§†ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ã€‚ :return: è¿­ä»£å™¨ &quot;&quot;&quot; lines, map_ = self._lines, self._map if not pats: return pats = frozenset(pats) if type == &quot;raw&quot;: predicate = pats.__contains__ elif type == &quot;wild&quot;: from fnmatch import translate predicate = re.compile(&quot;|&quot;.join(map(translate, pats))).fullmatch elif type == &quot;re&quot;: predicate = re.compile(&quot;|&quot;.join(f&quot;(?:{pat})&quot; for pat in pats)).fullmatch else: raise ValueError(f&quot;Unacceptable type value: {type!r}&quot;) for name, (value, lineno) in map_.items(): if predicate(name): yield name, value, lineno def select(self, *pats, type=&quot;raw&quot;): lines = self._lines for _, _, lineno in self.search(*pats, type=type): print(lines[lineno].rstrip(&quot;\\n&quot;)) def delete(self, *pats, type=&quot;raw&quot;): lines, map_ = self._lines, self._map meets = tuple(self.search(*pats, type=type)) t = tuple(map_.values()) for n, (name, value, lineno) in enumerate(meets): line = lines[lineno-n] # åˆ é™¤ 1 è¡Œåï¼Œè¿™è¡Œåé¢çš„æ¯ 1 è¡Œåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä¼š -1 for e in t[lineno+1:]: e[1] -= 1 del map_[name] del lines[lineno-n] print(&quot;Deleted:&quot;, name, &quot;\\n &lt;=&quot;, line.rstrip(&quot;\\n&quot;)) return len(meets) def insert(self, name, value, line=None): lines, map_ = self._lines, self._map if line is None: line = f&quot;{name}={value}\\n&quot; lines.append(line) map_[name] = (value, len(lines)) print(&quot;Inserted:&quot;, name, &quot;\\n =&gt;&quot;, line.rstrip(&quot;\\n&quot;), &quot;&quot;) def update(self, name, value, line=None): lines, map_ = self._lines, self._map if line is None: line = f&quot;{name}={value}\\n&quot; lineno = map_[name][1] map_[name] = value, lineno line_old = lines[lineno] lines[lineno] = line print(&quot;Updated:&quot;, line_old.rstrip(&quot;\\n&quot;), &quot;\\n =&gt;&quot;, line.rstrip(&quot;\\n&quot;)) def upsert(self, name, value, line=None): map_ = self._map if name in map_: self.update(name, value, line) else: self.insert(name, value, line) def update_lines(self, *lines): n = 0 for line in lines: match = CRE_PROPLINE.search(line) if match is None: name = line if name in conf_props: self.delete(name) else: print(&quot;ğŸ˜‚ ignored:&quot;, name) continue else: line += &quot;\\n&quot; name, value = match[&quot;name&quot;], match[&quot;value&quot;] self.upsert(name, value, line) n += 1 return ncommand = args.commandpath = args.pathencoding = args.encodingconf_props = ConfigProps(path)if command == &quot;get&quot;: patterns = args.patterns type = args.type conf_props.select(*patterns, type=type)elif command == &quot;set&quot;: pairs = args.pairs names = pairs[::2] values = pairs[1::2] for name, value in zip(names, values): conf_props.upsert(name, value) if names and values: conf_props.write()elif command == &quot;del&quot;: patterns = args.patterns type = args.type if conf_props.delete(*patterns, type=type): conf_props.write()elif command == &quot;uplines&quot;: lines = args.lines if conf_props.update_lines(*lines): conf_props.write()else: raise NotImplementedError ä½¿ç”¨è¯´æ˜å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 123456789101112131415161718$ python config_props.py -husage: config_props.py [-h] {get,set,del,uplines} ...å¢åˆ æ”¹æŸ¥ç±»å¦‚ Java Properties æ ¼å¼çš„é…ç½®æ–‡ä»¶positional arguments: {get,set,del,uplines} Available commands get è¯»å–é…ç½®ï¼šconfig_props.py get path name ... set æ›´æ–°é…ç½®ï¼šconfig_props.py set path name value ... del åˆ é™¤é…ç½®ï¼šconfig_props.py del path name ... uplines æ›´æ–°é…ç½®ï¼šconfig_props.py uplines path name=value ...optional arguments: -h, --help show this help message and exitğŸ˜† å‹æƒ…æç¤ºï¼šæ¯é¡¹ property éƒ½æ˜¯å•è¡Œçš„ï¼Œå¦‚æœè¦æ¢è¡Œï¼Œè¯·åœ¨ä¸Šä¸€è¡Œçš„æœ«å°¾åŠ åæ–œæ ï¼ˆç»­è¡Œç¬¦ï¼‰\\ ç°åœ¨å‡è®¾å¾…å¤„ç†çš„é…ç½®æ–‡ä»¶ example.properties çš„å†…å®¹å¦‚ä¸‹ï¼š example.properties1234567891011121314151617## ä»¥ä¸‹æ˜¯æ•°æ®åº“è¿æ¥ä¿¡æ¯# æ•°æ®åº“ç³»ç»Ÿdb.dialet = mysql# ä¸»æœºdb.host = localhost# ç«¯å£db.port = 3306# ç”¨æˆ·ådb.username = root# å¯†ç db.password =# æ•°æ®åº“db.database =# ä¸‹é¢æ˜¯ foo ä¸šåŠ¡è¦ç”¨åˆ°çš„è¡¨foo.table = relation ç›®å‰å®ç°äº† 4 ä¸ªå­å‘½ä»¤ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š 1. get å‘½ä»¤å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 123456789101112131415161718$ python config_props.py get -husage: config_props.py get [-h] [-t {raw,wild,re}] [-s SIGN] path pattern [pattern ...]positional arguments: path é…ç½®æ–‡ä»¶è·¯å¾„ pattern å±æ€§åæˆ–æ¨¡å¼optional arguments: -h, --help show this help message and exit -t {raw,wild,re}, --type {raw,wild,re} å±æ€§åä½œä¸ºä»€ä¹ˆæ¨¡å¼å¤„ç†ï¼š raw(é»˜è®¤): è§†ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼› wild: è§†ä¸º unix é€šé…ç¬¦æ¨¡å¼ï¼› re: è§†ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ã€‚ -s SIGN, --sign SIGN å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º = -e ENCODING, --encoding ENCODING é…ç½®æ–‡ä»¶çš„ç¼–ç  ä½¿ç”¨åç§°æœç´¢ï¼š 123$ python config_props.py get example.properties db.dialet foo.table non.exists.namedb.dialet = mysqlfoo.table = relation ä½¿ç”¨ unix è·¯å¾„é€šé…ç¬¦æ¨¡å¼æœç´¢ï¼š 1234567$ python config_props.py get example.properties 'db.*' -t wilddb.dialet = mysqldb.host = localhostdb.port = 3306db.username = rootdb.password =db.database = ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼æœç´¢ï¼š 1234567$ python config_props.py get example.properties 'db\\..*' -t redb.dialet = mysqldb.host = localhostdb.port = 3306db.username = rootdb.password =db.database = 2. set å‘½ä»¤å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 123456789101112$ python config_props.py set -husage: config_props.py set [-h] [-s SIGN] path name value [name value ...]positional arguments: path é…ç½®æ–‡ä»¶è·¯å¾„ name value å±æ€§åå’Œå±æ€§å€¼çš„å¯¹å¶ï¼Œæ­¤å‚æ•°å¿…é¡»ä¼ å¶æ•°ä¸ªoptional arguments: -h, --help show this help message and exit -s SIGN, --sign SIGN å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º = -e ENCODING, --encoding ENCODING é…ç½®æ–‡ä»¶çš„ç¼–ç  æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1234567$ python config_props.py set example.properties db.password 123456 db.database test foo.bar ğŸ˜‚ğŸ¤£ğŸ˜†ğŸ˜…Updated: db.password = =&gt; db.password=123456Updated: db.database = =&gt; db.database=testInserted: foo.bar =&gt; foo.bar=ğŸ˜‚ğŸ¤£ğŸ˜†ğŸ˜… é…ç½®æ–‡ä»¶ example.properties è¢«æ›´æ–°ä¸ºï¼š example.properties12345678910111213141516171819## ä»¥ä¸‹æ˜¯æ•°æ®åº“è¿æ¥ä¿¡æ¯# æ•°æ®åº“ç³»ç»Ÿdb.dialet = mysql# ä¸»æœºdb.host = localhost# ç«¯å£db.port = 3306# ç”¨æˆ·ådb.username = root# å¯†ç db.password=123456# æ•°æ®åº“db.database=test# ä¸‹é¢æ˜¯ foo ä¸šåŠ¡è¦ç”¨åˆ°çš„è¡¨foo.table = relationfoo.bar=ğŸ˜‚ğŸ¤£ğŸ˜†ğŸ˜… 3. del å‘½ä»¤å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 123456789101112131415161718$ python config_props.py del -husage: config_props.py del [-h] [-t {raw,wild,re}] [-s SIGN] path pattern [pattern ...]positional arguments: path é…ç½®æ–‡ä»¶è·¯å¾„ pattern å±æ€§åæˆ–æ¨¡å¼optional arguments: -h, --help show this help message and exit -t {raw,wild,re}, --type {raw,wild,re} å±æ€§åä½œä¸ºä»€ä¹ˆæ¨¡å¼å¤„ç†ï¼š raw(é»˜è®¤): è§†ä¸ºæ™®é€šå­—ç¬¦ä¸²ï¼› wild: è§†ä¸º unix é€šé…ç¬¦æ¨¡å¼ï¼› re: è§†ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ã€‚ -s SIGN, --sign SIGN å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º = -e ENCODING, --encoding ENCODING é…ç½®æ–‡ä»¶çš„ç¼–ç  æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 123$ python config_props.py del example.properties foo.bar foo.bazDeleted: foo.bar &lt;= foo.bar=ğŸ˜‚ğŸ¤£ğŸ˜†ğŸ˜… é…ç½®æ–‡ä»¶ example.properties è¢«æ›´æ–°ä¸ºï¼š example.properties123456789101112131415161718## ä»¥ä¸‹æ˜¯æ•°æ®åº“è¿æ¥ä¿¡æ¯# æ•°æ®åº“ç³»ç»Ÿdb.dialet = mysql# ä¸»æœºdb.host = localhost# ç«¯å£db.port = 3306# ç”¨æˆ·ådb.username = root# å¯†ç db.password=123456# æ•°æ®åº“db.database=test# ä¸‹é¢æ˜¯ foo ä¸šåŠ¡è¦ç”¨åˆ°çš„è¡¨foo.table = relation 4. uplines å‘½ä»¤å‘½ä»¤å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š 1234567891011121314$ python config_props.py uplines -husage: config_props.py uplines [-h] [-s SIGN] path line [line ...]positional arguments: path é…ç½®æ–‡ä»¶è·¯å¾„ line å½¢å¦‚ï¼š 1. name: åˆ é™¤åç§°æ˜¯nameçš„å±æ€§ï¼› 2. name=value: æ›´æ–°åç§°æ˜¯nameçš„å±æ€§ã€‚optional arguments: -h, --help show this help message and exit -s SIGN, --sign SIGN å±æ€§å’Œå€¼çš„åˆ†ç•Œï¼Œå¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦ï¼Œé»˜è®¤ä¸º = -e ENCODING, --encoding ENCODING é…ç½®æ–‡ä»¶çš„ç¼–ç  æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 12345678$ python config_props.py uplines example.properties db.username=test db.password=randomXYZ foo.table foo.barUpdated: db.username = root =&gt; db.username=testUpdated: db.password=123456 =&gt; db.password=randomXYZDeleted: foo.table &lt;= foo.table = relationğŸ˜‚ ignored: foo.bar é…ç½®æ–‡ä»¶ example.properties è¢«æ›´æ–°ä¸ºï¼š example.properties1234567891011121314151617## ä»¥ä¸‹æ˜¯æ•°æ®åº“è¿æ¥ä¿¡æ¯# æ•°æ®åº“ç³»ç»Ÿdb.dialet = mysql# ä¸»æœºdb.host = localhost# ç«¯å£db.port = 3306# ç”¨æˆ·ådb.username=test# å¯†ç db.password=randomXYZ# æ•°æ®åº“db.database=test# ä¸‹é¢æ˜¯ foo ä¸šåŠ¡è¦ç”¨åˆ°çš„è¡¨ æœªæ¥è§„åˆ’å…¶å®æˆ‘æ—©å°±å®Œæˆäº†ï¼Œå¢åˆ æ”¹æŸ¥å…¶ä»–æ ¼å¼é…ç½®æ–‡ä»¶çš„å‘½ä»¤è¡Œè„šæœ¬ï¼Œè¯¸å¦‚ï¼š .config,.cnf,.conf,.cfg,.cg,.ini JSON XML YAML TOML ä½†å®ç°å¾—éƒ½æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸”è¿˜ç”¨åˆ°äº†ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œè€Œä¸”åœ¨æˆ‘çœ‹æ¥è¿˜ä¸å¤Ÿå®Œå–„ã€‚æˆ‘æ‰“ç®—ä¸ºå®ƒä»¬è®¾è®¡å¹¶å®ç°ä¸€ä¸ªç»Ÿä¸€çš„æ“ä½œæ–¹æ¡ˆï¼Œæä¾›ç±»ä¼¼ XQuery æˆ– SQL çš„å¢åˆ æ”¹æŸ¥ï¼Œç„¶åå†åˆ†äº«å‡ºæ¥ï¼Œæ•¬è¯·æœŸå¾…åç»­æ–‡ç« ã€‚","link":"/2022/08/26/9.Python%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BF%AE%E6%94%B9Properties%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"},{"title":"Pythonå‡½æ•°ä½œä¸ºå‘½ä»¤è¡Œä½¿ç”¨","text":"èƒŒæ™¯æˆ‘æœ€è¿‘äº†è§£äº†ä¸€ä¸ªå¿«é€Ÿæ„å»ºå‘½ä»¤è¡Œçš„å·¥å…· typerï¼Œå—åˆ°äº†ä¸€äº›å¯å‘ã€‚å®ƒå¯ä»¥æŠŠä¸€ç»„å¸¦æœ‰ç±»å‹æ³¨è§£çš„ Python å‡½æ•°ï¼Œå¿«é€Ÿåœ°è½¬æ¢æˆå‘½ä»¤è¡Œå·¥å…·ã€‚æˆ‘å°è¯•åªç”¨ Python çš„å†…å»ºåŒ…ï¼Œä¸å¼•å…¥ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œä¹Ÿå®ç°ä¸€ä¸ªç±»ä¼¼çš„å‘½ä»¤è¡Œå¿«é€Ÿæ„å»ºå·¥å…·ã€‚ä»£ç ä¼šæŒç»­æ›´æ–°ï¼Œä¹‹åä¼šåŠ å…¥æ›´å¼ºçš„åŠŸèƒ½ã€‚ ä»£ç å®ç° TIPS ä»£ç çš„æœ€æ–°ç‰ˆæœ¬åœ¨ GitHub Gist ä¸­ç»´æŠ¤https://gist.github.com/ChenyangGao/da8b5dc4370425edaef87237cd27fd15 æ³¨æ„ï¼šä½¿ç”¨ä¸‹é¢çš„ä»£ç ï¼Œè¯·ç”¨ Python 3.8 æˆ–è€…ä»¥ä¸Šç‰ˆæœ¬ã€‚ æ–‡ä»¶åç§°æ˜¯ func_cmdline.pyï¼ŒPython å®ç°ä»£ç å¦‚ä¸‹ï¼š func_cmdline.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159#!/usr/bin/env python3# coding: utf-8__author__ = &quot;ChenyangGao &lt;https://chenyanggao.github.io/&gt;&quot;__version__ = (0, 1, 1)__all__ = [&quot;func_cmdline&quot;]# Inspired by:# - https://pypi.org/project/typer/import inspectfrom argparse import ArgumentParser, Namespace, RawDescriptionHelpFormatterfrom functools import partialfrom textwrap import dedent, indentfrom typing import cast, Callable, Optionaldef func_cmdline( fn: Optional[Callable] = None, /, parser: Optional[ArgumentParser] = None, parse_map: dict[type, Callable] = {}, helpinfo_map: dict[str, str] = {}, ) -&gt; Callable: &quot;&quot;&quot;è£…é¥°å™¨è®©ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä½œä¸ºå‘½ä»¤è¡Œä½¿ç”¨ :param fn: è¢«è£…é¥°çš„å‡½æ•° :param parser: å‘½ä»¤è¡Œè§£æå™¨å¯¹è±¡ :param parse_map: ä¸åŒç±»å‹çš„è§£æå‡½æ•°çš„æ˜ å°„ï¼Œ å­—ç¬¦ä¸²é€šè¿‡ç›¸åº”çš„è§£æå‡½æ•°æ¥è½¬æ¢æˆå¯¹åº”å¯¹è±¡ï¼Œ å¦‚æœæ²¡æœ‰ç›¸åº”çš„è§£æå‡½æ•°ï¼Œåˆ™å°è¯•ç”¨å¯¹è±¡æœ¬èº« ï¼ˆå®ƒçš„æ„é€ å™¨ï¼‰ :param helpinfo_map: ä¸åŒå‚æ•°çš„å¸®åŠ©è¯´æ˜ï¼Œ ç”¨äºå‘½ä»¤è¡Œçš„å¸®åŠ©ä¿¡æ¯ :param: è¿”å‡½æ•°`fn`æœ¬èº«ï¼Œåªæ˜¯å®ƒèº«ä¸Šç»‘å®šäº†å‡ ä¸ªå±æ€§ .parser å­—æ®µï¼Œä½¿ç”¨çš„å‘½ä»¤è¡Œè§£æå™¨å¯¹è±¡ .parse() æ–¹æ³•ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•° .run() æ–¹æ³•ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°å¹¶è¿è¡Œå‡½æ•°`fn`ï¼Œ è¿”å›å‡½æ•°`fn`çš„æ‰§è¡Œç»“æœ :return: è¢«è£…é¥°å‡½æ•°æœ¬èº«ï¼Œæ·»åŠ äº†å‡ ä¸ªå±æ€§ &quot;&quot;&quot; if fn is None: return partial( func_cmdline, parser=parser, parse_map=parse_map, helpinfo_map=helpinfo_map, ) fn = cast(Callable, fn) params = inspect.signature(fn).parameters if parser is None: parser = ArgumentParser( formatter_class=RawDescriptionHelpFormatter) parser = cast(ArgumentParser, parser) if parser.epilog is None: parser.epilog = &quot;&quot; if fn.__doc__ is not None: parser.epilog += &quot;documentation:\\n&quot; + \\ indent(fn.__doc__, &quot; &quot;) parser.epilog += &quot;\\n\\nsource code:\\n&quot; + \\ indent(dedent(inspect.getsource(fn)), &quot; &quot;) abbrs: dict[str, int] = {} for name, param in params.items(): kargs: dict = {&quot;dest&quot;: name, &quot;help&quot;: helpinfo_map.get(name)} kind = param.kind if kind is inspect._ParameterKind.VAR_POSITIONAL: kargs[&quot;required&quot;] = False kargs[&quot;nargs&quot;] = &quot;*&quot; kargs[&quot;default&quot;] = [] elif kind is inspect._ParameterKind.VAR_KEYWORD: continue default = param.default if default is inspect._empty: kargs.setdefault(&quot;required&quot;, True) else: kargs[&quot;default&quot;] = default anno = param.annotation if anno is not inspect._empty: if anno is bool: kargs[&quot;required&quot;] = False if &quot;default&quot; in kargs: if kargs[&quot;default&quot;]: kargs[&quot;action&quot;] = &quot;store_false&quot; else: kargs[&quot;action&quot;] = &quot;store_true&quot; else: kargs[&quot;action&quot;] = &quot;store_true&quot; elif anno is list: kargs[&quot;nargs&quot;] = &quot;*&quot; elif getattr(anno, &quot;__origin__&quot;, None) is list and len(anno.__args__) == 1: kargs[&quot;nargs&quot;] = &quot;*&quot; kargs[&quot;type&quot;] = parse_map.get(anno.__args__[0], anno.__args__[0]) else: kargs[&quot;type&quot;] = parse_map.get(anno, anno) names = [] first_letter = name[0] n = abbrs.setdefault(first_letter, 0) if n == 0: abbr = first_letter else: abbr = f&quot;{first_letter}{n}&quot; abbrs[first_letter] += 1 names.append(f&quot;-{abbr}&quot;) names.append(f&quot;--{name}&quot;) if &quot;_&quot; in name: names.append(f&quot;--{name.replace('_', '-')}&quot;) parser.add_argument(*names, **kargs) def parse(argv: Optional[list[str]] = None) -&gt; Namespace: nonlocal parser parser = cast(ArgumentParser, parser) return parser.parse_args(argv) def run(argv: Optional[list[str]] = None): &quot;è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨&quot; nonlocal fn, parser fn = cast(Callable, fn) parser = cast(ArgumentParser, parser) args = parser.parse_args(argv).__dict__ pargs = [] kargs = {} for name, param in params.items(): kind = param.kind if name in args: if kind.value &lt; 2: pargs.append(args[name]) elif kind.value == 2: pargs.extend(args[name]) else: kargs[name] = args[name] return fn(*pargs, **kargs) setattr(fn, &quot;parser&quot;, parser) setattr(fn, &quot;parse&quot;, parse) setattr(fn, &quot;run&quot;, run) return fnif __name__ == &quot;__main__&quot;: from datetime import datetime @func_cmdline( parse_map={ datetime: lambda s: datetime.strptime(s, &quot;%Y-%m-%d %H:%M:%S&quot;), }, helpinfo_map=dict( a=&quot;å‚æ•°a&quot;, b=&quot;å‚æ•°b&quot;, c=&quot;å‚æ•°c&quot;, d=&quot;å‚æ•°d&quot;, e=&quot;å‚æ•°e&quot;, ) ) def foo( a: int, /, b: bool = False, *c: float, d: list[datetime], e: complex = 4, ): &quot;Example for function as command line.&quot; print(locals()) foo.run() ä½¿ç”¨è¯´æ˜æ¨¡å— func_cmdline.py è‡ªå¸¦äº†ä¸€ä¸ªå®ä¾‹ï¼š 12345678910111213141516171819from datetime import datetime@func_cmdline( parse_map={ datetime: lambda s: datetime.strptime(s, &quot;%Y-%m-%d %H:%M:%S&quot;), }, helpinfo_map=dict( a=&quot;å‚æ•°a&quot;, b=&quot;å‚æ•°b&quot;, c=&quot;å‚æ•°c&quot;, d=&quot;å‚æ•°d&quot;, e=&quot;å‚æ•°e&quot;, ))def foo( a: int, /, b: bool = True, *c: float, d: list[datetime], e: complex = 1j, ): &quot;Example for function as command line.&quot; print(locals())foo.run() ç›´æ¥è¿è¡Œæ¨¡å—ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132$ python func_cmdline.py -husage: func_cmdline.py [-h] -a A [-b] [-c [C ...]] -d [D ...] [-e E]optional arguments: -h, --help show this help message and exit -a A, --a A å‚æ•°a -b, --b å‚æ•°b -c [C ...], --c [C ...] å‚æ•°c -d [D ...], --d [D ...] å‚æ•°d -e E, --e E å‚æ•°edocumentation: Example for function as command line.source code: @func_cmdline( parse_map={ datetime: lambda s: datetime.strptime(s, &quot;%Y-%m-%d %H:%M:%S&quot;), }, helpinfo_map=dict( a=&quot;å‚æ•°a&quot;, b=&quot;å‚æ•°b&quot;, c=&quot;å‚æ•°c&quot;, d=&quot;å‚æ•°d&quot;, e=&quot;å‚æ•°e&quot;, ) ) def foo( a: int, /, b: bool = False, *c: float, d: list[datetime], e: complex = 1j, ): &quot;Example for function as command line.&quot; print(locals()) éšä¾¿ä¼ å…¥ä¸€äº›å¿…éœ€çš„å‚æ•°ï¼Œä¸ä¼ å¯é€‰å‚æ•°ï¼š 12$ python func_cmdline.py --a 1 --d '2021-01-01 00:00:00' '2021-02-01 00:00:00' '2021-03-01 00:00:00'{'a': 1, 'b': False, 'd': [datetime.datetime(2021, 1, 1, 0, 0), datetime.datetime(2021, 2, 1, 0, 0), datetime.datetime(2021, 3, 1, 0, 0)], 'e': 1j, 'c': ()} å¯¹å„ä¸ªå‚æ•°éšä¾¿ä¼ å…¥ä¸€äº›å¯ç”¨çš„å€¼ï¼š 12$ python func_cmdline.py --a 1 -b -c 2 3 4 --d '2021-01-01 00:00:00' '2021-02-01 00:00:00' '2021-03-01 00:00:00' -e '5+6j'{'a': 1, 'b': True, 'd': [datetime.datetime(2021, 1, 1, 0, 0), datetime.datetime(2021, 2, 1, 0, 0), datetime.datetime(2021, 3, 1, 0, 0)], 'e': (5+6j), 'c': (2.0, 3.0, 4.0)}","link":"/2022/08/13/8.Python%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8/"},{"title":"æ©ç ï¼ˆPythonå®ç°ï¼‰","text":"å…³äºæ©ç ä»€ä¹ˆæ˜¯æ ‡å¿—flagåœ¨æ©ç çš„è¯­å¢ƒä¸‹ï¼Œæ ‡å¿—flagï¼Œæ˜¯åªæœ‰1ä½çš„æ©ç ï¼Œå–å€¼èŒƒå›´$range(\\mathrm{flag})$æ»¡è¶³ï¼š$$range(\\mathrm{flag}) = {0, 1}$$ã€‚ flagå¯ä»¥æ˜¯ä¸€ä¸ªå•çº¯çš„å–å€¼èŒƒå›´ä¸º${0,1}$çš„äºŒå€¼çš„çŠ¶æ€é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºå¦ä¸€ä¸ªå–å€¼èŒƒå›´æ˜¯${s_1, s_2}$çš„äºŒå€¼çš„çŠ¶æ€é‡stateï¼Œæ‰€å»ºç«‹ä¸€ä¸€æ˜ å°„$$\\mathrm{flag}: {s_1, s_2} \\leftrightarrow {0,1}$$ã€‚ Note æ›´ä¸€èˆ¬è€Œä¸”å¸¸è§çš„ï¼Œæ ‡å¿—flagæ˜¯ä¸€ä¸ªç¦»æ•£çš„çŠ¶æ€é‡ï¼Œå–å€¼èŒƒå›´æ˜¯è‡ªç„¶æ•°é›†$\\N$çš„å­é›†ã€‚å®ƒå¯ä»¥æ˜¯å•çº¯çš„çŠ¶æ€é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ï¼šè®¾å­˜åœ¨ä¸€ä¸ªçŠ¶æ€é‡stateï¼Œå®ƒçš„å–å€¼èŒƒå›´$range(\\mathrm{state})$æ˜¯ç¦»æ•£çš„ï¼Œflagæ˜¯$range(\\mathrm{state})$åˆ°è‡ªç„¶æ•°é›†$\\N$çš„æ˜ å°„$$\\mathrm{flag}: range(\\mathrm{state}) \\to \\N$$ã€‚ä¹Ÿå³ï¼Œä½¿ç”¨ä¸åŒçš„è‡ªç„¶æ•°æ¥åˆ†åˆ«æšä¸¾å’ŒæŒ‡ä»£çŠ¶æ€é‡stateçš„å„ä¸ªçŠ¶æ€å€¼ã€‚ ä»€ä¹ˆæ˜¯æ©ç maskæ©ç maskï¼Œæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶çš„ä½æ¨¡å¼ï¼Œå–å€¼èŒƒå›´$range(\\mathrm{mask})$æ»¡è¶³ï¼š$$range(\\mathrm{mask}) = {0, 1}^n, n \\in \\N$$ã€‚ maskæ˜¯ä¸€ä¸ªçŠ¶æ€é‡ï¼Œæˆ–è€…çŠ¶æ€æ˜ å°„ï¼šç»™å®šçŠ¶æ€å‘é‡stateï¼Œæ˜¯ä¸€ç»„äºŒå€¼çš„çŠ¶æ€é‡${\\mathrm{state}i \\big| 0 &lt; i \\le n, n \\in \\N}$çš„åºåˆ—ï¼Œåˆ†åˆ«æœ‰å–å€¼èŒƒå›´$range(\\mathrm{state}i)={s{i, 1}, s{i, 2}}$ï¼Œmaskæ˜¯ç›¸å¯¹äºstateï¼Œæ‰€å»ºç«‹ä¸€ä¸€æ˜ å°„$$\\mathrm{mask}: \\underset{i=1}{\\overset{n}{\\times}}{s_{i, 1}, s_{i, 2}} \\leftrightarrow {0,1}^n$$ã€‚ Note æ ‡å¿—flagçš„å€¼åŸŸæ˜¯æ ‡é‡scalarï¼Œæ©ç maskçš„å€¼åŸŸæ˜¯å‘é‡vectorï¼Œä¸¤è€…éƒ½æ˜¯çŠ¶æ€é‡æˆ–è€…çŠ¶æ€æ˜ å°„ã€‚å¯ä»¥è®¤ä¸ºï¼Œmaskæ˜¯å»ºç«‹åœ¨${0,1}^n,n \\in \\N$ä¸Šçš„çº¿æ€§ç©ºé—´ï¼Œç»™å®šå®ƒçš„ä¸€ç»„åŸº${\\bold{u}_i \\in {0,1}^n \\big| 0 &lt; i \\le n;\\forall 0 &lt; i, j \\le n,\\bold{u}_i[j] = 1 \\iff i = j}$ï¼Œä¹Ÿå³åˆ†åˆ«æœ‰$\\bold{u}_i$å¯¹åº”äºmaskçš„ç¬¬$i$ä½ã€‚ä»¤æ ‡å¿—$\\mathrm{flag}_i$å¯¹åº”äº$\\mathrm{mask}$çš„ç¬¬$i$ä½çš„å€¼ï¼Œå³æœ‰$\\mathrm{flag}i = \\mathrm{mask}[i]$ä¸”æœ‰çº¿æ€§ç»„åˆ$$\\mathrm{mask} = \\sum{i=1}^n \\mathrm{flag}_i \\cdot \\bold{u}_i$$ã€‚æ€»è€Œè¨€ä¹‹ï¼Œmaskçš„æ¯ä¸€ä½åˆ†åˆ«å¯¹åº”ä¸€ä¸ªflagï¼Œmaskæ˜¯å¤šä¸ªå æ®ä¸åŒä½çš„flagçš„çº¿æ€§ç»„åˆï¼Œå› æ­¤maskæ˜¯ä¸€ä¸ªçŠ¶æ€å‘é‡æˆ–è€…ç»„åˆçŠ¶æ€æ˜ å°„ã€‚ å®ç°ï¼šæ ‡å¿—Flag123456789101112131415161718192021222324class Flag: def __init__(self): self._value = 0 @property def flag(self) -&gt; int: return self._value def set(self): 'set the flag to 1' self._value = 1 def clear(self): 'set the flag to 0' self._value = 0 def reverse(self): 'reverse/invert the flag, 0 to 1, 1 to 0' self._value ^= 1 def isset(self) -&gt; bool: 'Is flag = 1?' return self._value is 1 å®ç°ï¼šæ©ç MaskNote å› ä¸ºåœ¨Pythonä¸­ï¼Œintæ˜¯ä¸å¯å˜ç±»å‹ï¼Œæ“ä½œçš„ç»“æœå¾€å¾€ä¼šäº§ç”Ÿæ–°çš„intå¯¹è±¡ï¼Œè¿™æ˜¯ä½æ•ˆçš„ã€‚å»ºè®®ä½¿ç”¨Cæ‰©å±•æˆ–è€…æŸäº›å¯æ”¹åŠ¨å†…å­˜çš„ç»“æ„ï¼Œè‡³å°‘ä¿è¯ä½æ“ä½œå¯ä»¥å¤ç”¨åŸæ¥çš„å†…å­˜åŒºåŸŸã€‚ mask.py123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120from typing import TypeVar, Generic, UnionT = TypeVar('T')class MaskOpMixin(Generic[T]): def __eq__(self, o: Union[int, T]) -&gt; bool: if isinstance(o, type(self)): o = o._value return self._value == o def __invert__(self): return type(self)(~self._value) def __and__(self, o: Union[int, T]) -&gt; T: cls = type(self) if isinstance(o, cls): o = o._value return cls(self._value &amp; o) def __or__(self, o: Union[int, T]) -&gt; T: cls = type(self) if isinstance(o, cls): o = o._value return cls(self._value | o) def __xor__(self, o: Union[int, T]) -&gt; T: cls = type(self) if isinstance(o, cls): o = o._value return cls(self._value ^ o) __rand__ = __and__ __ror__ = __or__ __rxor__ = __xor__ def __iand__(self, o: Union[int, T]) -&gt; T: if isinstance(o, type(self)): o = o._value self._value &amp;= o return self def __ior__(self, o: Union[int, T]) -&gt; T: if isinstance(o, type(self)): o = o._value self._value |= o return self def __ixor__(self, o: Union[int, T]) -&gt; T: if isinstance(o, type(self)): o = o._value self._value ^= o return self def __sub__(self, o: Union[int, T]) -&gt; T: cls = type(self) if isinstance(o, cls): o = o._value # ğŸ¤” l &amp; ~r == (l | r) ^ r return cls(self._value &amp; ~o) def __isub__(self, o: Union[int, T]) -&gt; T: if isinstance(o, type(self)): o = o._value self._value &amp;= ~o return selfclass MaskBase: def __init__(self, mask: int = 0) -&gt; None: self._value = mask @property def mask(self) -&gt; int: return self._value @property def binmask(self) -&gt; str: return bin(self._value) def __repr__(self) -&gt; str: return f'{type(self).__name__}({bin(self._value)})' def set(self, m: int) -&gt; None: 'set mask by offset m' self._value |= 1 &lt;&lt; m def clear(self, m: int) -&gt; None: 'clear mask by offset m' self._value &amp;= ~(1 &lt;&lt; m) def reverse(self, m: Union[int, MaskBase]) -&gt; None: 'reverse/invert mask by offset m' self._value ^= 1 &lt;&lt; m def test(self, m: int) -&gt; bool: 'test mask by offset m' return bool(self._value &amp; 1 &lt;&lt; m)class Mask(MaskBase, MaskOpMixin[MaskBase]): def set(self, m: Union[int, MaskBase]) -&gt; None: 'set mask by mask m' self |= m def clear(self, m: Union[int, MaskBase]) -&gt; None: 'clear mask by mask m' self -= m def reverse(self, m: Union[int, MaskBase]) -&gt; None: 'reverse/invert mask by mask m' self ^= m def test(self, m: Union[int, MaskBase]) -&gt; bool: 'clear mask by mask m' return self &amp; m == m æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š 1234567891011121314151617&gt;&gt;&gt; from mask import *&gt;&gt;&gt; EVENT0 = 1 &lt;&lt; 0&gt;&gt;&gt; EVENT1 = 1 &lt;&lt; 1&gt;&gt;&gt; EVENT2 = 1 &lt;&lt; 2&gt;&gt;&gt; EVENT3 = 1 &lt;&lt; 3&gt;&gt;&gt; m = Mask(EVENT1)&gt;&gt;&gt; m.set(EVENT0 | EVENT3)&gt;&gt;&gt; mMask(0b1011)&gt;&gt;&gt; m.test(EVENT0 | EVENT1)True&gt;&gt;&gt; m.clear(EVENT0 | EVENT1)&gt;&gt;&gt; mMask(0b1000)&gt;&gt;&gt; m.reverse((1 &lt;&lt; 4) - 1)&gt;&gt;&gt; mMask(0b111)","link":"/2019/07/04/4.%E6%8E%A9%E7%A0%81%EF%BC%88Python%E5%AE%9E%E7%8E%B0%EF%BC%89/"}],"tags":[{"name":"åšå¼ˆè®º","slug":"åšå¼ˆè®º","link":"/tags/%E5%8D%9A%E5%BC%88%E8%AE%BA/"},{"name":"Python","slug":"Python","link":"/tags/Python/"},{"name":"Script","slug":"Script","link":"/tags/Script/"},{"name":"Module","slug":"Module","link":"/tags/Module/"},{"name":"Shell","slug":"Shell","link":"/tags/Shell/"}],"categories":[{"name":"æ•°å­¦","slug":"æ•°å­¦","link":"/categories/%E6%95%B0%E5%AD%A6/"},{"name":"è„šæœ¬å·¥å…·","slug":"è„šæœ¬å·¥å…·","link":"/categories/%E8%84%9A%E6%9C%AC%E5%B7%A5%E5%85%B7/"},{"name":"é€šç”¨æ¨¡å—","slug":"é€šç”¨æ¨¡å—","link":"/categories/%E9%80%9A%E7%94%A8%E6%A8%A1%E5%9D%97/"},{"name":"ç»æµå­¦","slug":"æ•°å­¦/ç»æµå­¦","link":"/categories/%E6%95%B0%E5%AD%A6/%E7%BB%8F%E6%B5%8E%E5%AD%A6/"},{"name":"ç®€å•è„šæœ¬","slug":"ç®€å•è„šæœ¬","link":"/categories/%E7%AE%80%E5%8D%95%E8%84%9A%E6%9C%AC/"},{"name":"ç¼–ç¨‹æ€æƒ³","slug":"ç¼–ç¨‹æ€æƒ³","link":"/categories/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/"}],"pages":[]}